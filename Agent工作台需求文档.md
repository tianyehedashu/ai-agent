# 🎛️ Agent 工作台需求文档

> Agent Studio - 对话式编排、可视化设计、提示词工程、调试测试、一键部署

---

## 一、产品定位

### 1.1 工作台概述

Agent 工作台是一个**低代码/无代码**平台，让用户能够：
- 通过**对话描述**快速生成 Agent
- 使用**可视化编排**设计复杂工作流
- 进行**提示词工程**优化 Agent 表现
- **试运行调试**验证 Agent 行为
- **一键部署**发布为 API 或应用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Agent 工作台产品架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         用户界面层                                   │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 对话创建  │ │ 可视化编排 │ │ 提示词编辑 │ │ 调试测试  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 部署管理  │ │ 模板市场  │ │ 版本管理  │ │ 监控分析  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         工作台服务层                                 │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐             │   │
│  │  │ 编排引擎      │ │ 测试运行器    │ │ 部署管理器    │             │   │
│  │  └───────────────┘ └───────────────┘ └───────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       Agent Core (核心引擎)                          │   │
│  │              Main Loop │ Context │ Memory │ Tools │ LLM             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 目标用户

| 用户类型 | 需求 | 主要使用功能 |
|---------|------|-------------|
| **业务人员** | 快速创建简单Agent，无需编程 | 对话创建、模板市场 |
| **产品经理** | 设计和验证Agent流程 | 可视化编排、试运行 |
| **Prompt工程师** | 优化Agent表现 | 提示词编辑、A/B测试 |
| **开发者** | 构建复杂Agent应用 | 全部功能 + 代码导出 |

### 1.3 竞品参考

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            竞品功能对比                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  功能              Dify    CrewAI   n8n    LangFlow  Coze   我们的目标     │
│  ─────────────────────────────────────────────────────────────────────────  │
│  对话式创建         ○       ✗        ✗       ✗        ○        ●           │
│  可视化编排         ●       ○        ●       ●        ●        ●           │
│  提示词工程         ●       ○        ○       ○        ●        ●           │
│  多Agent编排        ○       ●        ●       ●        ○        ●           │
│  试运行调试         ●       ○        ●       ●        ●        ●           │
│  版本管理           ●       ✗        ○       ✗        ○        ●           │
│  一键部署           ●       ○        ●       ○        ●        ●           │
│  代码导出           ○       ●        ○       ●        ✗        ●           │
│  模板市场           ●       ○        ●       ●        ●        ●           │
│  监控分析           ●       ○        ○       ○        ●        ●           │
│                                                                             │
│  ● 完整支持  ○ 部分支持  ✗ 不支持                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、核心功能模块

### 2.1 对话式 Agent 创建

**目标**: 用户通过自然语言描述需求，系统自动生成 Agent 配置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        对话式创建流程                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户: "我需要一个客服Agent，能回答产品问题，                               │
│        查询订单状态，必要时转人工"                                          │
│                                                                             │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      意图理解 & 需求分析                             │   │
│  │  • 识别Agent类型: 客服                                              │   │
│  │  • 核心能力: 问答、订单查询、转人工                                  │   │
│  │  • 所需工具: 知识库检索、订单API、工单系统                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      追问澄清 (如需要)                               │   │
│  │  系统: "请问：                                                       │   │
│  │        1. 产品知识库是否已准备好？                                   │   │
│  │        2. 订单系统是否有API可以调用？                                │   │
│  │        3. 转人工的条件是什么？"                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      自动生成 Agent 配置                             │   │
│  │  • System Prompt                                                    │   │
│  │  • 工具配置                                                         │   │
│  │  • 工作流定义                                                       │   │
│  │  • 知识库关联                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      预览 & 确认                                     │   │
│  │  展示生成的Agent配置，用户可以：                                     │   │
│  │  • 直接使用                                                         │   │
│  │  • 进入编辑器修改                                                   │   │
│  │  • 继续对话调整                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 功能清单

| 功能 | 描述 | 优先级 |
|------|------|-------|
| 需求理解 | 分析用户自然语言描述，提取Agent需求 | P0 |
| 智能追问 | 信息不足时主动追问，澄清需求 | P0 |
| 模板匹配 | 根据需求推荐合适的Agent模板 | P1 |
| 配置生成 | 自动生成System Prompt、工具配置等 | P0 |
| 迭代优化 | 根据用户反馈持续调整配置 | P1 |

### 2.2 可视化工作流编排

**目标**: Code-First 架构 - 代码为底层，可视化为渲染层，支持双向编辑

**核心理念**: 底层是 Python 代码 (LangGraph DSL)，React Flow 只是代码的可视化渲染

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Code-First 可视化编排界面                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  [📄 代码] [🎨 可视化] [⚙️ 配置]                    [▶️ 运行] [🐛 调试] │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌────────────────────────────┬──────────────────────────────────────────┐ │
│  │     代码编辑器             │           可视化画布                      │ │
│  │    (Monaco Editor)         │          (React Flow)                     │ │
│  │  ─────────────────────     │                                          │ │
│  │                            │                                          │ │
│  │  from langgraph.graph      │    ┌─────────┐                           │ │
│  │      import StateGraph     │    │  START  │                           │ │
│  │                            │    └────┬────┘                           │ │
│  │  graph = StateGraph(State) │         │                                │ │
│  │                            │         ▼                                │ │
│  │  # 添加节点                │    ┌─────────┐     ┌─────────┐          │ │
│  │  graph.add_node(           │    │  意图   │────▶│ 条件    │          │ │
│  │      "intent",             │    │  识别   │     │ 路由    │          │ │
│  │      intent_classifier     │    └─────────┘     └────┬────┘          │ │
│  │  )                         │               ┌─────────┼─────────┐     │ │
│  │  graph.add_node(           │               ▼         ▼         ▼     │ │
│  │      "query",              │          ┌────────┐ ┌────────┐ ┌────┐  │ │
│  │      query_order           │          │  问答  │ │ 查询   │ │转人│  │ │
│  │  )                         │          │  处理  │ │ 订单   │ │ 工 │  │ │
│  │                            │          └───┬────┘ └───┬────┘ └──┬─┘  │ │
│  │  # 添加边                  │              └──────────┴─────────┘     │ │
│  │  graph.add_conditional_    │                        │                │ │
│  │      edges(                │                        ▼                │ │
│  │      "intent",             │                   ┌─────────┐          │ │
│  │      route_by_intent       │                   │   END   │          │ │
│  │  )                         │                   └─────────┘          │ │
│  │                            │                                          │ │
│  │  ◀─────────────────────────┼────────────────────────────────────────▶ │ │
│  │         实时双向同步                                                  │ │
│  │  • 代码改 → UI 自动更新                                               │ │
│  │  • UI 拖拽 → 代码自动生成                                             │ │
│  │                            │                                          │ │
│  └────────────────────────────┴──────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         属性配置面板 / 执行日志                        │ │
│  │  选中: intent_classifier                                              │ │
│  │  ├─ 函数位置: agent_flow.py:15                                       │ │
│  │  ├─ 类型: LLM 调用                                                   │ │
│  │  └─ [跳转到定义] [查看执行历史]                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Code-First 的优势**:

| 对比项 | Code-First | Visual-First (传统) |
|--------|------------|---------------------|
| 定制化 | ✅ 代码无限制 | ⚠️ 受限于节点类型 |
| 版本控制 | ✅ Git diff 清晰 | ⚠️ JSON 可读性差 |
| 复用性 | ✅ 函数/模块/包 | ❌ 复制粘贴 |
| 调试 | ✅ 标准调试器 | ⚠️ 依赖平台 |
| 复杂逻辑 | ✅ 任意复杂度 | ❌ 节点能力受限 |
| 与 LangGraph 兼容 | ✅ 原生执行 | ❌ 需要转换 |

#### 节点类型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            节点类型定义                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入节点                                                                   │
│  ├─ 用户输入     接收用户消息                                              │
│  ├─ Webhook      接收HTTP请求触发                                          │
│  ├─ 定时触发     按计划执行                                                │
│  └─ 事件触发     监听系统事件                                              │
│                                                                             │
│  Agent节点                                                                  │
│  ├─ LLM调用      调用语言模型生成响应                                      │
│  ├─ 意图识别     识别用户意图并路由                                        │
│  ├─ 知识检索     从知识库检索相关信息 (RAG)                                │
│  ├─ 记忆读取     读取用户历史记忆                                          │
│  └─ Agent调用    调用其他Agent (A2A)                                       │
│                                                                             │
│  工具节点                                                                   │
│  ├─ HTTP请求     调用外部API                                               │
│  ├─ 数据库查询   执行SQL查询                                               │
│  ├─ 代码执行     运行Python/JS代码                                         │
│  ├─ 文件操作     读写文件                                                  │
│  └─ MCP工具      调用MCP协议工具                                           │
│                                                                             │
│  逻辑节点                                                                   │
│  ├─ 条件分支     根据条件走不同路径                                        │
│  ├─ 循环         循环执行                                                  │
│  ├─ 并行         并行执行多个分支                                          │
│  ├─ 等待         等待条件/时间/人工确认                                    │
│  └─ 变量设置     设置/修改变量                                             │
│                                                                             │
│  输出节点                                                                   │
│  ├─ 回复用户     返回消息给用户                                            │
│  ├─ 发送通知     发送邮件/消息通知                                         │
│  ├─ 调用API      调用外部系统                                              │
│  └─ 存储数据     保存到数据库/文件                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 功能清单

| 功能 | 描述 | 优先级 |
|------|------|-------|
| **代码编辑器** | Monaco Editor，支持 Python 语法高亮、智能提示 | P0 |
| **代码 → 可视化** | 解析 Python 代码，自动渲染图结构 | P0 |
| **可视化 → 代码** | UI 操作自动生成/修改 Python 代码 | P0 |
| **双向实时同步** | 代码与画布实时双向同步 | P0 |
| 拖拽节点 | 从面板拖拽节点到画布，自动生成代码 | P0 |
| 连线 | 连接节点，自动生成 add_edge 代码 | P0 |
| 节点配置 | 配置节点参数，同步到代码 | P0 |
| **跳转到定义** | 从可视化节点跳转到代码定义位置 | P1 |
| **代码片段** | 常用模式代码片段快速插入 | P1 |
| 撤销/重做 | 代码级别的操作历史管理 | P0 |
| 自动布局 | 自动整理可视化节点位置 | P2 |
| 小地图 | 大流程导航 | P2 |
| **导入导出** | 导入 JSON 配置自动转换为 Python 代码 | P2 |

### 2.3 提示词工程

**目标**: 专业的提示词编辑、测试、优化工具

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          提示词工作台                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       System Prompt 编辑器                           │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │ # 角色定义                                                     │  │   │
│  │  │ 你是一个专业的客服助手，名叫小智...                            │  │   │
│  │  │                                                                │  │   │
│  │  │ # 能力范围                                                     │  │   │
│  │  │ - 回答产品相关问题                                             │  │   │
│  │  │ - 查询订单状态                                                 │  │   │
│  │  │ - {{custom_capability}}                                        │  │   │
│  │  │                                                                │  │   │
│  │  │ # 行为准则                                                     │  │   │
│  │  │ 1. 始终保持友好和专业                                          │  │   │
│  │  │ 2. 不确定时主动询问                                            │  │   │
│  │  │ ...                                                            │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐     │   │
│  │  │ 📝 变量管理     │  │ 📚 模板片段     │  │ 🔍 Token计数    │     │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────┐ ┌─────────────────────────────────┐  │
│  │        版本对比                  │ │        测试用例                 │  │
│  │  ┌─────────┐  ┌─────────┐       │ │  ┌─────────────────────────┐   │  │
│  │  │ v1.0    │  │ v1.1    │       │ │  │ Case 1: 产品咨询        │   │  │
│  │  │ ─────── │  │ ─────── │       │ │  │ Input: "这个产品多少钱"  │   │  │
│  │  │ - 旧文本 │  │ + 新文本 │       │ │  │ Expected: 包含价格信息   │   │  │
│  │  └─────────┘  └─────────┘       │ │  └─────────────────────────┘   │  │
│  │                                 │ │  ┌─────────────────────────┐   │  │
│  │  [查看差异] [回滚到此版本]      │ │  │ Case 2: 订单查询        │   │  │
│  └─────────────────────────────────┘ │  │ ...                      │   │  │
│                                      │  └─────────────────────────┘   │  │
│                                      │  [添加用例] [批量运行]        │  │
│                                      └─────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         A/B 测试                                     │   │
│  │  ┌───────────────────────┐  ┌───────────────────────┐              │   │
│  │  │ 版本 A (50%)          │  │ 版本 B (50%)          │              │   │
│  │  │ 满意度: 87%           │  │ 满意度: 91%           │              │   │
│  │  │ 解决率: 78%           │  │ 解决率: 82%           │              │   │
│  │  │ 平均响应: 2.3s        │  │ 平均响应: 2.1s        │              │   │
│  │  └───────────────────────┘  └───────────────────────┘              │   │
│  │  [全量发布版本B] [继续测试] [停止测试]                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 功能清单

| 功能 | 描述 | 优先级 |
|------|------|-------|
| 语法高亮 | Prompt语法高亮显示 | P0 |
| 变量插值 | 支持 {{variable}} 变量 | P0 |
| 模板片段 | 可复用的Prompt片段 | P1 |
| Token计数 | 实时计算Token数量 | P0 |
| 版本管理 | Prompt版本历史 | P0 |
| 版本对比 | Diff对比不同版本 | P1 |
| 回滚 | 回滚到历史版本 | P1 |
| 测试用例 | 定义测试输入输出 | P0 |
| 批量测试 | 批量运行测试用例 | P1 |
| A/B测试 | 多版本对比测试 | P2 |
| 自动优化 | AI辅助优化Prompt | P2 |

### 2.4 调试与测试

**目标**: 完整的调试工具，可视化执行过程，快速定位问题

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           调试界面                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────────────────────┐  │
│  │      输入面板           │  │              执行追踪                    │  │
│  │  ┌───────────────────┐ │  │  ┌─────────────────────────────────────┐ │  │
│  │  │ 用户消息:          │ │  │  │ 🕐 10:23:45.123                    │ │  │
│  │  │ ┌───────────────┐ │ │  │  │                                    │ │  │
│  │  │ │ 我想查一下订单 │ │ │  │  │ ▶ 开始执行                        │ │  │
│  │  │ │ 状态          │ │ │  │  │   │                                │ │  │
│  │  │ └───────────────┘ │ │  │  │   ├─▶ 上下文组装 (23ms)            │ │  │
│  │  │                   │ │  │  │   │   ├─ System: 1,234 tokens      │ │  │
│  │  │ 上下文变量:        │ │  │  │   │   ├─ History: 2,456 tokens    │ │  │
│  │  │ ├─ user_id: u123  │ │  │  │   │   └─ Memory: 892 tokens       │ │  │
│  │  │ └─ session: s456  │ │  │  │   │                                │ │  │
│  │  └───────────────────┘ │  │  │   ├─▶ LLM调用 (1,234ms)            │ │  │
│  │                        │  │  │   │   ├─ Model: claude-3.5         │ │  │
│  │  [▶ 运行] [⏸ 单步]    │  │  │   │   ├─ Input: 4,582 tokens       │ │  │
│  └─────────────────────────┘  │  │   │   └─ Output: 156 tokens        │ │  │
│                               │  │   │                                │ │  │
│  ┌─────────────────────────┐  │  │   ├─▶ 工具调用: query_order       │ │  │
│  │       输出面板          │  │  │   │   ├─ Args: {order_id: "xxx"}  │ │  │
│  │  ┌───────────────────┐ │  │  │   │   ├─ Duration: 234ms          │ │  │
│  │  │ Agent响应:         │ │  │  │   │   └─ Result: {status: "已发货"} │ │  │
│  │  │                   │ │  │  │   │                                │ │  │
│  │  │ 您好！已为您查询到 │ │  │  │   ├─▶ LLM调用 (892ms)             │ │  │
│  │  │ 订单XXX的状态：   │ │  │  │   │   └─ 生成最终响应              │ │  │
│  │  │ 已发货，预计明天送 │ │  │  │   │                                │ │  │
│  │  │ 达。              │ │  │  │   └─▶ 完成 ✓                       │ │  │
│  │  │                   │ │  │  │                                    │ │  │
│  │  │ [工具调用详情 ▼]  │ │  │  │  总耗时: 2,383ms                   │ │  │
│  │  └───────────────────┘ │  │  │  Token消耗: 4,738                  │ │  │
│  │                        │  │  │  预估成本: $0.0142                  │ │  │
│  │  Token: 4,738          │  │  └─────────────────────────────────────┘ │  │
│  │  耗时: 2.38s           │  │                                          │  │
│  │  成本: $0.014          │  │  [展开全部] [导出日志] [重放]           │  │
│  └─────────────────────────┘  └─────────────────────────────────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         上下文查看器                                 │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │System Prompt│ │  对话历史   │ │  召回记忆   │ │  工具结果   │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │ [完整的上下文内容展示...]                                      │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 功能清单

| 功能 | 描述 | 优先级 |
|------|------|-------|
| 即时运行 | 输入测试数据立即运行 | P0 |
| 执行追踪 | 可视化执行每一步 | P0 |
| **运行时状态面板** | 实时显示当前状态、变量值、上下文变化 | P0 |
| **节点执行高亮** | 当前执行节点蓝色脉冲，完成节点绿色标记 | P0 |
| **LLM流式输出** | 实时展示 LLM 思考过程 (streaming) | P0 |
| **工具调用追踪** | 显示工具调用参数和返回结果 | P0 |
| 单步执行 | 逐步执行，查看中间状态 | P1 |
| 断点 | 在指定节点暂停 | P1 |
| **Time Travel** | 点击时间线查看历史状态快照 | P1 |
| 上下文查看 | 查看完整上下文内容 | P0 |
| Token统计 | 统计各部分Token消耗 | P0 |
| **执行耗时统计** | 各节点、工具的执行时间统计 | P0 |
| 成本估算 | 计算预估成本 | P1 |
| 日志导出 | 导出执行日志 (JSON格式) | P1 |
| 重放 | 重放历史执行 | P2 |
| 对比运行 | 对比不同配置的结果 | P2 |
| **变量监视** | 监视指定变量的值变化 | P2 |

#### 运行时状态可视化架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       运行时状态可视化面板                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────┐  ┌────────────────────┐  ┌──────────────────────┐      │
│  │  执行流程       │  │   当前状态          │  │   执行日志           │      │
│  │  (节点高亮)     │  │   (实时更新)        │  │   (WebSocket流)      │      │
│  ├────────────────┤  ├────────────────────┤  ├──────────────────────┤      │
│  │                │  │                    │  │                      │      │
│  │ [入口] ✓       │  │ messages: 3        │  │ ▶ 进入节点: think    │      │
│  │   ↓            │  │ ─────────────      │  │ ⚡ 调用: search      │      │
│  │ [思考] 🔵      │  │ user: "帮我..."    │  │ 💬 LLM: 根据搜索...  │      │
│  │   ↓            │  │ assistant: ...     │  │ ✓ 完成: think 2.3s  │      │
│  │ [执行] ○       │  │                    │  │ ▶ 进入节点: act      │      │
│  │   ↓            │  │ context:           │  │                      │      │
│  │ [输出] ○       │  │ { plan: [...] }    │  │ [实时滚动...]        │      │
│  │                │  │                    │  │                      │      │
│  │ 当前: 思考     │  │ iteration: 2       │  │                      │      │
│  │ 耗时: 2.3s     │  │                    │  │                      │      │
│  └────────────────┘  └────────────────────┘  └──────────────────────┘      │
│                                                                             │
│  技术实现: ExecutionTracer → WebSocket → 前端面板实时更新                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 部署管理

**目标**: 一键发布Agent为可用服务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           部署管理                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         发布配置                                     │   │
│  │                                                                      │   │
│  │  Agent名称: 智能客服助手                                             │   │
│  │  版本: v1.2.0                                                        │   │
│  │  描述: 支持产品咨询、订单查询、投诉处理的客服Agent                   │   │
│  │                                                                      │   │
│  │  发布类型:                                                           │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ ○ API服务   │ │ ○ Web应用  │ │ ○ 嵌入组件  │ │ ○ 导出代码  │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  │                                                                      │   │
│  │  环境:                                                               │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                    │   │
│  │  │ ● 开发环境  │ │ ○ 测试环境  │ │ ○ 生产环境  │                    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                    │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         API 配置                                     │   │
│  │                                                                      │   │
│  │  端点: https://api.yourdomain.com/v1/agents/customer-service        │   │
│  │                                                                      │   │
│  │  认证方式: ● API Key  ○ OAuth 2.0  ○ JWT                            │   │
│  │                                                                      │   │
│  │  API Key: sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  [复制] [重新生成]    │   │
│  │                                                                      │   │
│  │  限流配置:                                                           │   │
│  │  ├─ 每分钟请求数: 60                                                │   │
│  │  ├─ 每日请求数: 10000                                               │   │
│  │  └─ 并发数: 10                                                      │   │
│  │                                                                      │   │
│  │  CORS: ● 允许所有  ○ 指定域名: ____________________                 │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       API 文档 & SDK                                 │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  curl -X POST \                                              │    │   │
│  │  │    https://api.xxx.com/v1/agents/customer-service/chat \    │    │   │
│  │  │    -H "Authorization: Bearer sk-xxx" \                       │    │   │
│  │  │    -H "Content-Type: application/json" \                     │    │   │
│  │  │    -d '{"message": "我想查订单", "session_id": "xxx"}'       │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  [Python SDK] [JavaScript SDK] [完整API文档]                        │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         发布历史                                     │   │
│  │  ┌────────┬──────────┬────────────┬─────────┬─────────────────┐     │   │
│  │  │ 版本   │ 环境     │ 发布时间   │ 状态    │ 操作            │     │   │
│  │  ├────────┼──────────┼────────────┼─────────┼─────────────────┤     │   │
│  │  │ v1.2.0 │ 开发     │ 2024-01-12 │ ● 运行中│ [查看] [回滚]   │     │   │
│  │  │ v1.1.0 │ 生产     │ 2024-01-10 │ ● 运行中│ [查看] [停止]   │     │   │
│  │  │ v1.0.0 │ -        │ 2024-01-05 │ ○ 已停止│ [查看] [重新发布]│     │   │
│  │  └────────┴──────────┴────────────┴─────────┴─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│                            [发布到开发环境]                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 发布类型

| 类型 | 描述 | 输出 |
|------|------|------|
| **API服务** | 发布为RESTful API | API端点 + 认证密钥 |
| **Web应用** | 发布为独立聊天页面 | 可访问的URL |
| **嵌入组件** | 生成可嵌入的组件 | JS SDK + iframe代码 |
| **导出代码** | 导出为可部署的代码 | Python/Node.js项目 |

### 2.6 模板市场

**目标**: 提供可复用的Agent模板，加速开发

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           模板市场                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  🔍 搜索模板...                           [热门] [最新] [官方] [社区]       │
│                                                                             │
│  分类: [全部] [客服] [营销] [数据分析] [开发助手] [内容创作] [教育]         │
│                                                                             │
│  ┌───────────────────────┐ ┌───────────────────────┐ ┌───────────────────┐ │
│  │ 🤖 智能客服助手       │ │ 📊 数据分析师        │ │ ✍️ 内容创作助手   │ │
│  │ ─────────────────    │ │ ─────────────────    │ │ ─────────────────  │ │
│  │ 多轮对话客服，支持    │ │ 分析数据、生成报表   │ │ 文案、营销内容    │ │
│  │ 知识库、订单查询     │ │ 洞察趋势            │ │ 创意生成          │ │
│  │                      │ │                      │ │                   │ │
│  │ ⭐ 4.8  📥 1.2k     │ │ ⭐ 4.6  📥 856      │ │ ⭐ 4.7  📥 923    │ │
│  │ 🏷️ 官方             │ │ 🏷️ 官方             │ │ 🏷️ 社区           │ │
│  │                      │ │                      │ │                   │ │
│  │ [预览] [使用此模板]  │ │ [预览] [使用此模板]  │ │ [预览] [使用模板] │ │
│  └───────────────────────┘ └───────────────────────┘ └───────────────────┘ │
│                                                                             │
│  ┌───────────────────────┐ ┌───────────────────────┐ ┌───────────────────┐ │
│  │ 💻 代码审查助手       │ │ 📧 邮件处理助手      │ │ 📚 知识库问答     │ │
│  │ ─────────────────    │ │ ─────────────────    │ │ ─────────────────  │ │
│  │ 代码审查、Bug分析    │ │ 邮件分类、自动回复   │ │ 基于文档的智能    │ │
│  │ 优化建议            │ │ 摘要提取            │ │ 问答系统          │ │
│  │                      │ │                      │ │                   │ │
│  │ ⭐ 4.9  📥 2.1k     │ │ ⭐ 4.5  📥 678      │ │ ⭐ 4.8  📥 1.5k   │ │
│  └───────────────────────┘ └───────────────────────┘ └───────────────────┘ │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  我的模板                                                [发布到市场]       │
│                                                                             │
│  ┌───────────────────────┐ ┌───────────────────────┐                       │
│  │ 📋 我的客服Agent      │ │ 📋 内部工单处理      │                       │
│  │ 最后修改: 2天前       │ │ 最后修改: 1周前       │                       │
│  │ [编辑] [复制] [删除]  │ │ [编辑] [复制] [删除]  │                       │
│  └───────────────────────┘ └───────────────────────┘                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、与 Agent Core 集成

### 3.1 集成架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         工作台与Agent Core集成架构                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Agent 工作台 (前端)                           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 对话创建  │ │ 可视化编排 │ │ 提示词编辑 │ │ 调试测试  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ REST API / WebSocket                  │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      工作台服务层 (新增)                             │   │
│  │                                                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐  │   │
│  │  │                    Studio Service                              │  │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │  │   │
│  │  │  │ 编排引擎    │ │ 测试运行器  │ │ 部署管理器  │             │  │   │
│  │  │  │ Orchestrator│ │ TestRunner  │ │ Deployer    │             │  │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘             │  │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐             │  │   │
│  │  │  │ 模板管理    │ │ 版本管理    │ │ 对话创建器  │             │  │   │
│  │  │  │ Template    │ │ Version     │ │ Creator     │             │  │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘             │  │   │
│  │  └───────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ 内部调用                               │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       Agent Core (已有)                              │   │
│  │                                                                      │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │ AgentEngine │ │ ContextMgr  │ │ ToolSystem  │ │ MemorySystem│   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  │  ┌─────────────┐ ┌─────────────┐                                   │   │
│  │  │ LLMGateway  │ │ Reasoning   │                                   │   │
│  │  └─────────────┘ └─────────────┘                                   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 配置转换

工作台编排的配置如何转换为 Agent Core 可执行的配置：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           配置转换流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  工作台配置 (可视化)                      Agent Core 配置 (执行)            │
│                                                                             │
│  ┌─────────────────────┐                 ┌─────────────────────┐           │
│  │ Workflow JSON       │                 │ AgentConfig         │           │
│  │ {                   │                 │ {                   │           │
│  │   "nodes": [        │    ────────▶    │   "agent_id": "xxx",│           │
│  │     {               │    转换引擎     │   "system_prompt":  │           │
│  │       "type": "llm",│                 │     "...",          │           │
│  │       "config": {}  │                 │   "model": "...",   │           │
│  │     },              │                 │   "tools": [...],   │           │
│  │     ...             │                 │   "workflow": {     │           │
│  │   ],                │                 │     "type": "...",  │           │
│  │   "edges": [...]    │                 │     "steps": [...]  │           │
│  │ }                   │                 │   }                 │           │
│  └─────────────────────┘                 │ }                   │           │
│                                          └─────────────────────┘           │
│                                                                             │
│  转换规则:                                                                  │
│  ├─ LLM节点 → system_prompt + model配置                                    │
│  ├─ 工具节点 → tools数组                                                   │
│  ├─ 条件分支 → workflow.steps中的condition                                 │
│  ├─ 循环节点 → workflow.steps中的loop                                      │
│  └─ 子流程 → 内联展开或A2A调用                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 新增目录结构

```
backend/
├── core/                          # 已有
│   ├── agent/
│   ├── memory/
│   ├── tool/
│   └── llm/
│
├── studio/                        # 新增: 工作台模块
│   ├── __init__.py
│   ├── orchestrator/              # 编排引擎
│   │   ├── __init__.py
│   │   ├── engine.py              # 编排执行引擎
│   │   ├── converter.py           # 配置转换器
│   │   ├── validator.py           # 流程验证器
│   │   └── nodes/                 # 节点定义
│   │       ├── base.py
│   │       ├── llm.py
│   │       ├── tool.py
│   │       ├── logic.py
│   │       └── io.py
│   │
│   ├── creator/                   # 对话创建器
│   │   ├── __init__.py
│   │   ├── intent_parser.py       # 意图解析
│   │   ├── config_generator.py    # 配置生成
│   │   └── prompts/               # 创建器提示词
│   │       └── creator_prompt.py
│   │
│   ├── test_runner/               # 测试运行器
│   │   ├── __init__.py
│   │   ├── runner.py              # 测试执行
│   │   ├── tracer.py              # 执行追踪
│   │   └── reporter.py            # 报告生成
│   │
│   ├── deployer/                  # 部署管理器
│   │   ├── __init__.py
│   │   ├── publisher.py           # 发布器
│   │   ├── api_generator.py       # API生成
│   │   └── code_exporter.py       # 代码导出
│   │
│   ├── template/                  # 模板管理
│   │   ├── __init__.py
│   │   ├── manager.py             # 模板管理
│   │   └── marketplace.py         # 市场接口
│   │
│   └── version/                   # 版本管理
│       ├── __init__.py
│       └── manager.py             # 版本控制
│
├── api/
│   └── v1/
│       ├── ...                    # 已有
│       └── studio.py              # 新增: 工作台API
│
└── models/
    ├── ...                        # 已有
    ├── workflow.py                # 新增: 工作流模型
    └── template.py                # 新增: 模板模型
```

### 3.4 数据模型扩展

```python
# backend/models/workflow.py

class Workflow(Base):
    """工作流定义"""
    __tablename__ = "workflows"
    
    id = Column(UUID, primary_key=True)
    agent_id = Column(UUID, ForeignKey("agents.id"))
    name = Column(String(100))
    description = Column(Text)
    
    # 工作流定义 (节点 + 边)
    definition = Column(JSONB)  # {"nodes": [], "edges": []}
    
    # 转换后的执行配置
    compiled_config = Column(JSONB)
    
    # 版本
    version = Column(Integer, default=1)
    is_draft = Column(Boolean, default=True)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)
    published_at = Column(DateTime)

class WorkflowVersion(Base):
    """工作流版本历史"""
    __tablename__ = "workflow_versions"
    
    id = Column(UUID, primary_key=True)
    workflow_id = Column(UUID, ForeignKey("workflows.id"))
    version = Column(Integer)
    definition = Column(JSONB)
    compiled_config = Column(JSONB)
    change_log = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    created_by = Column(UUID, ForeignKey("users.id"))

class Template(Base):
    """Agent模板"""
    __tablename__ = "templates"
    
    id = Column(UUID, primary_key=True)
    name = Column(String(100))
    description = Column(Text)
    category = Column(String(50))
    
    # 模板内容
    agent_config = Column(JSONB)
    workflow_definition = Column(JSONB)
    
    # 元信息
    author_id = Column(UUID, ForeignKey("users.id"))
    is_official = Column(Boolean, default=False)
    is_public = Column(Boolean, default=True)
    
    # 统计
    use_count = Column(Integer, default=0)
    rating = Column(Float, default=0)
    
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, onupdate=datetime.utcnow)

class Deployment(Base):
    """部署记录"""
    __tablename__ = "deployments"
    
    id = Column(UUID, primary_key=True)
    agent_id = Column(UUID, ForeignKey("agents.id"))
    workflow_version_id = Column(UUID, ForeignKey("workflow_versions.id"))
    
    # 部署配置
    deploy_type = Column(String(20))  # api, web, embed, code
    environment = Column(String(20))  # dev, staging, prod
    
    # API配置
    endpoint = Column(String(500))
    api_key = Column(String(100))
    rate_limit = Column(JSONB)
    
    # 状态
    status = Column(String(20))  # pending, running, stopped
    
    created_at = Column(DateTime, default=datetime.utcnow)
    stopped_at = Column(DateTime)
```

---

## 四、API 设计

### 4.1 工作台 API

```
/api/v1/studio
│
├── /creator                       # 对话式创建
│   └── POST /chat                 # 对话创建Agent
│
├── /workflows                     # 工作流管理
│   ├── GET    /                   # 列表
│   ├── POST   /                   # 创建
│   ├── GET    /{id}               # 详情
│   ├── PUT    /{id}               # 更新
│   ├── DELETE /{id}               # 删除
│   ├── POST   /{id}/compile       # 编译为执行配置
│   └── POST   /{id}/validate      # 验证工作流
│
├── /test                          # 测试运行
│   ├── POST   /run                # 运行测试
│   ├── POST   /run-step           # 单步运行
│   ├── GET    /traces/{id}        # 获取执行追踪
│   └── POST   /compare            # 对比运行
│
├── /prompts                       # 提示词管理
│   ├── GET    /{agent_id}/versions  # 版本列表
│   ├── POST   /{agent_id}/versions  # 创建版本
│   ├── GET    /diff               # 版本对比
│   └── POST   /rollback           # 回滚版本
│
├── /deploy                        # 部署管理
│   ├── POST   /                   # 创建部署
│   ├── GET    /{id}               # 部署详情
│   ├── PUT    /{id}/stop          # 停止部署
│   ├── PUT    /{id}/restart       # 重启部署
│   └── DELETE /{id}               # 删除部署
│
└── /templates                     # 模板市场
    ├── GET    /                   # 搜索模板
    ├── GET    /{id}               # 模板详情
    ├── POST   /{id}/use           # 使用模板
    ├── POST   /                   # 发布模板
    └── GET    /my                 # 我的模板
```

### 4.2 核心 API 示例

```python
# backend/api/v1/studio.py

from fastapi import APIRouter, Depends
from sse_starlette.sse import EventSourceResponse

router = APIRouter(prefix="/studio", tags=["studio"])

# ================== 对话式创建 ==================

class CreatorChatRequest(BaseModel):
    """创建器对话请求"""
    message: str
    session_id: Optional[str] = None
    context: Optional[dict] = None

@router.post("/creator/chat")
async def creator_chat(
    request: CreatorChatRequest,
    current_user: User = Depends(get_current_user),
    creator_service: CreatorService = Depends(),
):
    """
    对话式创建Agent
    
    流式返回:
    - thinking: 正在分析
    - question: 追问问题
    - preview: 配置预览
    - done: 创建完成
    """
    async def event_generator():
        async for event in creator_service.chat(
            message=request.message,
            session_id=request.session_id,
            user_id=current_user.id,
        ):
            yield {"event": event.type, "data": event.data}
    
    return EventSourceResponse(event_generator())

# ================== 工作流管理 ==================

class WorkflowCreate(BaseModel):
    """创建工作流"""
    name: str
    description: Optional[str] = None
    agent_id: str
    definition: dict  # {"nodes": [], "edges": []}

@router.post("/workflows")
async def create_workflow(
    data: WorkflowCreate,
    current_user: User = Depends(get_current_user),
    workflow_service: WorkflowService = Depends(),
):
    """创建工作流"""
    return await workflow_service.create(
        user_id=current_user.id,
        **data.model_dump()
    )

@router.post("/workflows/{workflow_id}/compile")
async def compile_workflow(
    workflow_id: str,
    current_user: User = Depends(get_current_user),
    orchestrator: Orchestrator = Depends(),
):
    """编译工作流为可执行配置"""
    return await orchestrator.compile(workflow_id)

# ================== 测试运行 ==================

class TestRunRequest(BaseModel):
    """测试运行请求"""
    workflow_id: str
    input: dict
    variables: Optional[dict] = None

@router.post("/test/run")
async def run_test(
    request: TestRunRequest,
    current_user: User = Depends(get_current_user),
    test_runner: TestRunner = Depends(),
):
    """运行测试，流式返回执行追踪"""
    async def event_generator():
        async for trace in test_runner.run(
            workflow_id=request.workflow_id,
            input=request.input,
            variables=request.variables,
        ):
            yield {"event": "trace", "data": trace.model_dump()}
    
    return EventSourceResponse(event_generator())

# ================== 部署管理 ==================

class DeployRequest(BaseModel):
    """部署请求"""
    agent_id: str
    workflow_version_id: Optional[str] = None
    deploy_type: str  # api, web, embed, code
    environment: str  # dev, staging, prod
    config: Optional[dict] = None

@router.post("/deploy")
async def create_deployment(
    request: DeployRequest,
    current_user: User = Depends(get_current_user),
    deployer: Deployer = Depends(),
):
    """创建部署"""
    return await deployer.deploy(
        user_id=current_user.id,
        **request.model_dump()
    )
```

---

## 五、技术实现要点

### 5.1 可视化编排引擎

```python
# backend/studio/orchestrator/engine.py

class OrchestratorEngine:
    """编排执行引擎"""
    
    async def execute(
        self,
        workflow: Workflow,
        input: dict,
        context: ExecutionContext,
    ) -> AsyncGenerator[TraceEvent, None]:
        """
        执行工作流
        
        支持:
        - 顺序执行
        - 条件分支
        - 并行执行
        - 循环
        - 子流程
        """
        # 获取起始节点
        start_node = self._get_start_node(workflow.definition)
        
        # 执行队列
        queue = [start_node]
        visited = set()
        
        while queue:
            node = queue.pop(0)
            
            if node.id in visited:
                continue
            visited.add(node.id)
            
            # 发送追踪事件
            yield TraceEvent(
                type="node_start",
                node_id=node.id,
                node_type=node.type,
            )
            
            try:
                # 执行节点
                result = await self._execute_node(node, context)
                
                yield TraceEvent(
                    type="node_complete",
                    node_id=node.id,
                    result=result,
                )
                
                # 获取下一个节点
                next_nodes = self._get_next_nodes(
                    workflow.definition,
                    node,
                    result,
                )
                queue.extend(next_nodes)
                
            except Exception as e:
                yield TraceEvent(
                    type="node_error",
                    node_id=node.id,
                    error=str(e),
                )
                raise
    
    async def _execute_node(
        self,
        node: Node,
        context: ExecutionContext,
    ) -> Any:
        """执行单个节点"""
        executor = self._get_executor(node.type)
        return await executor.execute(node, context)
```

### 5.2 对话式创建器

```python
# backend/studio/creator/config_generator.py

class AgentCreator:
    """对话式Agent创建器"""
    
    CREATOR_PROMPT = """你是一个Agent配置助手，帮助用户通过对话创建AI Agent。

用户需求: {user_input}
当前上下文: {context}

你的任务:
1. 理解用户想要创建什么类型的Agent
2. 如果信息不足，提出明确的问题
3. 信息充足时，生成完整的Agent配置

输出格式:
{{
  "action": "ask" | "preview" | "create",
  "questions": ["问题1", "问题2"],  // action=ask时
  "preview": {{...}},  // action=preview时的配置预览
  "config": {{...}}    // action=create时的完整配置
}}

Agent配置结构:
{{
  "name": "Agent名称",
  "description": "描述",
  "system_prompt": "系统提示词",
  "model": "模型名称",
  "tools": ["工具列表"],
  "workflow": {{...}}  // 可选的工作流配置
}}"""

    async def chat(
        self,
        message: str,
        session_id: str,
        user_id: str,
    ) -> AsyncGenerator[CreatorEvent, None]:
        """对话式创建流程"""
        
        # 获取会话上下文
        context = await self._get_context(session_id)
        
        yield CreatorEvent(type="thinking")
        
        # 调用LLM分析
        response = await self.llm.chat(
            messages=[{
                "role": "user",
                "content": self.CREATOR_PROMPT.format(
                    user_input=message,
                    context=context,
                )
            }],
            response_format={"type": "json_object"},
        )
        
        result = json.loads(response)
        
        if result["action"] == "ask":
            # 需要追问
            for q in result["questions"]:
                yield CreatorEvent(type="question", data={"question": q})
            
        elif result["action"] == "preview":
            # 预览配置
            yield CreatorEvent(type="preview", data=result["preview"])
            
        elif result["action"] == "create":
            # 创建Agent
            agent = await self._create_agent(result["config"], user_id)
            yield CreatorEvent(type="done", data={"agent_id": agent.id})
```

---

## 六、前端技术选型

### 6.1 可视化编排

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          前端技术栈                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  框架: React 18 + Vite (纯SPA)                                              │
│                                                                             │
│  可视化编排:                                                                │
│  ├─ React Flow (推荐) - 专业的流程图库                                     │
│  │   ├─ 丰富的节点和边类型                                                 │
│  │   ├─ 拖拽、缩放、平移                                                   │
│  │   ├─ 自定义节点组件                                                     │
│  │   └─ 良好的性能                                                         │
│  │                                                                         │
│  └─ 备选: XYFlow, Rete.js, JointJS                                        │
│                                                                             │
│  代码编辑器:                                                                │
│  └─ Monaco Editor - VS Code同款编辑器                                      │
│                                                                             │
│  UI组件:                                                                    │
│  └─ shadcn/ui + Tailwind CSS                                               │
│                                                                             │
│  状态管理:                                                                  │
│  └─ Zustand + React Query                                                  │
│                                                                             │
│  实时通信:                                                                  │
│  └─ Server-Sent Events (SSE)                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 新增前端目录

```
frontend/
├── app/
│   └── (dashboard)/
│       └── studio/                # 工作台页面
│           ├── page.tsx           # 工作台首页
│           ├── create/            # 对话创建
│           │   └── page.tsx
│           ├── workflow/          # 工作流编排
│           │   ├── page.tsx       # 列表
│           │   └── [id]/
│           │       └── page.tsx   # 编辑器
│           ├── prompts/           # 提示词工程
│           │   └── [agentId]/
│           │       └── page.tsx
│           ├── test/              # 调试测试
│           │   └── page.tsx
│           ├── deploy/            # 部署管理
│           │   └── page.tsx
│           └── templates/         # 模板市场
│               └── page.tsx
│
├── components/
│   └── studio/                    # 工作台组件
│       ├── workflow/              # 工作流编排组件
│       │   ├── Canvas.tsx         # 画布
│       │   ├── NodePanel.tsx      # 节点面板
│       │   ├── PropertyPanel.tsx  # 属性面板
│       │   ├── nodes/             # 自定义节点
│       │   │   ├── LLMNode.tsx
│       │   │   ├── ToolNode.tsx
│       │   │   └── ...
│       │   └── edges/             # 自定义边
│       ├── prompt/                # 提示词组件
│       │   ├── Editor.tsx         # 编辑器
│       │   ├── VersionList.tsx    # 版本列表
│       │   └── TestPanel.tsx      # 测试面板
│       ├── test/                  # 测试组件
│       │   ├── InputPanel.tsx
│       │   ├── OutputPanel.tsx
│       │   └── TraceViewer.tsx
│       └── deploy/                # 部署组件
│           ├── ConfigForm.tsx
│           └── APIDoc.tsx
│
└── stores/
    └── studio.ts                  # 工作台状态
```

---

## 七、实施计划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            实施路线图                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 1: 基础工作台 (3-4周)                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                                │
│  □ 工作台基础框架                                                          │
│  □ 简单的Agent配置界面                                                     │
│  □ System Prompt编辑器                                                     │
│  □ 基础测试运行                                                            │
│  ──────────────────────────────────────────────────▶ 能创建、能测试        │
│                                                                             │
│  Phase 2: 可视化编排 (4-5周)                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                                │
│  □ 可视化画布 (React Flow)                                                 │
│  □ 核心节点类型                                                            │
│  □ 节点连接和配置                                                          │
│  □ 工作流编译和执行                                                        │
│  ──────────────────────────────────────────────────▶ 能编排、能执行        │
│                                                                             │
│  Phase 3: 对话创建 & 提示词工程 (3-4周)                                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                         │
│  □ 对话式创建器                                                            │
│  □ 提示词版本管理                                                          │
│  □ 测试用例管理                                                            │
│  □ A/B测试支持                                                             │
│  ──────────────────────────────────────────────────▶ 能对话创建、能优化    │
│                                                                             │
│  Phase 4: 部署 & 模板市场 (3-4周)                                           │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                            │
│  □ 一键部署                                                                │
│  □ API生成                                                                 │
│  □ 模板市场                                                                │
│  □ 代码导出                                                                │
│  ──────────────────────────────────────────────────▶ 能部署、能分享        │
│                                                                             │
│  Phase 5: 高级功能 (持续迭代)                                               │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                                               │
│  □ 高级调试工具                                                            │
│  □ 监控和分析                                                              │
│  □ 协作功能                                                                │
│  □ 更多节点类型                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

<div align="center">

**低代码构建 · 可视化编排 · 一键部署**

*文档版本: v1.0 | 最后更新: 2026-01-12*

</div>
