# 📋 AI Agent 系统开发任务分解

> **基于架构设计、详细设计、工作台集成、代码质量保证四大设计文档的完整任务拆分**
>
> **版本**: v1.0 | **创建时间**: 2026-01-12

---

## 一、项目总览

### 1.1 系统组成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI Agent 系统组成                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  模块 1: Agent Core (核心引擎)                                       │  │
│   │  • Main Loop 执行循环                                                │  │
│   │  • 上下文管理、记忆系统、工具系统、模型网关                          │  │
│   │  • 检查点、Human-in-the-Loop、终止条件                               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  模块 2: Agent Studio (工作台)                                       │  │
│   │  • 可视化编排 (Code-First + React Flow)                              │  │
│   │  • 对话式创建、测试运行器、部署管理                                  │  │
│   │  • 运行时状态可视化、时间旅行调试                                    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  模块 3: 代码质量保证系统                                            │  │
│   │  • LSP 集成 (Pyright + ruff)                                         │  │
│   │  • 代码验证器、架构规范检查                                          │  │
│   │  • 自动修复、沙箱执行验证                                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  模块 4: 基础设施                                                    │  │
│   │  • API 网关、数据库、向量库、缓存                                    │  │
│   │  • 监控、日志、安全                                                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 开发阶段规划

| 阶段 | 名称 | 预计周期 | 核心目标 |
|------|------|----------|----------|
| Phase 1 | 基础架构 | 2-3 周 | 项目骨架、基础设施、核心引擎框架 |
| Phase 2 | 核心引擎 | 3-4 周 | Agent Core 完整实现，能对话、能执行 |
| Phase 3 | 工作台基础 | 3-4 周 | Code-First 编排、测试运行、基础调试 |
| Phase 4 | 记忆与质量 | 2-3 周 | 记忆系统、代码质量保证、LSP 集成 |
| Phase 5 | 高级功能 | 3-4 周 | Human-in-the-Loop、时间旅行、沙箱执行 |
| Phase 6 | 生产就绪 | 2-3 周 | 多用户、权限、监控、部署 |

**总预计周期: 15-21 周**

---

## 二、Phase 1: 基础架构 (2-3周)

> **目标**: 搭建项目骨架，完成基础设施，建立开发规范

### 2.1 项目初始化

#### 2.1.1 后端项目初始化

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-B-001 | 创建后端项目结构 | 按照详细设计文档创建目录结构 | P0 | 2h |
| P1-B-002 | 配置 Python 环境 | pyproject.toml, requirements.txt | P0 | 1h |
| P1-B-003 | 配置类型检查 | mypy/pyright 配置，strict mode | P0 | 1h |
| P1-B-004 | 配置代码规范 | ruff 配置，pre-commit hooks | P1 | 1h |
| P1-B-005 | FastAPI 应用骨架 | main.py, config.py, 路由结构 | P0 | 2h |
| P1-B-006 | 配置管理实现 | Pydantic Settings, .env 支持 | P0 | 2h |

#### 2.1.2 前端项目初始化

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-F-001 | 创建前端项目 | Vite + React + TypeScript | P0 | 1h |
| P1-F-002 | 配置 Tailwind CSS | tailwind.config.js, shadcn/ui | P0 | 1h |
| P1-F-003 | 配置状态管理 | Zustand stores 结构 | P1 | 1h |
| P1-F-004 | 配置路由 | React Router, 页面结构 | P1 | 1h |
| P1-F-005 | API 客户端封装 | axios/fetch 封装, 类型定义 | P0 | 2h |

#### 2.1.3 开发规范

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-D-001 | Git 工作流配置 | 分支策略, commit message 规范 | P1 | 1h |
| P1-D-002 | CI/CD 基础配置 | GitHub Actions 基础流程 | P2 | 2h |

### 2.2 基础设施

#### 2.2.1 数据库

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-DB-001 | PostgreSQL 连接 | SQLAlchemy 2.0 异步配置 | P0 | 2h |
| P1-DB-002 | Alembic 迁移配置 | 迁移脚本结构 | P0 | 1h |
| P1-DB-003 | 基础数据模型 | users, agents 表结构 | P0 | 3h |
| P1-DB-004 | Repository 模式 | 数据访问层抽象 | P1 | 3h |

#### 2.2.2 缓存与队列

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-CA-001 | Redis 连接配置 | 异步 Redis 客户端 | P0 | 1h |
| P1-CA-002 | 缓存服务封装 | 缓存读写抽象 | P1 | 2h |
| P1-CA-003 | Celery 配置 | 异步任务队列 | P2 | 2h |

#### 2.2.3 Docker 环境

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-DK-001 | docker-compose 开发环境 | PostgreSQL, Redis, 向量库 | P0 | 2h |
| P1-DK-002 | 后端 Dockerfile | 开发/生产镜像 | P1 | 1h |
| P1-DK-003 | 前端 Dockerfile | 构建/运行镜像 | P2 | 1h |

### 2.3 核心类型定义

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P1-T-001 | 基础类型定义 | AgentMode, MessageRole 等枚举 | P0 | 2h |
| P1-T-002 | Pydantic 模型定义 | Message, ToolCall, AgentConfig 等 | P0 | 3h |
| P1-T-003 | Protocol 定义 | ToolProtocol, CheckpointerProtocol | P0 | 2h |
| P1-T-004 | TypedDict 定义 | NodeDefinition, WorkflowDefinition | P1 | 1h |
| P1-T-005 | 泛型类型 | Result[T], 类型别名 | P1 | 1h |

### 2.4 Phase 1 交付物

```
✅ 可运行的后端骨架 (FastAPI + PostgreSQL + Redis)
✅ 可运行的前端骨架 (React + Vite + Tailwind)
✅ 完整的类型定义系统
✅ Docker 开发环境
✅ CI/CD 基础流程
✅ 开发规范文档
```

---

## 三、Phase 2: 核心引擎 (3-4周)

> **目标**: 实现 Agent Core 核心功能，能对话、能执行工具

### 3.1 LLM Gateway (模型网关)

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-LLM-001 | LiteLLM 集成 | 统一多模型接口 | P0 | 3h |
| P2-LLM-002 | OpenAI Provider | GPT-4, GPT-4o 支持 | P0 | 2h |
| P2-LLM-003 | Anthropic Provider | Claude 3.5 支持 | P0 | 2h |
| P2-LLM-004 | 流式响应支持 | SSE streaming | P0 | 3h |
| P2-LLM-005 | 模型路由策略 | 任务类型路由、Fallback | P1 | 3h |
| P2-LLM-006 | Token 计数 | tiktoken 集成 | P0 | 2h |
| P2-LLM-007 | 重试与限流 | 请求重试、速率限制 | P1 | 2h |

### 3.2 Context Manager (上下文管理器)

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-CTX-001 | ContextManager 框架 | 基础结构实现 | P0 | 2h |
| P2-CTX-002 | 上下文组装逻辑 | System Prompt + History + Memory | P0 | 4h |
| P2-CTX-003 | Token 预算管理 | 动态分配策略 | P0 | 3h |
| P2-CTX-004 | 上下文裁剪策略 | 滑动窗口、重要性筛选 | P1 | 3h |
| P2-CTX-005 | 会话历史管理 | 消息存储、摘要压缩 | P1 | 3h |

### 3.3 Tool System (工具系统)

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-TL-001 | ToolRegistry 实现 | 工具注册中心 | P0 | 3h |
| P2-TL-002 | ToolExecutor 实现 | 工具执行引擎 | P0 | 4h |
| P2-TL-003 | 参数校验 | JSON Schema 验证 | P0 | 2h |
| P2-TL-004 | 内置工具: read_file | 文件读取 | P0 | 2h |
| P2-TL-005 | 内置工具: write_file | 文件写入 | P0 | 2h |
| P2-TL-006 | 内置工具: list_dir | 目录列表 | P1 | 1h |
| P2-TL-007 | 内置工具: run_shell | Shell 命令 | P0 | 3h |
| P2-TL-008 | 内置工具: web_search | 网络搜索 | P1 | 3h |
| P2-TL-009 | 工具结果格式化 | 截断、脱敏 | P1 | 2h |

### 3.4 Agent Engine (执行引擎)

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-AG-001 | AgentEngine 框架 | 基础结构 | P0 | 3h |
| P2-AG-002 | Main Loop 实现 | 核心执行循环 | P0 | 6h |
| P2-AG-003 | 工具调用解析 | LLM 响应解析 | P0 | 3h |
| P2-AG-004 | 执行事件流 | AgentEvent 事件体系 | P0 | 3h |
| P2-AG-005 | ReAct 推理模式 | 思考-行动循环 | P0 | 4h |
| P2-AG-006 | 终止条件检查 | max_iterations, timeout | P0 | 2h |
| P2-AG-007 | 错误处理 | 异常捕获、重试 | P1 | 3h |

### 3.5 会话管理

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-SS-001 | Session 数据模型 | sessions, messages 表 | P0 | 2h |
| P2-SS-002 | SessionService | 会话 CRUD | P0 | 3h |
| P2-SS-003 | 消息持久化 | 消息存储与检索 | P0 | 2h |

### 3.6 Chat API

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-API-001 | POST /chat | 对话接口 (SSE) | P0 | 4h |
| P2-API-002 | GET /sessions | 会话列表 | P0 | 2h |
| P2-API-003 | GET /sessions/{id}/messages | 消息历史 | P0 | 2h |
| P2-API-004 | Agent CRUD API | 创建/读取/更新/删除 | P0 | 3h |

### 3.7 基础前端

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P2-FE-001 | Chat 页面布局 | 对话界面框架 | P0 | 3h |
| P2-FE-002 | 消息组件 | 用户/助手消息展示 | P0 | 3h |
| P2-FE-003 | 流式消息渲染 | SSE 接收与展示 | P0 | 4h |
| P2-FE-004 | 工具调用展示 | Tool call/result 展示 | P1 | 3h |
| P2-FE-005 | 会话列表 | 历史会话列表 | P1 | 2h |

### 3.8 Phase 2 交付物

```
✅ 完整的 Agent Core 执行引擎
✅ 多模型支持 (OpenAI, Claude)
✅ 5+ 内置工具
✅ 流式对话 API
✅ 基础 Chat UI
✅ 能对话、能调用工具、能完成任务
```

---

## 四、Phase 3: 工作台基础 (3-4周)

> **目标**: 实现 Agent Studio 核心功能，Code-First 可视化编排

### 4.1 Code-First 代码解析

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-CF-001 | LangGraphParser 实现 | Python AST 解析 | P0 | 6h |
| P3-CF-002 | 节点解析 | add_node 调用提取 | P0 | 3h |
| P3-CF-003 | 边解析 | add_edge, conditional_edges | P0 | 3h |
| P3-CF-004 | State 类解析 | StateGraph 状态类提取 | P1 | 2h |
| P3-CF-005 | React Flow 格式转换 | nodes[], edges[] 生成 | P0 | 3h |

### 4.2 Code-First 代码生成

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-CG-001 | LangGraphCodeGen 实现 | AST 代码生成 | P0 | 4h |
| P3-CG-002 | add_node 代码生成 | 添加节点 | P0 | 2h |
| P3-CG-003 | add_edge 代码生成 | 添加边 | P0 | 2h |
| P3-CG-004 | 删除节点/边 | AST 重写 | P1 | 3h |
| P3-CG-005 | libcst 集成 | 保留格式的代码修改 | P1 | 4h |

### 4.3 工作台后端服务

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-ST-001 | Workflow 数据模型 | workflows, workflow_versions 表 | P0 | 3h |
| P3-ST-002 | WorkflowService | CRUD 操作 | P0 | 3h |
| P3-ST-003 | WorkflowConverter | 配置转换 (兼容模式) | P1 | 4h |
| P3-ST-004 | TestRunner 实现 | 测试执行服务 | P0 | 5h |
| P3-ST-005 | ExecutionTracer | 执行追踪事件 | P0 | 4h |

### 4.4 工作台 API

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-API-001 | /studio/workflows CRUD | 工作流管理 API | P0 | 3h |
| P3-API-002 | /studio/workflows/{id}/parse | 代码解析 API | P0 | 2h |
| P3-API-003 | /studio/workflows/{id}/generate | 代码生成 API | P0 | 2h |
| P3-API-004 | /studio/test/run | 测试运行 (SSE) | P0 | 3h |
| P3-API-005 | WebSocket /ws/execution | 执行状态推送 | P0 | 4h |

### 4.5 工作台前端 - 编辑器

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-FE-001 | 工作台页面布局 | 分栏布局框架 | P0 | 3h |
| P3-FE-002 | Monaco Editor 集成 | Python 代码编辑器 | P0 | 4h |
| P3-FE-003 | React Flow 集成 | 可视化画布 | P0 | 4h |
| P3-FE-004 | 自定义节点组件 | LLM/Tool/Condition 节点 | P0 | 6h |
| P3-FE-005 | 代码-画布双向同步 | 实时同步逻辑 | P0 | 6h |

### 4.6 工作台前端 - 测试运行

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P3-FE-006 | 测试面板 | 输入/输出展示 | P0 | 3h |
| P3-FE-007 | 节点高亮 | 执行节点视觉反馈 | P0 | 3h |
| P3-FE-008 | 执行日志展示 | 事件流展示 | P0 | 3h |
| P3-FE-009 | useExecutionTracer Hook | WebSocket 集成 | P0 | 3h |

### 4.7 Phase 3 交付物

```
✅ Code-First 代码解析器
✅ Code-First 代码生成器
✅ 代码编辑器 + 可视化画布双向同步
✅ 测试运行功能
✅ 执行状态实时展示
```

---

## 五、Phase 4: 记忆与质量 (2-3周)

> **目标**: 实现记忆系统、代码质量保证、LSP 集成

### 5.1 向量数据库

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-VDB-001 | Qdrant 客户端封装 | 异步客户端 | P0 | 2h |
| P4-VDB-002 | Collection 管理 | 创建/删除集合 | P0 | 2h |
| P4-VDB-003 | 向量 CRUD | 插入/查询/删除 | P0 | 3h |
| P4-VDB-004 | Embedding 服务 | OpenAI embedding 集成 | P0 | 2h |

### 5.2 记忆系统

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-MEM-001 | Memory 数据模型 | memories 表 | P0 | 2h |
| P4-MEM-002 | MemoryManager 实现 | 记忆管理核心 | P0 | 4h |
| P4-MEM-003 | 记忆提取 (LLM) | 从对话提取重要信息 | P0 | 4h |
| P4-MEM-004 | MemoryRetriever 实现 | 记忆检索 | P0 | 4h |
| P4-MEM-005 | 多路召回策略 | 向量+关键词+时间 | P1 | 3h |
| P4-MEM-006 | 记忆重要性评分 | 综合评分算法 | P1 | 2h |

### 5.3 LSP 集成

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-LSP-001 | LSPProxy 服务 | LSP 代理框架 | P0 | 4h |
| P4-LSP-002 | Pyright 进程管理 | 子进程启动/通信 | P0 | 3h |
| P4-LSP-003 | LSP 初始化 | initialize 协议 | P0 | 2h |
| P4-LSP-004 | 诊断功能 | textDocument/diagnostic | P0 | 3h |
| P4-LSP-005 | 补全功能 | textDocument/completion | P1 | 3h |
| P4-LSP-006 | 悬停功能 | textDocument/hover | P2 | 2h |
| P4-LSP-007 | RuffService | Lint 检查服务 | P0 | 2h |

### 5.4 代码验证器

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-VAL-001 | CodeValidator 框架 | 验证器核心 | P0 | 3h |
| P4-VAL-002 | 语法检查 | ast.parse | P0 | 1h |
| P4-VAL-003 | 类型检查集成 | Pyright 调用 | P0 | 3h |
| P4-VAL-004 | Lint 检查集成 | ruff 调用 | P0 | 2h |
| P4-VAL-005 | 架构规范检查器 | ArchitectureValidator | P0 | 4h |
| P4-VAL-006 | 架构规则: Agent 继承 | ARCH001 | P0 | 1h |
| P4-VAL-007 | 架构规则: Tool 实现 | ARCH002 | P0 | 1h |
| P4-VAL-008 | 安全规则: 禁止 eval | SEC001 | P0 | 1h |

### 5.5 自动修复

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-FIX-001 | CodeFixer 框架 | 自动修复核心 | P0 | 3h |
| P4-FIX-002 | 修复提示构建 | 错误信息 → LLM Prompt | P0 | 2h |
| P4-FIX-003 | 修复循环实现 | 最多 3 次重试 | P0 | 3h |
| P4-FIX-004 | 代码提取 | 从 LLM 响应提取代码 | P0 | 1h |

### 5.6 前端 LSP 集成

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P4-FE-001 | Monaco LSP 配置 | 语言服务配置 | P0 | 3h |
| P4-FE-002 | 错误波浪线展示 | 诊断信息渲染 | P0 | 2h |
| P4-FE-003 | 智能补全 | 补全列表展示 | P1 | 2h |
| P4-FE-004 | 悬停提示 | 类型信息展示 | P2 | 1h |

### 5.7 Phase 4 交付物

```
✅ 完整的记忆系统 (存储 + 检索)
✅ LSP 集成 (实时诊断 + 补全)
✅ 代码验证器 (语法 + 类型 + 架构)
✅ 自动修复功能
✅ Monaco Editor LSP 集成
```

---

## 六、Phase 5: 高级功能 (3-4周)

> **目标**: 实现 Human-in-the-Loop、检查点、时间旅行、沙箱执行

### 6.1 检查点系统

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-CP-001 | Checkpointer 框架 | 检查点管理器 | P0 | 3h |
| P5-CP-002 | SessionState 模型 | 状态快照结构 | P0 | 2h |
| P5-CP-003 | Redis 存储实现 | RedisCheckpointStorage | P0 | 3h |
| P5-CP-004 | PostgreSQL 存储实现 | PostgresCheckpointStorage | P1 | 3h |
| P5-CP-005 | 检查点保存逻辑 | Main Loop 集成 | P0 | 2h |
| P5-CP-006 | 检查点加载恢复 | 状态恢复 | P0 | 2h |
| P5-CP-007 | 历史列表 API | list_history | P0 | 2h |
| P5-CP-008 | 状态对比 API | diff | P1 | 2h |

### 6.2 Human-in-the-Loop

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-HITL-001 | InterruptConfig 实现 | 中断配置 | P0 | 2h |
| P5-HITL-002 | 中断点检查逻辑 | _needs_human_approval | P0 | 2h |
| P5-HITL-003 | 中断事件生成 | interrupt event | P0 | 2h |
| P5-HITL-004 | resume API 实现 | 恢复执行 | P0 | 4h |
| P5-HITL-005 | 批准/修改/拒绝处理 | 用户响应处理 | P0 | 3h |

### 6.3 终止条件

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-TM-001 | TerminationCondition 模型 | 终止条件配置 | P0 | 1h |
| P5-TM-002 | max_iterations 检查 | 最大轮次 | P0 | 1h |
| P5-TM-003 | token_budget 检查 | Token 预算 | P0 | 1h |
| P5-TM-004 | timeout 检查 | 超时 | P0 | 1h |
| P5-TM-005 | 组合条件支持 | OR 逻辑 | P1 | 1h |

### 6.4 沙箱执行

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-SB-001 | DockerExecutor 框架 | Docker 沙箱执行器 | P0 | 4h |
| P5-SB-002 | 容器配置 | 资源限制、网络隔离 | P0 | 2h |
| P5-SB-003 | Python 执行 | run_python 工具 | P0 | 3h |
| P5-SB-004 | 超时控制 | 容器超时终止 | P0 | 2h |
| P5-SB-005 | 输出捕获 | stdout/stderr | P0 | 2h |
| P5-SB-006 | SandboxExecutor 验证 | 代码执行验证 | P1 | 3h |

### 6.5 时间旅行调试

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-TT-001 | 检查点历史 API | /checkpoints/{session_id} | P0 | 2h |
| P5-TT-002 | 状态查看 API | /checkpoints/{id}/state | P0 | 2h |
| P5-TT-003 | 状态对比 API | /checkpoints/diff | P0 | 2h |
| P5-TT-004 | 从历史恢复执行 | resume from checkpoint | P0 | 3h |

### 6.6 前端高级功能

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P5-FE-001 | Human-in-the-Loop UI | 确认/修改/拒绝弹窗 | P0 | 4h |
| P5-FE-002 | 时间旅行调试面板 | 检查点列表、状态展示 | P0 | 5h |
| P5-FE-003 | 状态对比视图 | Diff 展示 | P1 | 3h |
| P5-FE-004 | 执行时间线 | 可视化时间线 | P1 | 4h |

### 6.7 Phase 5 交付物

```
✅ 完整的检查点系统
✅ Human-in-the-Loop 工作流
✅ 灵活的终止条件
✅ Docker 沙箱代码执行
✅ 时间旅行调试功能
```

---

## 七、Phase 6: 生产就绪 (2-3周)

> **目标**: 多用户支持、权限控制、监控告警、生产部署

### 7.1 用户与认证

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-AUTH-001 | 用户注册/登录 | JWT 认证 | P0 | 4h |
| P6-AUTH-002 | 密码加密 | bcrypt | P0 | 1h |
| P6-AUTH-003 | Token 刷新 | refresh token | P0 | 2h |
| P6-AUTH-004 | OAuth 集成 | GitHub/Google (可选) | P2 | 4h |

### 7.2 权限控制

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-RBAC-001 | 角色模型 | roles 表 | P0 | 2h |
| P6-RBAC-002 | 权限模型 | permissions 表 | P0 | 2h |
| P6-RBAC-003 | RBAC 中间件 | 权限检查 | P0 | 3h |
| P6-RBAC-004 | 资源访问控制 | Agent/Session 归属 | P0 | 3h |

### 7.3 监控与可观测性

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-MON-001 | Prometheus 指标 | 请求/Token/工具调用 | P0 | 3h |
| P6-MON-002 | 健康检查 | /health 端点 | P0 | 1h |
| P6-MON-003 | OpenTelemetry 集成 | 链路追踪 | P1 | 4h |
| P6-MON-004 | 结构化日志 | JSON 日志格式 | P0 | 2h |
| P6-MON-005 | 错误追踪 | Sentry (可选) | P2 | 2h |

### 7.4 性能优化

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-PERF-001 | 数据库连接池 | SQLAlchemy pool | P0 | 1h |
| P6-PERF-002 | Redis 连接池 | aioredis pool | P0 | 1h |
| P6-PERF-003 | 查询优化 | 索引、N+1 问题 | P1 | 3h |
| P6-PERF-004 | 缓存策略 | 热点数据缓存 | P1 | 3h |

### 7.5 生产部署

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-DEP-001 | Nginx 配置 | 反向代理、SSL | P0 | 2h |
| P6-DEP-002 | Kubernetes 清单 | Deployment, Service | P1 | 4h |
| P6-DEP-003 | Helm Chart | (可选) | P2 | 4h |
| P6-DEP-004 | CI/CD 完善 | 自动部署流程 | P0 | 3h |
| P6-DEP-005 | 数据库备份 | 备份策略 | P0 | 2h |

### 7.6 安全加固

| 任务 ID | 任务名称 | 描述 | 优先级 | 预计工时 |
|---------|----------|------|--------|----------|
| P6-SEC-001 | 输入验证 | 所有 API 输入 | P0 | 3h |
| P6-SEC-002 | SQL 注入防护 | ORM 安全使用 | P0 | 1h |
| P6-SEC-003 | XSS 防护 | 输出转义 | P0 | 1h |
| P6-SEC-004 | 速率限制 | API 限流 | P0 | 2h |
| P6-SEC-005 | 敏感数据脱敏 | 日志/响应脱敏 | P1 | 2h |

### 7.7 Phase 6 交付物

```
✅ 完整的用户系统
✅ RBAC 权限控制
✅ 监控与告警
✅ 生产级部署方案
✅ 安全加固
```

---

## 八、任务优先级说明

| 优先级 | 说明 | 处理方式 |
|--------|------|----------|
| **P0** | 核心功能，阻塞后续开发 | 必须在当前阶段完成 |
| **P1** | 重要功能，影响用户体验 | 当前阶段尽量完成 |
| **P2** | 增强功能，可延后 | 可推迟到下一阶段 |

---

## 九、依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              任务依赖关系                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 1: 基础架构                                                          │
│  ├─ 项目初始化 ──────────────┬───────────────────────────────────┐         │
│  ├─ 基础设施 (DB/Redis) ─────┤                                   │         │
│  └─ 类型定义 ────────────────┘                                   │         │
│                              │                                   │         │
│                              ▼                                   │         │
│  Phase 2: 核心引擎                                               │         │
│  ├─ LLM Gateway ─────────────┬─────────────────────┐             │         │
│  ├─ Context Manager ─────────┤                     │             │         │
│  ├─ Tool System ─────────────┤                     │             │         │
│  └─ Agent Engine ────────────┘                     │             │         │
│                              │                     │             │         │
│              ┌───────────────┴───────────────┐     │             │         │
│              ▼                               ▼     │             │         │
│  Phase 3: 工作台基础              Phase 4: 记忆与质量             │         │
│  ├─ Code-First 解析/生成          ├─ 向量数据库                   │         │
│  ├─ 可视化编排                   ├─ 记忆系统 ◀─────────────────┘         │
│  └─ 测试运行                     └─ LSP/代码质量                          │
│              │                               │                             │
│              └───────────────┬───────────────┘                             │
│                              │                                             │
│                              ▼                                             │
│  Phase 5: 高级功能                                                         │
│  ├─ 检查点系统 (依赖 Agent Engine)                                         │
│  ├─ Human-in-the-Loop (依赖检查点)                                         │
│  ├─ 沙箱执行 (依赖 Tool System)                                            │
│  └─ 时间旅行 (依赖检查点)                                                  │
│                              │                                             │
│                              ▼                                             │
│  Phase 6: 生产就绪                                                         │
│  ├─ 用户与认证                                                             │
│  ├─ 权限控制                                                               │
│  ├─ 监控与部署                                                             │
│  └─ 安全加固                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十、里程碑定义

| 里程碑 | 阶段 | 核心交付 | 验收标准 |
|--------|------|----------|----------|
| **M1** | Phase 1 完成 | 项目骨架 | 前后端可启动，数据库可连接 |
| **M2** | Phase 2 完成 | 能对话 | 用户能与 Agent 对话，Agent 能调用工具 |
| **M3** | Phase 3 完成 | 能编排 | 用户能通过代码/画布创建 Agent 并测试 |
| **M4** | Phase 4 完成 | 能记忆 | Agent 能记住历史，代码有质量保证 |
| **M5** | Phase 5 完成 | 能调试 | 支持 HITL、时间旅行、沙箱执行 |
| **M6** | Phase 6 完成 | 能上线 | 多用户、权限、监控、生产部署 |

---

## 十一、风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| LLM API 不稳定 | 对话功能不可用 | 中 | 多模型 Fallback、本地模型备选 |
| 代码解析复杂 | Code-First 功能受限 | 中 | 先支持简单模式，渐进增强 |
| 沙箱安全风险 | 代码逃逸 | 低 | Docker 隔离、禁用网络、资源限制 |
| 性能瓶颈 | 响应慢 | 中 | 缓存、异步、流式响应 |

---

## 十二、附录

### A. 技术栈速查

| 层级 | 技术选型 |
|------|----------|
| 前端框架 | React 18 + Vite + TypeScript |
| 前端 UI | Tailwind CSS + shadcn/ui |
| 可视化 | React Flow + Monaco Editor |
| 后端框架 | FastAPI + Python 3.11+ |
| 数据库 | PostgreSQL 15 + SQLAlchemy 2.0 |
| 向量库 | Qdrant (生产) / Chroma (开发) |
| 缓存 | Redis 7 |
| LLM | LiteLLM (统一接口) |
| 类型检查 | Pyright + Pydantic v2 |
| Linting | ruff |
| 容器 | Docker + Docker Compose |

### B. 文档引用

- 架构设计: `AI-Agent系统架构设计文档.md`
- 详细设计: `AI-Agent详细设计文档.md`
- 工作台集成: `工作台与Agent系统集成设计.md`
- 代码质量: `代码生成质量保证与LSP集成设计.md`

---

<div align="center">

**按阶段推进，稳步交付**

*文档版本: v1.0 | 最后更新: 2026-01-12*

</div>
