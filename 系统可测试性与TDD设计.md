# ğŸ§ª AI Agent ç³»ç»Ÿå¯æµ‹è¯•æ€§ä¸ TDD è®¾è®¡

> **æ ¸å¿ƒç›®æ ‡**: æ„å»ºé«˜å¯æµ‹è¯•æ€§æ¶æ„ï¼Œé‡‡ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘ç¡®ä¿ä»£ç è´¨é‡ä¸ç³»ç»Ÿç¨³å®šæ€§
>
> **ç‰ˆæœ¬**: v1.0 | **åˆ›å»ºæ—¶é—´**: 2026-01-12

---

## ä¸€ã€æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD) æ–¹æ³•è®º

### 1.1 TDD æ ¸å¿ƒç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TDD çº¢-ç»¿-é‡æ„å¾ªç¯                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                         â”‚   ğŸ”´ RED    â”‚                                     â”‚
â”‚                         â”‚  ç¼–å†™å¤±è´¥æµ‹è¯• â”‚                                     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç¼–å†™æœ€å°ä»£ç     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚      â”‚  â™»ï¸ REFACTOR â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ğŸŸ¢ GREEN  â”‚                     â”‚
â”‚      â”‚   é‡æ„ä¼˜åŒ–   â”‚    ä½¿æµ‹è¯•é€šè¿‡      â”‚  æµ‹è¯•é€šè¿‡   â”‚                     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚             â”‚                                                               â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                                      â”‚                      â”‚
â”‚                         ä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹                â–¼                      â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚                         â”‚   ğŸ”´ RED    â”‚                                     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                             â”‚
â”‚  æ ¸å¿ƒåŸåˆ™:                                                                  â”‚
â”‚  1. å…ˆå†™æµ‹è¯•ï¼Œå†å†™å®ç°                                                      â”‚
â”‚  2. åªå†™è®©æµ‹è¯•é€šè¿‡çš„æœ€å°‘ä»£ç                                                 â”‚
â”‚  3. æµ‹è¯•é€šè¿‡åï¼Œé‡æ„ä¼˜åŒ–ä»£ç                                                 â”‚
â”‚  4. ä¿æŒæµ‹è¯•å§‹ç»ˆé€šè¿‡                                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 TDD åœ¨ AI Agent ç³»ç»Ÿä¸­çš„åº”ç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AI Agent ç³»ç»Ÿ TDD åº”ç”¨ç­–ç•¥                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ¨¡å—ç±»å‹              TDD é€‚ç”¨åº¦        ç­–ç•¥                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  çº¯ä¸šåŠ¡é€»è¾‘            â­â­â­â­â­          ä¸¥æ ¼ TDD                          â”‚
â”‚  (Tokenè®¡ç®—ã€çŠ¶æ€ç®¡ç†)                    æµ‹è¯•å…ˆè¡Œï¼Œ100% è¦†ç›–                â”‚
â”‚                                                                             â”‚
â”‚  æ•°æ®å¤„ç†              â­â­â­â­â­          ä¸¥æ ¼ TDD                          â”‚
â”‚  (ä¸Šä¸‹æ–‡ç»„è£…ã€è®°å¿†æ£€ç´¢)                   è¾¹ç•Œæµ‹è¯•ã€å¼‚å¸¸æµ‹è¯•                  â”‚
â”‚                                                                             â”‚
â”‚  å·¥å…·æ‰§è¡Œ              â­â­â­â­            TDD + Mock                        â”‚
â”‚  (æ–‡ä»¶æ“ä½œã€Shellå‘½ä»¤)                    Mock å¤–éƒ¨ä¾èµ–                      â”‚
â”‚                                                                             â”‚
â”‚  LLM äº¤äº’              â­â­â­              Mock + é›†æˆæµ‹è¯•                    â”‚
â”‚  (æ¨¡å‹è°ƒç”¨ã€å“åº”è§£æ)                     Mock APIã€çœŸå®æ¨¡å‹æµ‹è¯•             â”‚
â”‚                                                                             â”‚
â”‚  UI ç»„ä»¶               â­â­â­              ç»„ä»¶æµ‹è¯• + å¿«ç…§æµ‹è¯•                â”‚
â”‚  (React ç»„ä»¶)                             Testing Library                   â”‚
â”‚                                                                             â”‚
â”‚  ç«¯åˆ°ç«¯æµç¨‹            â­â­                E2E æµ‹è¯•                          â”‚
â”‚  (å®Œæ•´å¯¹è¯æµç¨‹)                           å…³é”®è·¯å¾„è¦†ç›–                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 TDD å·¥ä½œæµç¤ºä¾‹

```python
# ç¤ºä¾‹: TDD å¼€å‘ Token è®¡æ•°å™¨

# ============================================================================
# æ­¥éª¤ 1: ğŸ”´ RED - ç¼–å†™å¤±è´¥çš„æµ‹è¯•
# ============================================================================

# tests/unit/test_token_counter.py

import pytest
from backend.utils.token import TokenCounter

class TestTokenCounter:
    """Token è®¡æ•°å™¨æµ‹è¯• - TDD ç¬¬ä¸€è½®"""
    
    def test_count_empty_string_returns_zero(self):
        """ç©ºå­—ç¬¦ä¸²åº”è¿”å› 0"""
        counter = TokenCounter()
        assert counter.count("") == 0
    
    def test_count_simple_text(self):
        """ç®€å•æ–‡æœ¬è®¡æ•°"""
        counter = TokenCounter()
        # "Hello world" å¤§çº¦ 2-3 ä¸ª token
        result = counter.count("Hello world")
        assert 2 <= result <= 3
    
    def test_count_chinese_text(self):
        """ä¸­æ–‡æ–‡æœ¬è®¡æ•°"""
        counter = TokenCounter()
        result = counter.count("ä½ å¥½ä¸–ç•Œ")
        assert result > 0

# æ­¤æ—¶è¿è¡Œæµ‹è¯•ä¼šå¤±è´¥ï¼Œå› ä¸º TokenCounter è¿˜ä¸å­˜åœ¨


# ============================================================================
# æ­¥éª¤ 2: ğŸŸ¢ GREEN - ç¼–å†™æœ€å°ä»£ç ä½¿æµ‹è¯•é€šè¿‡
# ============================================================================

# backend/utils/token.py

import tiktoken

class TokenCounter:
    """Token è®¡æ•°å™¨"""
    
    def __init__(self, model: str = "gpt-4"):
        self.encoding = tiktoken.encoding_for_model(model)
    
    def count(self, text: str) -> int:
        """è®¡ç®—æ–‡æœ¬çš„ token æ•°é‡"""
        if not text:
            return 0
        return len(self.encoding.encode(text))

# è¿è¡Œæµ‹è¯• -> å…¨éƒ¨é€šè¿‡ âœ…


# ============================================================================
# æ­¥éª¤ 3: â™»ï¸ REFACTOR - é‡æ„ä¼˜åŒ–
# ============================================================================

# backend/utils/token.py (é‡æ„ç‰ˆ)

from functools import lru_cache
import tiktoken

class TokenCounter:
    """Token è®¡æ•°å™¨ - æ”¯æŒç¼“å­˜å’Œå¤šæ¨¡å‹"""
    
    def __init__(self, model: str = "gpt-4"):
        self.model = model
        self._encoding = None
    
    @property
    def encoding(self):
        """å»¶è¿ŸåŠ è½½ç¼–ç å™¨"""
        if self._encoding is None:
            self._encoding = tiktoken.encoding_for_model(self.model)
        return self._encoding
    
    def count(self, text: str) -> int:
        """è®¡ç®—æ–‡æœ¬çš„ token æ•°é‡"""
        if not text:
            return 0
        return len(self.encoding.encode(text))
    
    def count_messages(self, messages: list[dict]) -> int:
        """è®¡ç®—æ¶ˆæ¯åˆ—è¡¨çš„ token æ•°é‡"""
        total = 0
        for msg in messages:
            total += self.count(msg.get("content", ""))
            total += 4  # æ¶ˆæ¯æ ¼å¼å¼€é”€
        return total

# è¿è¡Œæµ‹è¯• -> ä»ç„¶é€šè¿‡ âœ…


# ============================================================================
# æ­¥éª¤ 4: ğŸ”´ RED - æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹
# ============================================================================

class TestTokenCounter:
    """Token è®¡æ•°å™¨æµ‹è¯• - TDD ç¬¬äºŒè½®"""
    
    # ... ä¹‹å‰çš„æµ‹è¯• ...
    
    def test_count_messages(self):
        """æ¶ˆæ¯åˆ—è¡¨è®¡æ•°"""
        counter = TokenCounter()
        messages = [
            {"role": "user", "content": "Hello"},
            {"role": "assistant", "content": "Hi there"}
        ]
        result = counter.count_messages(messages)
        assert result > 0
    
    def test_count_with_different_model(self):
        """ä¸åŒæ¨¡å‹çš„è®¡æ•°"""
        counter_gpt4 = TokenCounter(model="gpt-4")
        counter_gpt35 = TokenCounter(model="gpt-3.5-turbo")
        
        text = "Hello world"
        # ä¸åŒæ¨¡å‹å¯èƒ½æœ‰ä¸åŒçš„ token æ•°
        assert counter_gpt4.count(text) >= 0
        assert counter_gpt35.count(text) >= 0

# ç»§ç»­ TDD å¾ªç¯...
```

---

## äºŒã€æµ‹è¯•é‡‘å­—å¡”

### 2.1 æµ‹è¯•å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æµ‹è¯•é‡‘å­—å¡”                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                              â–²                                              â”‚
â”‚                             /â”‚\         E2E æµ‹è¯•                            â”‚
â”‚                            / â”‚ \        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚                           /  â”‚  \       â€¢ å…³é”®ç”¨æˆ·æµç¨‹                       â”‚
â”‚                          /   â”‚   \      â€¢ çœŸå®ç¯å¢ƒæ¨¡æ‹Ÿ                       â”‚
â”‚                         /    â”‚    \     â€¢ æ•°é‡: å°‘ (~10%)                   â”‚
â”‚                        /â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€\    â€¢ æ‰§è¡Œ: æ…¢ (åˆ†é’Ÿçº§)                  â”‚
â”‚                       /      â”‚      \                                       â”‚
â”‚                      /       â”‚       \                                      â”‚
â”‚                     /â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€\   é›†æˆæµ‹è¯•                          â”‚
â”‚                    /         â”‚         \  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”‚
â”‚                   /          â”‚          \ â€¢ æ¨¡å—é—´äº¤äº’                       â”‚
â”‚                  /           â”‚           \â€¢ API ç«¯ç‚¹æµ‹è¯•                     â”‚
â”‚                 /            â”‚            \â€¢ æ•°é‡: ä¸­ (~20%)                 â”‚
â”‚                /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\â€¢ æ‰§è¡Œ: ä¸­ (ç§’çº§)                â”‚
â”‚               /              â”‚              \                               â”‚
â”‚              /               â”‚               \                              â”‚
â”‚             /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\  å•å…ƒæµ‹è¯•                   â”‚
â”‚            /                 â”‚                 \ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚           /                  â”‚                  \â€¢ ç‹¬ç«‹å‡½æ•°/ç±»æµ‹è¯•           â”‚
â”‚          /                   â”‚                   \â€¢ Mock å¤–éƒ¨ä¾èµ–           â”‚
â”‚         /                    â”‚                    \â€¢ æ•°é‡: å¤š (~70%)        â”‚
â”‚        /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\â€¢ æ‰§è¡Œ: å¿« (æ¯«ç§’çº§)     â”‚
â”‚       â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”                        â”‚
â”‚                                                                             â”‚
â”‚  é»„é‡‘æ¯”ä¾‹: 70% å•å…ƒ : 20% é›†æˆ : 10% E2E                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å„å±‚æµ‹è¯•èŒè´£

| æµ‹è¯•å±‚ | èŒè´£ | ç‰¹ç‚¹ | å·¥å…· |
|--------|------|------|------|
| **å•å…ƒæµ‹è¯•** | æµ‹è¯•ç‹¬ç«‹å‡½æ•°ã€ç±»ã€æ–¹æ³• | å¿«é€Ÿã€éš”ç¦»ã€å¯é  | pytest, unittest |
| **é›†æˆæµ‹è¯•** | æµ‹è¯•æ¨¡å—é—´äº¤äº’ã€API | ä¸­ç­‰é€Ÿåº¦ã€éƒ¨åˆ†ä¾èµ– | pytest, httpx |
| **E2E æµ‹è¯•** | æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹ | æ…¢é€Ÿã€çœŸå®ç¯å¢ƒ | Playwright, Cypress |

---

## ä¸‰ã€æµ‹è¯•å·¥å…·é€‰å‹

### 3.1 åç«¯æµ‹è¯•å·¥å…·æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åç«¯æµ‹è¯•å·¥å…·æ ˆ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ ¸å¿ƒæµ‹è¯•æ¡†æ¶                                                        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  pytest              ä¸»æµ‹è¯•æ¡†æ¶ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œæ’ä»¶ç”Ÿæ€å®Œå–„               â”‚   â”‚
â”‚  â”‚  pytest-asyncio      å¼‚æ­¥æµ‹è¯•æ”¯æŒ                                   â”‚   â”‚
â”‚  â”‚  pytest-cov          è¦†ç›–ç‡ç»Ÿè®¡                                     â”‚   â”‚
â”‚  â”‚  pytest-xdist        å¹¶è¡Œæµ‹è¯•æ‰§è¡Œ                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Mock ä¸ Fixture                                                    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  pytest-mock         Mock å¯¹è±¡å°è£…                                  â”‚   â”‚
â”‚  â”‚  factory-boy         æµ‹è¯•æ•°æ®å·¥å‚                                   â”‚   â”‚
â”‚  â”‚  faker               å‡æ•°æ®ç”Ÿæˆ                                     â”‚   â”‚
â”‚  â”‚  responses           HTTP è¯·æ±‚ Mock                                 â”‚   â”‚
â”‚  â”‚  aioresponses        å¼‚æ­¥ HTTP Mock                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ•°æ®åº“æµ‹è¯•                                                          â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  testcontainers      Docker å®¹å™¨åŒ–æµ‹è¯•ç¯å¢ƒ                           â”‚   â”‚
â”‚  â”‚  pytest-postgresql   PostgreSQL æµ‹è¯•æ”¯æŒ                            â”‚   â”‚
â”‚  â”‚  SQLAlchemy          ORM æµ‹è¯•å·¥å…·                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API æµ‹è¯•                                                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  httpx               HTTP å®¢æˆ·ç«¯ (æ”¯æŒ async)                        â”‚   â”‚
â”‚  â”‚  TestClient          FastAPI å†…ç½®æµ‹è¯•å®¢æˆ·ç«¯                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å‰ç«¯æµ‹è¯•å·¥å…·æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯æµ‹è¯•å·¥å…·æ ˆ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å•å…ƒ/ç»„ä»¶æµ‹è¯•                                                       â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  Vitest              Vite åŸç”Ÿæµ‹è¯•æ¡†æ¶ï¼Œå¿«é€Ÿ                         â”‚   â”‚
â”‚  â”‚  @testing-library/react  React ç»„ä»¶æµ‹è¯•                             â”‚   â”‚
â”‚  â”‚  @testing-library/user-event  ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿ                          â”‚   â”‚
â”‚  â”‚  msw                 Mock Service Worker (API Mock)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  E2E æµ‹è¯•                                                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  Playwright          è·¨æµè§ˆå™¨ E2E æµ‹è¯•                               â”‚   â”‚
â”‚  â”‚  @playwright/test    Playwright æµ‹è¯•æ¡†æ¶                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¾…åŠ©å·¥å…·                                                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  @testing-library/jest-dom   DOM æ–­è¨€æ‰©å±•                           â”‚   â”‚
â”‚  â”‚  happy-dom           è½»é‡çº§ DOM å®ç°                                 â”‚   â”‚
â”‚  â”‚  c8                  è¦†ç›–ç‡ç»Ÿè®¡                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ä¾èµ–é…ç½®

```toml
# pyproject.toml - åç«¯æµ‹è¯•ä¾èµ–

[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
addopts = [
    "-v",
    "--tb=short",
    "--strict-markers",
    "-ra",
]
markers = [
    "unit: å•å…ƒæµ‹è¯•",
    "integration: é›†æˆæµ‹è¯•",
    "e2e: ç«¯åˆ°ç«¯æµ‹è¯•",
    "slow: æ…¢é€Ÿæµ‹è¯•",
    "llm: éœ€è¦ LLM API çš„æµ‹è¯•",
]

[tool.coverage.run]
source = ["backend"]
branch = true
omit = [
    "*/tests/*",
    "*/__pycache__/*",
    "*/migrations/*",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise NotImplementedError",
    "if TYPE_CHECKING:",
]
fail_under = 80
```

```json
// package.json - å‰ç«¯æµ‹è¯•ä¾èµ–

{
  "devDependencies": {
    "vitest": "^1.2.0",
    "@testing-library/react": "^14.1.0",
    "@testing-library/user-event": "^14.5.0",
    "@testing-library/jest-dom": "^6.2.0",
    "msw": "^2.0.0",
    "happy-dom": "^13.0.0",
    "@playwright/test": "^1.41.0",
    "@vitest/coverage-v8": "^1.2.0"
  },
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest --coverage",
    "test:e2e": "playwright test"
  }
}
```

---

## å››ã€æµ‹è¯•ç›®å½•ç»“æ„

### 4.1 åç«¯æµ‹è¯•ç›®å½•

```
backend/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                    # å…¨å±€ fixtures
â”‚   â”‚
â”‚   â”œâ”€â”€ unit/                          # å•å…ƒæµ‹è¯• (~70%)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ conftest.py                # å•å…ƒæµ‹è¯• fixtures
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ core/                      # Agent Core å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_token_counter.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_context_manager.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_tool_registry.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_tool_executor.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_memory_manager.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_memory_retriever.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_checkpointer.py
â”‚   â”‚   â”‚   â””â”€â”€ test_termination.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/                  # æœåŠ¡å±‚å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_code_validator.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_code_fixer.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_architecture_validator.py
â”‚   â”‚   â”‚   â””â”€â”€ test_lsp_proxy.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ studio/                    # å·¥ä½œå°å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_graph_parser.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_graph_codegen.py
â”‚   â”‚   â”‚   â””â”€â”€ test_workflow_converter.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/                     # å·¥å…·å‡½æ•°å•å…ƒæµ‹è¯•
â”‚   â”‚       â”œâ”€â”€ test_token.py
â”‚   â”‚       â””â”€â”€ test_helpers.py
â”‚   â”‚
â”‚   â”œâ”€â”€ integration/                   # é›†æˆæµ‹è¯• (~20%)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ conftest.py                # é›†æˆæµ‹è¯• fixtures (DB, Redis)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                       # API ç«¯ç‚¹æµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_chat_api.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_agent_api.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_session_api.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_studio_api.py
â”‚   â”‚   â”‚   â””â”€â”€ test_auth_api.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ db/                        # æ•°æ®åº“é›†æˆæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_user_repository.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_agent_repository.py
â”‚   â”‚   â”‚   â””â”€â”€ test_session_repository.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ services/                  # æœåŠ¡é›†æˆæµ‹è¯•
â”‚   â”‚       â”œâ”€â”€ test_agent_engine.py
â”‚   â”‚       â”œâ”€â”€ test_llm_gateway.py
â”‚   â”‚       â””â”€â”€ test_sandbox_executor.py
â”‚   â”‚
â”‚   â”œâ”€â”€ e2e/                           # ç«¯åˆ°ç«¯æµ‹è¯• (~10%)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ conftest.py
â”‚   â”‚   â”œâ”€â”€ test_chat_flow.py          # å®Œæ•´å¯¹è¯æµç¨‹
â”‚   â”‚   â”œâ”€â”€ test_tool_execution.py     # å·¥å…·æ‰§è¡Œæµç¨‹
â”‚   â”‚   â””â”€â”€ test_hitl_flow.py          # Human-in-the-Loop æµç¨‹
â”‚   â”‚
â”‚   â”œâ”€â”€ fixtures/                      # æµ‹è¯•æ•°æ®
â”‚   â”‚   â”œâ”€â”€ agents.py
â”‚   â”‚   â”œâ”€â”€ messages.py
â”‚   â”‚   â”œâ”€â”€ workflows.py
â”‚   â”‚   â””â”€â”€ sample_code/
â”‚   â”‚       â”œâ”€â”€ valid_agent.py
â”‚   â”‚       â””â”€â”€ invalid_agent.py
â”‚   â”‚
â”‚   â””â”€â”€ mocks/                         # Mock å¯¹è±¡
â”‚       â”œâ”€â”€ llm_mock.py
â”‚       â”œâ”€â”€ tool_mock.py
â”‚       â””â”€â”€ db_mock.py
```

### 4.2 å‰ç«¯æµ‹è¯•ç›®å½•

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatMessage.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ChatMessage.test.tsx   # ç»„ä»¶æµ‹è¯•ä¸ç»„ä»¶åŒç›®å½•
â”‚   â”‚   â””â”€â”€ workflow/
â”‚   â”‚       â”œâ”€â”€ WorkflowCanvas.tsx
â”‚   â”‚       â””â”€â”€ WorkflowCanvas.test.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”‚   â””â”€â”€ useChat.test.ts
â”‚   â”‚
â”‚   â””â”€â”€ stores/
â”‚       â”œâ”€â”€ chatStore.ts
â”‚       â””â”€â”€ chatStore.test.ts
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ setup.ts                       # æµ‹è¯•ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ mocks/
â”‚   â”‚   â”œâ”€â”€ handlers.ts                # MSW handlers
â”‚   â”‚   â””â”€â”€ server.ts                  # MSW server
â”‚   â”‚
â”‚   â””â”€â”€ e2e/                           # Playwright E2E æµ‹è¯•
â”‚       â”œâ”€â”€ chat.spec.ts
â”‚       â”œâ”€â”€ workflow.spec.ts
â”‚       â””â”€â”€ auth.spec.ts
â”‚
â””â”€â”€ playwright.config.ts
```

---

## äº”ã€æ¨¡å—æµ‹è¯•ç­–ç•¥

### 5.1 Agent Core æµ‹è¯•ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Agent Core æµ‹è¯•ç­–ç•¥                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LLM Gateway                                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  å•å…ƒæµ‹è¯• (Mock LLM API):                                            â”‚   â”‚
â”‚  â”‚  â€¢ è¯·æ±‚æ ¼å¼éªŒè¯                                                      â”‚   â”‚
â”‚  â”‚  â€¢ å“åº”è§£ææ­£ç¡®æ€§                                                    â”‚   â”‚
â”‚  â”‚  â€¢ æµå¼å“åº”å¤„ç†                                                      â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯å¤„ç†ä¸é‡è¯•                                                    â”‚   â”‚
â”‚  â”‚  â€¢ Token è®¡æ•°å‡†ç¡®æ€§                                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  é›†æˆæµ‹è¯• (çœŸå® API - å¯é€‰):                                          â”‚   â”‚
â”‚  â”‚  â€¢ çœŸå®æ¨¡å‹å“åº”                                                      â”‚   â”‚
â”‚  â”‚  â€¢ å»¶è¿Ÿä¸è¶…æ—¶å¤„ç†                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Context Manager                                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: ä¸¥æ ¼å•å…ƒæµ‹è¯•                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç”¨ä¾‹:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ ä¸Šä¸‹æ–‡ç»„è£…é¡ºåº (System â†’ Memory â†’ History â†’ Input)                â”‚   â”‚
â”‚  â”‚  â€¢ Token é¢„ç®—åˆ†é…                                                    â”‚   â”‚
â”‚  â”‚  â€¢ è£å‰ªç­–ç•¥ (æ»‘åŠ¨çª—å£ã€é‡è¦æ€§ç­›é€‰)                                   â”‚   â”‚
â”‚  â”‚  â€¢ è¾¹ç•Œæ¡ä»¶ (ç©ºå†å²ã€è¶…é•¿è¾“å…¥)                                       â”‚   â”‚
â”‚  â”‚  â€¢ æ‘˜è¦å‹ç¼©                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tool System                                                         â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  å•å…ƒæµ‹è¯•:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ å·¥å…·æ³¨å†Œä¸å‘ç°                                                    â”‚   â”‚
â”‚  â”‚  â€¢ å‚æ•°æ ¡éªŒ (JSON Schema)                                            â”‚   â”‚
â”‚  â”‚  â€¢ ç»“æœæ ¼å¼åŒ–ä¸æˆªæ–­                                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  å„å·¥å…·ç‹¬ç«‹æµ‹è¯•:                                                     â”‚   â”‚
â”‚  â”‚  â€¢ read_file: Mock æ–‡ä»¶ç³»ç»Ÿ                                          â”‚   â”‚
â”‚  â”‚  â€¢ write_file: ä¸´æ—¶ç›®å½•éªŒè¯                                          â”‚   â”‚
â”‚  â”‚  â€¢ run_shell: Mock subprocess                                        â”‚   â”‚
â”‚  â”‚  â€¢ web_search: Mock HTTP                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Agent Engine (Main Loop)                                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + E2E                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  å•å…ƒæµ‹è¯• (Mock æ‰€æœ‰ä¾èµ–):                                            â”‚   â”‚
â”‚  â”‚  â€¢ å¾ªç¯æ§åˆ¶é€»è¾‘                                                      â”‚   â”‚
â”‚  â”‚  â€¢ ç»ˆæ­¢æ¡ä»¶æ£€æŸ¥                                                      â”‚   â”‚
â”‚  â”‚  â€¢ äº‹ä»¶ç”Ÿæˆ                                                          â”‚   â”‚
â”‚  â”‚  â€¢ çŠ¶æ€è½¬æ¢                                                          â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  é›†æˆæµ‹è¯•:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ Context + LLM + Tools åä½œ                                        â”‚   â”‚
â”‚  â”‚  â€¢ æ£€æŸ¥ç‚¹ä¿å­˜ä¸æ¢å¤                                                  â”‚   â”‚
â”‚  â”‚  â€¢ HITL ä¸­æ–­ä¸æ¢å¤                                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  E2E æµ‹è¯•:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ å®Œæ•´å¯¹è¯æµç¨‹ (ç”¨æˆ·è¾“å…¥ â†’ å“åº”)                                    â”‚   â”‚
â”‚  â”‚  â€¢ å¤šè½®å·¥å…·è°ƒç”¨                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å·¥ä½œå°æµ‹è¯•ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·¥ä½œå°æµ‹è¯•ç­–ç•¥                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Code-First è§£æå™¨                                                   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: ä¸¥æ ¼å•å…ƒæµ‹è¯• (çº¯å‡½æ•°ï¼Œç¡®å®šæ€§)                              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç”¨ä¾‹:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ add_node è§£æ: graph.add_node("name", func) â†’ NodeDefinition     â”‚   â”‚
â”‚  â”‚  â€¢ add_edge è§£æ: graph.add_edge("a", "b") â†’ EdgeDefinition         â”‚   â”‚
â”‚  â”‚  â€¢ conditional_edges è§£æ                                            â”‚   â”‚
â”‚  â”‚  â€¢ StateGraph è¯†åˆ«                                                   â”‚   â”‚
â”‚  â”‚  â€¢ React Flow æ ¼å¼è½¬æ¢                                               â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯å¤„ç† (è¯­æ³•é”™è¯¯ã€ä¸æ”¯æŒçš„æ¨¡å¼)                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•æ•°æ®: fixtures/sample_code/ ä¸­çš„ç¤ºä¾‹æ–‡ä»¶                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Code-First ç”Ÿæˆå™¨                                                   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: ä¸¥æ ¼å•å…ƒæµ‹è¯•                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç”¨ä¾‹:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ æ·»åŠ èŠ‚ç‚¹ â†’ æ­£ç¡®çš„ä»£ç æ’å…¥ä½ç½®                                     â”‚   â”‚
â”‚  â”‚  â€¢ æ·»åŠ è¾¹ â†’ æ­£ç¡®çš„ä»£ç ç”Ÿæˆ                                           â”‚   â”‚
â”‚  â”‚  â€¢ åˆ é™¤èŠ‚ç‚¹ â†’ AST æ­£ç¡®ç§»é™¤                                           â”‚   â”‚
â”‚  â”‚  â€¢ ä¿ç•™æ ¼å¼å’Œæ³¨é‡Š                                                    â”‚   â”‚
â”‚  â”‚  â€¢ è§£æ â†’ ç”Ÿæˆ â†’ è§£æ çš„å¾€è¿”ä¸€è‡´æ€§                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  TestRunner                                                          â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: é›†æˆæµ‹è¯•                                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç”¨ä¾‹:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ å·¥ä½œæµåŠ è½½ä¸è½¬æ¢                                                  â”‚   â”‚
â”‚  â”‚  â€¢ æµ‹è¯•æ‰§è¡Œä¸äº‹ä»¶æµ                                                  â”‚   â”‚
â”‚  â”‚  â€¢ è¿½è¸ªäº‹ä»¶ç”Ÿæˆ                                                      â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯å¤„ç†                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä»£ç è´¨é‡ç³»ç»Ÿæµ‹è¯•ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä»£ç è´¨é‡ç³»ç»Ÿæµ‹è¯•ç­–ç•¥                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CodeValidator                                                       â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• (æ¯ç§æ£€æŸ¥ç‹¬ç«‹æµ‹è¯•)                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  è¯­æ³•æ£€æŸ¥æµ‹è¯•:                                                       â”‚   â”‚
â”‚  â”‚  â€¢ æœ‰æ•ˆä»£ç  â†’ æ— é”™è¯¯                                                 â”‚   â”‚
â”‚  â”‚  â€¢ è¯­æ³•é”™è¯¯ â†’ æ­£ç¡®å®šä½è¡Œå·                                           â”‚   â”‚
â”‚  â”‚  â€¢ ç¼©è¿›é”™è¯¯ â†’ æ­£ç¡®æ£€æµ‹                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  ç±»å‹æ£€æŸ¥æµ‹è¯•:                                                       â”‚   â”‚
â”‚  â”‚  â€¢ ç±»å‹åŒ¹é… â†’ é€šè¿‡                                                   â”‚   â”‚
â”‚  â”‚  â€¢ ç±»å‹ä¸åŒ¹é… â†’ é”™è¯¯                                                 â”‚   â”‚
â”‚  â”‚  â€¢ ç¼ºå°‘ç±»å‹æ³¨è§£ â†’ è­¦å‘Š                                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æ¶æ„è§„èŒƒæµ‹è¯•:                                                       â”‚   â”‚
â”‚  â”‚  â€¢ Agent æœªç»§æ‰¿ BaseAgent â†’ ARCH001                                  â”‚   â”‚
â”‚  â”‚  â€¢ Tool æœªå®ç° execute â†’ ARCH002                                     â”‚   â”‚
â”‚  â”‚  â€¢ ä½¿ç”¨ eval â†’ SEC001                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CodeFixer                                                           â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  å•å…ƒæµ‹è¯• (Mock LLM):                                                 â”‚   â”‚
â”‚  â”‚  â€¢ ä¿®å¤æç¤ºæ„å»º                                                      â”‚   â”‚
â”‚  â”‚  â€¢ ä»£ç æå–                                                          â”‚   â”‚
â”‚  â”‚  â€¢ ä¿®å¤å¾ªç¯é€»è¾‘                                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  é›†æˆæµ‹è¯•:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ ç®€å•é”™è¯¯ä¿®å¤                                                      â”‚   â”‚
â”‚  â”‚  â€¢ å¤šæ¬¡å°è¯•                                                          â”‚   â”‚
â”‚  â”‚  â€¢ ä¸å¯ä¿®å¤ä»£ç å¤„ç†                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SandboxExecutor                                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç±»å‹: é›†æˆæµ‹è¯• (éœ€è¦ Docker)                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æµ‹è¯•ç”¨ä¾‹:                                                           â”‚   â”‚
â”‚  â”‚  â€¢ æ­£å¸¸ä»£ç æ‰§è¡Œ                                                      â”‚   â”‚
â”‚  â”‚  â€¢ è¶…æ—¶å¤„ç†                                                          â”‚   â”‚
â”‚  â”‚  â€¢ å†…å­˜é™åˆ¶                                                          â”‚   â”‚
â”‚  â”‚  â€¢ ç½‘ç»œéš”ç¦»éªŒè¯                                                      â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯æ•è·                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€æµ‹è¯•ä»£ç ç¤ºä¾‹

### 6.1 å•å…ƒæµ‹è¯•ç¤ºä¾‹

```python
# tests/unit/core/test_context_manager.py

import pytest
from unittest.mock import AsyncMock, MagicMock

from backend.core.agent.context import ContextManager, ContextConfig, Context
from backend.core.types import Message, MessageRole


class TestContextManager:
    """ä¸Šä¸‹æ–‡ç®¡ç†å™¨å•å…ƒæµ‹è¯•"""
    
    @pytest.fixture
    def config(self):
        """æµ‹è¯•é…ç½®"""
        return ContextConfig(
            max_tokens=1000,
            system_prompt_tokens=100,
            output_tokens=200,
            recent_messages=5,
            memory_tokens=200
        )
    
    @pytest.fixture
    def mock_memory_retriever(self):
        """Mock è®°å¿†æ£€ç´¢å™¨"""
        retriever = AsyncMock()
        retriever.retrieve.return_value = []
        return retriever
    
    @pytest.fixture
    def mock_token_counter(self):
        """Mock Token è®¡æ•°å™¨"""
        counter = MagicMock()
        counter.count.return_value = 10
        counter.count_messages.return_value = 50
        return counter
    
    @pytest.fixture
    def context_manager(self, config, mock_memory_retriever, mock_token_counter):
        """åˆ›å»ºè¢«æµ‹å¯¹è±¡"""
        return ContextManager(
            config=config,
            memory_retriever=mock_memory_retriever,
            token_counter=mock_token_counter
        )
    
    # ========================================================================
    # æµ‹è¯•ç”¨ä¾‹
    # ========================================================================
    
    @pytest.mark.asyncio
    async def test_build_includes_system_prompt(self, context_manager):
        """æµ‹è¯•: æ„å»ºçš„ä¸Šä¸‹æ–‡åŒ…å«ç³»ç»Ÿæç¤º"""
        # Arrange
        system_prompt = "You are a helpful assistant."
        
        # Act
        result = await context_manager.build(
            session_id="test-session",
            user_input="Hello",
            system_prompt=system_prompt
        )
        
        # Assert
        assert result.messages[0]["role"] == "system"
        assert result.messages[0]["content"] == system_prompt
    
    @pytest.mark.asyncio
    async def test_build_includes_user_input(self, context_manager):
        """æµ‹è¯•: æ„å»ºçš„ä¸Šä¸‹æ–‡åŒ…å«ç”¨æˆ·è¾“å…¥"""
        # Act
        result = await context_manager.build(
            session_id="test-session",
            user_input="Hello world",
            system_prompt="System"
        )
        
        # Assert
        user_messages = [m for m in result.messages if m["role"] == "user"]
        assert len(user_messages) >= 1
        assert user_messages[-1]["content"] == "Hello world"
    
    @pytest.mark.asyncio
    async def test_build_respects_token_budget(self, context_manager, mock_token_counter):
        """æµ‹è¯•: Token é¢„ç®—é™åˆ¶"""
        # Arrange
        mock_token_counter.count.return_value = 500  # æ¯æ¡æ¶ˆæ¯ 500 tokens
        
        # Act
        result = await context_manager.build(
            session_id="test-session",
            user_input="Test",
            system_prompt="System"
        )
        
        # Assert
        # é¢„ç®— = 1000 - 200(è¾“å‡º) = 800
        # ç³»ç»Ÿæç¤ºå›ºå®šåŒ…å«ï¼Œæ€» token ä¸åº”å¤§å¹…è¶…å‡ºé¢„ç®—
        assert result.total_tokens <= 1200  # å…è®¸ä¸€å®šè¯¯å·®
    
    @pytest.mark.asyncio
    async def test_build_retrieves_memory_when_user_input_provided(
        self, 
        context_manager, 
        mock_memory_retriever
    ):
        """æµ‹è¯•: æœ‰ç”¨æˆ·è¾“å…¥æ—¶æ£€ç´¢è®°å¿†"""
        # Act
        await context_manager.build(
            session_id="test-session",
            user_input="What did we discuss?",
            system_prompt="System"
        )
        
        # Assert
        mock_memory_retriever.retrieve.assert_called_once()
    
    @pytest.mark.asyncio
    async def test_build_skips_memory_when_no_user_input(
        self, 
        context_manager, 
        mock_memory_retriever
    ):
        """æµ‹è¯•: æ— ç”¨æˆ·è¾“å…¥æ—¶è·³è¿‡è®°å¿†æ£€ç´¢"""
        # Act
        await context_manager.build(
            session_id="test-session",
            user_input=None,
            system_prompt="System"
        )
        
        # Assert
        mock_memory_retriever.retrieve.assert_not_called()
    
    @pytest.mark.asyncio
    async def test_build_empty_history_returns_valid_context(self, context_manager):
        """æµ‹è¯•: ç©ºå†å²è®°å½•è¿”å›æœ‰æ•ˆä¸Šä¸‹æ–‡"""
        # Act
        result = await context_manager.build(
            session_id="new-session",
            user_input="First message",
            system_prompt="System"
        )
        
        # Assert
        assert isinstance(result, Context)
        assert len(result.messages) >= 2  # è‡³å°‘æœ‰ system å’Œ user
        assert result.truncated is False
```

### 6.2 LLM Mock æµ‹è¯•ç¤ºä¾‹

```python
# tests/unit/core/test_llm_gateway.py

import pytest
from unittest.mock import AsyncMock, patch
import json

from backend.core.llm.gateway import LLMGateway, LLMConfig
from backend.core.types import Message, MessageRole, ToolCall


class MockLLMResponse:
    """Mock LLM å“åº”"""
    
    def __init__(self, content: str = "", tool_calls: list = None):
        self.choices = [
            MockChoice(content=content, tool_calls=tool_calls)
        ]
        self.usage = MockUsage(prompt_tokens=10, completion_tokens=20)


class MockChoice:
    def __init__(self, content: str, tool_calls: list = None):
        self.message = MockMessage(content=content, tool_calls=tool_calls)
        self.delta = self.message  # ç”¨äºæµå¼


class MockMessage:
    def __init__(self, content: str, tool_calls: list = None):
        self.content = content
        self.tool_calls = tool_calls


class MockUsage:
    def __init__(self, prompt_tokens: int, completion_tokens: int):
        self.prompt_tokens = prompt_tokens
        self.completion_tokens = completion_tokens


class TestLLMGateway:
    """LLM Gateway æµ‹è¯•"""
    
    @pytest.fixture
    def gateway(self):
        """åˆ›å»ºè¢«æµ‹å¯¹è±¡"""
        return LLMGateway(
            config=LLMConfig(
                default_model="gpt-4",
                api_key="test-key"
            )
        )
    
    @pytest.mark.asyncio
    async def test_chat_returns_text_response(self, gateway):
        """æµ‹è¯•: è¿”å›æ–‡æœ¬å“åº”"""
        # Arrange
        mock_response = MockLLMResponse(content="Hello, how can I help?")
        
        with patch.object(gateway, '_call_api', return_value=mock_response):
            # Act
            result = await gateway.chat(
                messages=[{"role": "user", "content": "Hi"}],
                model="gpt-4"
            )
            
            # Assert
            assert result.content == "Hello, how can I help?"
            assert result.tool_calls is None
    
    @pytest.mark.asyncio
    async def test_chat_parses_tool_calls(self, gateway):
        """æµ‹è¯•: è§£æå·¥å…·è°ƒç”¨"""
        # Arrange
        mock_tool_call = MagicMock()
        mock_tool_call.id = "call_123"
        mock_tool_call.function.name = "read_file"
        mock_tool_call.function.arguments = '{"path": "/tmp/test.txt"}'
        
        mock_response = MockLLMResponse(
            content="",
            tool_calls=[mock_tool_call]
        )
        
        with patch.object(gateway, '_call_api', return_value=mock_response):
            # Act
            result = await gateway.chat(
                messages=[{"role": "user", "content": "Read the file"}],
                model="gpt-4",
                tools=[{"type": "function", "function": {"name": "read_file"}}]
            )
            
            # Assert
            assert len(result.tool_calls) == 1
            assert result.tool_calls[0].name == "read_file"
            assert result.tool_calls[0].arguments["path"] == "/tmp/test.txt"
    
    @pytest.mark.asyncio
    async def test_chat_handles_api_error(self, gateway):
        """æµ‹è¯•: API é”™è¯¯å¤„ç†"""
        # Arrange
        with patch.object(gateway, '_call_api', side_effect=Exception("API Error")):
            # Act & Assert
            with pytest.raises(Exception) as exc_info:
                await gateway.chat(
                    messages=[{"role": "user", "content": "Hi"}],
                    model="gpt-4"
                )
            
            assert "API Error" in str(exc_info.value)
    
    @pytest.mark.asyncio
    async def test_chat_with_streaming(self, gateway):
        """æµ‹è¯•: æµå¼å“åº”"""
        # Arrange
        async def mock_stream():
            chunks = [
                MockLLMResponse(content="Hello"),
                MockLLMResponse(content=" world"),
                MockLLMResponse(content="!"),
            ]
            for chunk in chunks:
                yield chunk
        
        with patch.object(gateway, '_call_api_stream', return_value=mock_stream()):
            # Act
            full_content = ""
            async for chunk in gateway.chat_stream(
                messages=[{"role": "user", "content": "Hi"}],
                model="gpt-4"
            ):
                full_content += chunk.content
            
            # Assert
            assert full_content == "Hello world!"
```

### 6.3 é›†æˆæµ‹è¯•ç¤ºä¾‹

```python
# tests/integration/api/test_chat_api.py

import pytest
from httpx import AsyncClient
from fastapi import status

from backend.app.main import app
from tests.fixtures.agents import create_test_agent
from tests.fixtures.users import create_test_user


class TestChatAPI:
    """Chat API é›†æˆæµ‹è¯•"""
    
    @pytest.fixture
    async def client(self):
        """å¼‚æ­¥æµ‹è¯•å®¢æˆ·ç«¯"""
        async with AsyncClient(app=app, base_url="http://test") as client:
            yield client
    
    @pytest.fixture
    async def auth_headers(self, client):
        """è®¤è¯å¤´"""
        user = await create_test_user()
        response = await client.post("/api/v1/auth/login", json={
            "email": user.email,
            "password": "testpassword"
        })
        token = response.json()["access_token"]
        return {"Authorization": f"Bearer {token}"}
    
    @pytest.fixture
    async def test_agent(self, auth_headers):
        """æµ‹è¯• Agent"""
        return await create_test_agent(user_id="test-user")
    
    @pytest.mark.asyncio
    async def test_chat_returns_sse_stream(self, client, auth_headers, test_agent):
        """æµ‹è¯•: è¿”å› SSE æµ"""
        # Act
        response = await client.post(
            "/api/v1/chat",
            json={
                "session_id": "test-session",
                "message": "Hello",
                "agent_id": test_agent.id
            },
            headers=auth_headers
        )
        
        # Assert
        assert response.status_code == status.HTTP_200_OK
        assert response.headers["content-type"] == "text/event-stream"
    
    @pytest.mark.asyncio
    async def test_chat_requires_authentication(self, client):
        """æµ‹è¯•: éœ€è¦è®¤è¯"""
        # Act
        response = await client.post(
            "/api/v1/chat",
            json={
                "session_id": "test-session",
                "message": "Hello"
            }
        )
        
        # Assert
        assert response.status_code == status.HTTP_401_UNAUTHORIZED
    
    @pytest.mark.asyncio
    async def test_chat_validates_request_body(self, client, auth_headers):
        """æµ‹è¯•: è¯·æ±‚ä½“éªŒè¯"""
        # Act
        response = await client.post(
            "/api/v1/chat",
            json={
                "session_id": "",  # ç©ºå­—ç¬¦ä¸²
                "message": "Hello"
            },
            headers=auth_headers
        )
        
        # Assert
        assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
```

### 6.4 å‰ç«¯ç»„ä»¶æµ‹è¯•ç¤ºä¾‹

```typescript
// src/components/chat/ChatMessage.test.tsx

import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { ChatMessage } from './ChatMessage';

describe('ChatMessage', () => {
  describe('ç”¨æˆ·æ¶ˆæ¯', () => {
    it('åº”è¯¥æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯å†…å®¹', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="user"
          content="Hello, how are you?"
        />
      );
      
      // Assert
      expect(screen.getByText('Hello, how are you?')).toBeInTheDocument();
    });
    
    it('åº”è¯¥æ˜¾ç¤ºç”¨æˆ·å¤´åƒ', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="user"
          content="Test message"
        />
      );
      
      // Assert
      expect(screen.getByTestId('user-avatar')).toBeInTheDocument();
    });
  });
  
  describe('åŠ©æ‰‹æ¶ˆæ¯', () => {
    it('åº”è¯¥æ¸²æŸ“åŠ©æ‰‹æ¶ˆæ¯å†…å®¹', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="assistant"
          content="I'm doing well, thank you!"
        />
      );
      
      // Assert
      expect(screen.getByText("I'm doing well, thank you!")).toBeInTheDocument();
    });
    
    it('åº”è¯¥æ¸²æŸ“ Markdown å†…å®¹', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="assistant"
          content="Here is some **bold** text"
        />
      );
      
      // Assert
      const boldElement = screen.getByText('bold');
      expect(boldElement.tagName).toBe('STRONG');
    });
    
    it('åº”è¯¥æ¸²æŸ“ä»£ç å—', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="assistant"
          content={'```python\nprint("hello")\n```'}
        />
      );
      
      // Assert
      expect(screen.getByText('print("hello")')).toBeInTheDocument();
    });
  });
  
  describe('å·¥å…·è°ƒç”¨', () => {
    it('åº”è¯¥æ¸²æŸ“å·¥å…·è°ƒç”¨ä¿¡æ¯', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="assistant"
          content=""
          toolCalls={[
            {
              id: 'call_123',
              name: 'read_file',
              arguments: { path: '/tmp/test.txt' }
            }
          ]}
        />
      );
      
      // Assert
      expect(screen.getByText('read_file')).toBeInTheDocument();
      expect(screen.getByText('/tmp/test.txt')).toBeInTheDocument();
    });
  });
  
  describe('åŠ è½½çŠ¶æ€', () => {
    it('åº”è¯¥æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨', () => {
      // Arrange & Act
      render(
        <ChatMessage
          role="assistant"
          content=""
          isLoading={true}
        />
      );
      
      // Assert
      expect(screen.getByTestId('loading-indicator')).toBeInTheDocument();
    });
  });
});
```

### 6.5 E2E æµ‹è¯•ç¤ºä¾‹

```typescript
// tests/e2e/chat.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Chat Flow', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å½•
    await page.goto('/login');
    await page.fill('[data-testid="email-input"]', 'test@example.com');
    await page.fill('[data-testid="password-input"]', 'password123');
    await page.click('[data-testid="login-button"]');
    
    // ç­‰å¾…ç™»å½•å®Œæˆ
    await page.waitForURL('/chat');
  });
  
  test('ç”¨æˆ·å¯ä»¥å‘é€æ¶ˆæ¯å¹¶æ”¶åˆ°å“åº”', async ({ page }) => {
    // Arrange
    await page.goto('/chat');
    
    // Act
    await page.fill('[data-testid="chat-input"]', 'Hello, what can you do?');
    await page.click('[data-testid="send-button"]');
    
    // Assert
    // ç­‰å¾…ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤º
    await expect(page.locator('[data-testid="user-message"]').last())
      .toContainText('Hello, what can you do?');
    
    // ç­‰å¾…åŠ©æ‰‹å“åº” (æœ€å¤š 30 ç§’)
    await expect(page.locator('[data-testid="assistant-message"]').last())
      .toBeVisible({ timeout: 30000 });
  });
  
  test('ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å·¥å…·è°ƒç”¨è¯¦æƒ…', async ({ page }) => {
    // Arrange
    await page.goto('/chat');
    
    // Act - å‘é€éœ€è¦å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯
    await page.fill('[data-testid="chat-input"]', 'Read the file /etc/hostname');
    await page.click('[data-testid="send-button"]');
    
    // Assert - æ£€æŸ¥å·¥å…·è°ƒç”¨å±•ç¤º
    await expect(page.locator('[data-testid="tool-call"]'))
      .toBeVisible({ timeout: 30000 });
    
    await expect(page.locator('[data-testid="tool-call"]'))
      .toContainText('read_file');
  });
  
  test('æ¶ˆæ¯å†å²åœ¨é¡µé¢åˆ·æ–°åä¿ç•™', async ({ page }) => {
    // Arrange
    await page.goto('/chat');
    await page.fill('[data-testid="chat-input"]', 'Remember this: test123');
    await page.click('[data-testid="send-button"]');
    
    // ç­‰å¾…å“åº”
    await expect(page.locator('[data-testid="assistant-message"]').last())
      .toBeVisible({ timeout: 30000 });
    
    // Act - åˆ·æ–°é¡µé¢
    await page.reload();
    
    // Assert - æ¶ˆæ¯ä»ç„¶å­˜åœ¨
    await expect(page.locator('[data-testid="user-message"]'))
      .toContainText('Remember this: test123');
  });
});
```

---

## ä¸ƒã€Fixtures ä¸ Mock ç­–ç•¥

### 7.1 å…¨å±€ Fixtures

```python
# tests/conftest.py

import pytest
import asyncio
from typing import AsyncGenerator
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import sessionmaker

from backend.app.config import settings
from backend.db.database import Base


@pytest.fixture(scope="session")
def event_loop():
    """åˆ›å»ºäº‹ä»¶å¾ªç¯"""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()


@pytest.fixture(scope="session")
async def db_engine():
    """æµ‹è¯•æ•°æ®åº“å¼•æ“"""
    engine = create_async_engine(
        settings.test_database_url,
        echo=False
    )
    
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    yield engine
    
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
    
    await engine.dispose()


@pytest.fixture
async def db_session(db_engine) -> AsyncGenerator[AsyncSession, None]:
    """æ•°æ®åº“ä¼šè¯ (æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹äº‹åŠ¡)"""
    async_session = sessionmaker(
        db_engine, 
        class_=AsyncSession, 
        expire_on_commit=False
    )
    
    async with async_session() as session:
        async with session.begin():
            yield session
            await session.rollback()  # å›æ»šï¼Œä¸å½±å“å…¶ä»–æµ‹è¯•


@pytest.fixture
def mock_llm_gateway():
    """Mock LLM Gateway"""
    from unittest.mock import AsyncMock
    
    gateway = AsyncMock()
    gateway.chat.return_value = MockLLMResponse(content="Mock response")
    gateway.chat_stream.return_value = mock_stream_response()
    
    return gateway


async def mock_stream_response():
    """Mock æµå¼å“åº”"""
    chunks = ["Hello", " ", "world", "!"]
    for chunk in chunks:
        yield MockStreamChunk(content=chunk)


@pytest.fixture
def mock_tool_executor():
    """Mock å·¥å…·æ‰§è¡Œå™¨"""
    from unittest.mock import AsyncMock
    from backend.core.types import ToolResult
    
    executor = AsyncMock()
    executor.execute.return_value = ToolResult(
        tool_call_id="test-call",
        success=True,
        result="Mock tool result",
        duration_ms=100
    )
    
    return executor
```

### 7.2 æµ‹è¯•æ•°æ®å·¥å‚

```python
# tests/fixtures/factories.py

import factory
from factory.alchemy import SQLAlchemyModelFactory
from datetime import datetime

from backend.models.user import User
from backend.models.agent import Agent
from backend.models.session import Session
from backend.models.message import Message


class UserFactory(SQLAlchemyModelFactory):
    """ç”¨æˆ·æ•°æ®å·¥å‚"""
    
    class Meta:
        model = User
        sqlalchemy_session = None  # è¿è¡Œæ—¶æ³¨å…¥
    
    id = factory.Faker('uuid4')
    email = factory.Faker('email')
    name = factory.Faker('name')
    password_hash = "hashed_password"
    created_at = factory.LazyFunction(datetime.utcnow)


class AgentFactory(SQLAlchemyModelFactory):
    """Agent æ•°æ®å·¥å‚"""
    
    class Meta:
        model = Agent
        sqlalchemy_session = None
    
    id = factory.Faker('uuid4')
    user_id = factory.LazyAttribute(lambda obj: UserFactory().id)
    name = factory.Faker('word')
    system_prompt = "You are a helpful assistant."
    model = "gpt-4"
    tools = []
    config = {"temperature": 0.7}


class SessionFactory(SQLAlchemyModelFactory):
    """ä¼šè¯æ•°æ®å·¥å‚"""
    
    class Meta:
        model = Session
        sqlalchemy_session = None
    
    id = factory.Faker('uuid4')
    user_id = factory.LazyAttribute(lambda obj: UserFactory().id)
    agent_id = factory.LazyAttribute(lambda obj: AgentFactory().id)
    status = "active"


class MessageFactory(SQLAlchemyModelFactory):
    """æ¶ˆæ¯æ•°æ®å·¥å‚"""
    
    class Meta:
        model = Message
        sqlalchemy_session = None
    
    id = factory.Faker('uuid4')
    session_id = factory.LazyAttribute(lambda obj: SessionFactory().id)
    role = "user"
    content = factory.Faker('sentence')


# ä¾¿æ·å‡½æ•°
async def create_test_user(db_session, **kwargs):
    """åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
    UserFactory._meta.sqlalchemy_session = db_session
    user = UserFactory(**kwargs)
    db_session.add(user)
    await db_session.flush()
    return user


async def create_test_agent(db_session, user_id, **kwargs):
    """åˆ›å»ºæµ‹è¯• Agent"""
    AgentFactory._meta.sqlalchemy_session = db_session
    agent = AgentFactory(user_id=user_id, **kwargs)
    db_session.add(agent)
    await db_session.flush()
    return agent
```

### 7.3 LLM Mock ç­–ç•¥

```python
# tests/mocks/llm_mock.py

from typing import AsyncIterator
from dataclasses import dataclass
from unittest.mock import AsyncMock

from backend.core.types import ToolCall


@dataclass
class MockLLMChunk:
    """Mock LLM æµå¼å—"""
    content: str = ""
    tool_calls: list[ToolCall] | None = None
    finish_reason: str | None = None


class LLMMockBuilder:
    """LLM Mock æ„å»ºå™¨"""
    
    def __init__(self):
        self.responses = []
        self.stream_chunks = []
    
    def with_text_response(self, content: str) -> "LLMMockBuilder":
        """æ·»åŠ æ–‡æœ¬å“åº”"""
        self.responses.append({"type": "text", "content": content})
        return self
    
    def with_tool_call(
        self, 
        name: str, 
        arguments: dict,
        call_id: str = "call_123"
    ) -> "LLMMockBuilder":
        """æ·»åŠ å·¥å…·è°ƒç”¨"""
        self.responses.append({
            "type": "tool_call",
            "tool_call": ToolCall(id=call_id, name=name, arguments=arguments)
        })
        return self
    
    def with_stream(self, chunks: list[str]) -> "LLMMockBuilder":
        """æ·»åŠ æµå¼å—"""
        self.stream_chunks = chunks
        return self
    
    def build(self) -> AsyncMock:
        """æ„å»º Mock å¯¹è±¡"""
        mock = AsyncMock()
        
        # æ™®é€šå“åº”
        if self.responses:
            mock.chat.return_value = self._build_response()
        
        # æµå¼å“åº”
        if self.stream_chunks:
            mock.chat_stream.return_value = self._stream_generator()
        
        return mock
    
    def _build_response(self):
        """æ„å»ºå“åº”å¯¹è±¡"""
        response = AsyncMock()
        
        if self.responses[0]["type"] == "text":
            response.content = self.responses[0]["content"]
            response.tool_calls = None
        else:
            response.content = ""
            response.tool_calls = [r["tool_call"] for r in self.responses if r["type"] == "tool_call"]
        
        return response
    
    async def _stream_generator(self) -> AsyncIterator[MockLLMChunk]:
        """æµå¼ç”Ÿæˆå™¨"""
        for chunk in self.stream_chunks:
            yield MockLLMChunk(content=chunk)
        yield MockLLMChunk(finish_reason="stop")


# ä½¿ç”¨ç¤ºä¾‹
def create_simple_response_mock(content: str) -> AsyncMock:
    """åˆ›å»ºç®€å•æ–‡æœ¬å“åº” Mock"""
    return (
        LLMMockBuilder()
        .with_text_response(content)
        .build()
    )


def create_tool_call_mock(tool_name: str, arguments: dict) -> AsyncMock:
    """åˆ›å»ºå·¥å…·è°ƒç”¨ Mock"""
    return (
        LLMMockBuilder()
        .with_tool_call(tool_name, arguments)
        .build()
    )
```

---

## å…«ã€CI/CD æµ‹è¯•é›†æˆ

### 8.1 GitHub Actions é…ç½®

```yaml
# .github/workflows/test.yml

name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ========================================
  # åç«¯æµ‹è¯•
  # ========================================
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt -r requirements-dev.txt
      
      - name: Run type checking
        run: |
          cd backend
          pyright
      
      - name: Run linting
        run: |
          cd backend
          ruff check .
      
      - name: Run unit tests
        run: |
          cd backend
          pytest tests/unit -v --cov=backend --cov-report=xml -m "not slow"
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379/0
      
      - name: Run integration tests
        run: |
          cd backend
          pytest tests/integration -v --cov=backend --cov-report=xml --cov-append
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379/0
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: backend/coverage.xml
          flags: backend
  
  # ========================================
  # å‰ç«¯æµ‹è¯•
  # ========================================
  frontend-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install
      
      - name: Run type checking
        run: |
          cd frontend
          pnpm tsc --noEmit
      
      - name: Run linting
        run: |
          cd frontend
          pnpm lint
      
      - name: Run unit tests
        run: |
          cd frontend
          pnpm test:coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: frontend/coverage/lcov.info
          flags: frontend
  
  # ========================================
  # E2E æµ‹è¯•
  # ========================================
  e2e-test:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]  # ä¾èµ–å•å…ƒæµ‹è¯•é€šè¿‡
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        run: |
          docker compose -f deploy/docker/docker-compose.test.yml up -d
      
      - name: Wait for services
        run: |
          sleep 30
          curl --retry 10 --retry-delay 5 http://localhost:8000/api/v1/health
      
      - name: Install Playwright
        run: |
          cd frontend
          pnpm install
          pnpm exec playwright install --with-deps
      
      - name: Run E2E tests
        run: |
          cd frontend
          pnpm test:e2e
      
      - name: Upload E2E report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: frontend/playwright-report/
      
      - name: Cleanup
        run: |
          docker compose -f deploy/docker/docker-compose.test.yml down -v
```

### 8.2 æµ‹è¯•æŠ¥å‘Šä¸è¦†ç›–ç‡

```yaml
# .github/workflows/test.yml (ç»­)

  # ========================================
  # è¦†ç›–ç‡æ£€æŸ¥
  # ========================================
  coverage-check:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: coverage/
      
      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: coverage/
      
      - name: Check coverage threshold
        run: |
          # æ£€æŸ¥åç«¯è¦†ç›–ç‡ >= 80%
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage/backend-coverage.xml')
          rate = float(tree.getroot().get('line-rate', 0))
          print(f'Backend coverage: {rate * 100:.1f}%')
          assert rate >= 0.8, f'Backend coverage {rate*100:.1f}% < 80%'
          "
          
          # å‰ç«¯è¦†ç›–ç‡æ£€æŸ¥ç±»ä¼¼
```

---

## ä¹ã€ç‰¹æ®Šåœºæ™¯æµ‹è¯•

### 9.1 å¼‚æ­¥ä»£ç æµ‹è¯•

```python
# å¼‚æ­¥æµ‹è¯•æœ€ä½³å®è·µ

import pytest
import asyncio
from unittest.mock import AsyncMock


class TestAsyncCode:
    """å¼‚æ­¥ä»£ç æµ‹è¯•"""
    
    @pytest.mark.asyncio
    async def test_async_function(self):
        """æµ‹è¯•å¼‚æ­¥å‡½æ•°"""
        result = await some_async_function()
        assert result == expected
    
    @pytest.mark.asyncio
    async def test_async_generator(self):
        """æµ‹è¯•å¼‚æ­¥ç”Ÿæˆå™¨"""
        results = []
        async for item in some_async_generator():
            results.append(item)
        
        assert len(results) == expected_count
    
    @pytest.mark.asyncio
    async def test_concurrent_execution(self):
        """æµ‹è¯•å¹¶å‘æ‰§è¡Œ"""
        results = await asyncio.gather(
            task1(),
            task2(),
            task3()
        )
        
        assert all(r.success for r in results)
    
    @pytest.mark.asyncio
    async def test_timeout_handling(self):
        """æµ‹è¯•è¶…æ—¶å¤„ç†"""
        with pytest.raises(asyncio.TimeoutError):
            await asyncio.wait_for(
                slow_function(),
                timeout=1.0
            )
    
    @pytest.mark.asyncio
    async def test_with_mock_async(self):
        """ä½¿ç”¨ AsyncMock"""
        mock_service = AsyncMock()
        mock_service.fetch_data.return_value = {"key": "value"}
        
        result = await mock_service.fetch_data("test")
        
        assert result["key"] == "value"
        mock_service.fetch_data.assert_called_once_with("test")
```

### 9.2 SSE æµæµ‹è¯•

```python
# tests/integration/api/test_sse_stream.py

import pytest
from httpx import AsyncClient
import json


class TestSSEStream:
    """SSE æµå¼å“åº”æµ‹è¯•"""
    
    @pytest.mark.asyncio
    async def test_chat_sse_stream(self, client: AsyncClient, auth_headers):
        """æµ‹è¯• Chat SSE æµ"""
        async with client.stream(
            "POST",
            "/api/v1/chat",
            json={"session_id": "test", "message": "Hi"},
            headers=auth_headers
        ) as response:
            events = []
            
            async for line in response.aiter_lines():
                if line.startswith("data:"):
                    data = json.loads(line[5:])
                    events.append(data)
            
            # éªŒè¯äº‹ä»¶åºåˆ—
            event_types = [e["type"] for e in events]
            
            assert "thinking" in event_types
            assert "text" in event_types or "tool_call" in event_types
            assert event_types[-1] == "done"
    
    @pytest.mark.asyncio
    async def test_stream_error_handling(self, client: AsyncClient, auth_headers):
        """æµ‹è¯•æµé”™è¯¯å¤„ç†"""
        async with client.stream(
            "POST",
            "/api/v1/chat",
            json={"session_id": "test", "message": "trigger_error"},
            headers=auth_headers
        ) as response:
            events = []
            
            async for line in response.aiter_lines():
                if line.startswith("data:"):
                    data = json.loads(line[5:])
                    events.append(data)
            
            # åº”è¯¥æœ‰é”™è¯¯äº‹ä»¶
            error_events = [e for e in events if e["type"] == "error"]
            assert len(error_events) >= 1
```

### 9.3 Docker æ²™ç®±æµ‹è¯•

```python
# tests/integration/services/test_sandbox_executor.py

import pytest
from backend.services.sandbox_executor import SandboxExecutor


@pytest.mark.integration
@pytest.mark.docker
class TestSandboxExecutor:
    """Docker æ²™ç®±æ‰§è¡Œå™¨æµ‹è¯•"""
    
    @pytest.fixture
    def executor(self):
        """åˆ›å»ºæ‰§è¡Œå™¨"""
        return SandboxExecutor()
    
    @pytest.mark.asyncio
    async def test_execute_simple_code(self, executor):
        """æµ‹è¯•æ‰§è¡Œç®€å•ä»£ç """
        code = 'print("Hello, World!")'
        
        result = await executor.execute(code)
        
        assert result.success
        assert "Hello, World!" in result.stdout
        assert result.exit_code == 0
    
    @pytest.mark.asyncio
    async def test_execute_with_imports(self, executor):
        """æµ‹è¯•å¸¦å¯¼å…¥çš„ä»£ç """
        code = '''
import json
data = {"key": "value"}
print(json.dumps(data))
'''
        
        result = await executor.execute(code)
        
        assert result.success
        assert '"key": "value"' in result.stdout
    
    @pytest.mark.asyncio
    async def test_timeout_handling(self, executor):
        """æµ‹è¯•è¶…æ—¶å¤„ç†"""
        code = '''
import time
time.sleep(100)
'''
        
        result = await executor.execute(code, timeout=2)
        
        assert not result.success
        assert "timeout" in result.error.lower() or result.exit_code != 0
    
    @pytest.mark.asyncio
    async def test_memory_limit(self, executor):
        """æµ‹è¯•å†…å­˜é™åˆ¶"""
        code = '''
# å°è¯•åˆ†é…å¤§é‡å†…å­˜
data = [0] * (1024 * 1024 * 1024)  # 1GB
'''
        
        result = await executor.execute(code)
        
        assert not result.success
    
    @pytest.mark.asyncio
    async def test_network_isolation(self, executor):
        """æµ‹è¯•ç½‘ç»œéš”ç¦»"""
        code = '''
import urllib.request
urllib.request.urlopen("http://example.com")
'''
        
        result = await executor.execute(code)
        
        # åº”è¯¥å¤±è´¥ï¼Œå› ä¸ºç½‘ç»œè¢«ç¦ç”¨
        assert not result.success
    
    @pytest.mark.asyncio
    async def test_syntax_error_captured(self, executor):
        """æµ‹è¯•è¯­æ³•é”™è¯¯æ•è·"""
        code = 'def foo('  # ä¸å®Œæ•´çš„è¯­æ³•
        
        result = await executor.execute(code)
        
        assert not result.success
        assert "SyntaxError" in result.stderr
```

---

## åã€æµ‹è¯•æœ€ä½³å®è·µ

### 10.1 æµ‹è¯•å‘½åè§„èŒƒ

```python
# âœ… å¥½çš„å‘½å

def test_create_user_with_valid_email_succeeds():
    """æœ‰æ•ˆé‚®ç®±åˆ›å»ºç”¨æˆ·æˆåŠŸ"""
    pass

def test_create_user_with_invalid_email_raises_validation_error():
    """æ— æ•ˆé‚®ç®±åˆ›å»ºç”¨æˆ·æŠ›å‡ºéªŒè¯é”™è¯¯"""
    pass

def test_token_counter_returns_zero_for_empty_string():
    """ç©ºå­—ç¬¦ä¸² token è®¡æ•°è¿”å› 0"""
    pass


# âŒ ä¸å¥½çš„å‘½å

def test_1():
    """æ²¡æœ‰æè¿°æ€§"""
    pass

def test_user():
    """å¤ªç¬¼ç»Ÿ"""
    pass

def test_function():
    """æ²¡æœ‰è¯´æ˜æµ‹è¯•ä»€ä¹ˆ"""
    pass
```

### 10.2 æµ‹è¯•ç»„ç»‡ (AAA æ¨¡å¼)

```python
def test_context_manager_builds_correct_message_order():
    """æµ‹è¯•ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ„å»ºæ­£ç¡®çš„æ¶ˆæ¯é¡ºåº"""
    
    # Arrange (å‡†å¤‡)
    context_manager = ContextManager(config)
    session_id = "test-session"
    user_input = "Hello"
    system_prompt = "You are helpful."
    
    # Act (æ‰§è¡Œ)
    result = await context_manager.build(
        session_id=session_id,
        user_input=user_input,
        system_prompt=system_prompt
    )
    
    # Assert (æ–­è¨€)
    assert result.messages[0]["role"] == "system"
    assert result.messages[-1]["role"] == "user"
    assert result.messages[-1]["content"] == user_input
```

### 10.3 æµ‹è¯•éš”ç¦»åŸåˆ™

```python
# âœ… å¥½çš„å®è·µ: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹

class TestUserService:
    
    @pytest.fixture
    def service(self, db_session):
        """æ¯ä¸ªæµ‹è¯•è·å¾—æ–°çš„ service å®ä¾‹"""
        return UserService(db_session)
    
    def test_create_user(self, service):
        """æµ‹è¯• 1: åˆ›å»ºç”¨æˆ·"""
        user = service.create(email="test1@example.com")
        assert user.id is not None
    
    def test_get_user(self, service):
        """æµ‹è¯• 2: è·å–ç”¨æˆ· - ä¸ä¾èµ–æµ‹è¯• 1"""
        # è‡ªå·±åˆ›å»ºéœ€è¦çš„æ•°æ®
        user = service.create(email="test2@example.com")
        
        found = service.get(user.id)
        assert found.email == "test2@example.com"


# âŒ ä¸å¥½çš„å®è·µ: æµ‹è¯•é—´æœ‰ä¾èµ–

class TestUserServiceBad:
    created_user_id = None  # å…±äº«çŠ¶æ€ï¼
    
    def test_create_user(self, service):
        user = service.create(email="test@example.com")
        self.created_user_id = user.id  # æ±¡æŸ“å…±äº«çŠ¶æ€
    
    def test_get_user(self, service):
        # ä¾èµ– test_create_user å…ˆè¿è¡Œ
        found = service.get(self.created_user_id)  # å¯èƒ½ä¸º Noneï¼
```

### 10.4 è¦†ç›–ç‡ç›®æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è¦†ç›–ç‡ç›®æ ‡                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ¨¡å—                          ç›®æ ‡è¦†ç›–ç‡        è¯´æ˜                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  æ ¸å¿ƒä¸šåŠ¡é€»è¾‘                   â‰¥ 90%            å…³é”®è·¯å¾„å¿…é¡»è¦†ç›–            â”‚
â”‚  (Context Manager, Memory)                                                  â”‚
â”‚                                                                             â”‚
â”‚  å·¥å…·ç³»ç»Ÿ                       â‰¥ 85%            æ¯ä¸ªå·¥å…·éƒ½è¦æµ‹è¯•            â”‚
â”‚  (Tool Registry, Executor)                                                  â”‚
â”‚                                                                             â”‚
â”‚  API å±‚                         â‰¥ 80%            ä¸»è¦ç«¯ç‚¹è¦†ç›–                â”‚
â”‚  (Routes, Handlers)                                                         â”‚
â”‚                                                                             â”‚
â”‚  æ•°æ®è®¿é—®å±‚                     â‰¥ 80%            CRUD æ“ä½œè¦†ç›–               â”‚
â”‚  (Repositories)                                                             â”‚
â”‚                                                                             â”‚
â”‚  å·¥å…·å‡½æ•°                       â‰¥ 90%            çº¯å‡½æ•°æ˜“äºæµ‹è¯•              â”‚
â”‚  (Utils)                                                                    â”‚
â”‚                                                                             â”‚
â”‚  å‰ç«¯ç»„ä»¶                       â‰¥ 75%            å…³é”®ç»„ä»¶è¦†ç›–                â”‚
â”‚  (React Components)                                                         â”‚
â”‚                                                                             â”‚
â”‚  æ€»ä½“ç›®æ ‡                       â‰¥ 80%            CI é—¨ç¦                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åä¸€ã€è¯„ä¼°ä½“ç³» (Evaluation)

### 11.1 è¯„ä¼°æ¡†æ¶æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AI Agent è¯„ä¼°ä½“ç³»                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         è¯„ä¼°ç»´åº¦                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   åŠŸèƒ½æ­£ç¡®æ€§        è´¨é‡è¯„ä¼°          æ€§èƒ½è¯„ä¼°         ç”¨æˆ·ä½“éªŒ       â”‚   â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€        â”‚   â”‚
â”‚  â”‚   â€¢ ä»»åŠ¡å®Œæˆç‡     â€¢ è¾“å‡ºè´¨é‡        â€¢ å“åº”å»¶è¿Ÿ      â€¢ æ»¡æ„åº¦        â”‚   â”‚
â”‚  â”‚   â€¢ å‡†ç¡®æ€§        â€¢ ä»£ç è´¨é‡        â€¢ ååé‡        â€¢ NPS è¯„åˆ†      â”‚   â”‚
â”‚  â”‚   â€¢ ä¸€è‡´æ€§        â€¢ å®‰å…¨åˆè§„        â€¢ èµ„æºä½¿ç”¨      â€¢ ç•™å­˜ç‡        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         è¯„ä¼°æ–¹æ³•                                     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   è‡ªåŠ¨åŒ–è¯„ä¼°              LLM-as-Judge            äººå·¥è¯„ä¼°           â”‚   â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€           â”‚   â”‚
â”‚  â”‚   â€¢ åŸºå‡†æµ‹è¯•é›†            â€¢ GPT-4 è¯„åˆ†            â€¢ ä¸“å®¶è¯„å®¡         â”‚   â”‚
â”‚  â”‚   â€¢ å›å½’æµ‹è¯•              â€¢ å¤šç»´åº¦æ‰“åˆ†            â€¢ ç”¨æˆ·åé¦ˆ         â”‚   â”‚
â”‚  â”‚   â€¢ æŒ‡æ ‡è®¡ç®—              â€¢ å¯¹æ¯”è¯„ä¼°              â€¢ A/B æµ‹è¯•         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 åŠŸèƒ½è¯„ä¼° (Functional Evaluation)

#### 11.2.1 ä»»åŠ¡å®Œæˆç‡è¯„ä¼°

```python
# evaluation/task_completion.py

from dataclasses import dataclass
from typing import Optional
from enum import Enum


class TaskStatus(Enum):
    """ä»»åŠ¡çŠ¶æ€"""
    SUCCESS = "success"           # å®Œå…¨æˆåŠŸ
    PARTIAL = "partial"           # éƒ¨åˆ†æˆåŠŸ
    FAILED = "failed"             # å¤±è´¥
    TIMEOUT = "timeout"           # è¶…æ—¶
    ERROR = "error"               # é”™è¯¯


@dataclass
class TaskEvalResult:
    """ä»»åŠ¡è¯„ä¼°ç»“æœ"""
    task_id: str
    status: TaskStatus
    score: float                  # 0.0 - 1.0
    expected_output: str
    actual_output: str
    steps_taken: int
    time_taken_ms: int
    tokens_used: int
    errors: list[str]
    metadata: dict


class TaskEvaluator:
    """ä»»åŠ¡å®Œæˆç‡è¯„ä¼°å™¨"""
    
    def __init__(self, test_cases: list[dict]):
        self.test_cases = test_cases
        self.results: list[TaskEvalResult] = []
    
    async def run_evaluation(self, agent) -> EvaluationReport:
        """è¿è¡Œè¯„ä¼°"""
        for case in self.test_cases:
            result = await self._evaluate_single(agent, case)
            self.results.append(result)
        
        return self._generate_report()
    
    async def _evaluate_single(self, agent, case: dict) -> TaskEvalResult:
        """è¯„ä¼°å•ä¸ªæµ‹è¯•ç”¨ä¾‹"""
        task_id = case["id"]
        input_prompt = case["input"]
        expected = case["expected_output"]
        criteria = case.get("criteria", {})
        
        start_time = time.time()
        
        try:
            # æ‰§è¡Œ Agent
            response = await agent.run(input_prompt)
            
            # è¯„ä¼°è¾“å‡º
            score = await self._score_output(
                expected=expected,
                actual=response.content,
                criteria=criteria
            )
            
            status = self._determine_status(score, response)
            
            return TaskEvalResult(
                task_id=task_id,
                status=status,
                score=score,
                expected_output=expected,
                actual_output=response.content,
                steps_taken=response.iterations,
                time_taken_ms=int((time.time() - start_time) * 1000),
                tokens_used=response.total_tokens,
                errors=[],
                metadata={"criteria": criteria}
            )
            
        except Exception as e:
            return TaskEvalResult(
                task_id=task_id,
                status=TaskStatus.ERROR,
                score=0.0,
                expected_output=expected,
                actual_output="",
                steps_taken=0,
                time_taken_ms=int((time.time() - start_time) * 1000),
                tokens_used=0,
                errors=[str(e)],
                metadata={}
            )
    
    def _generate_report(self) -> EvaluationReport:
        """ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š"""
        total = len(self.results)
        success = sum(1 for r in self.results if r.status == TaskStatus.SUCCESS)
        partial = sum(1 for r in self.results if r.status == TaskStatus.PARTIAL)
        failed = sum(1 for r in self.results if r.status == TaskStatus.FAILED)
        
        return EvaluationReport(
            total_tasks=total,
            success_count=success,
            partial_count=partial,
            failed_count=failed,
            success_rate=success / total if total > 0 else 0,
            average_score=sum(r.score for r in self.results) / total if total > 0 else 0,
            average_time_ms=sum(r.time_taken_ms for r in self.results) / total if total > 0 else 0,
            average_tokens=sum(r.tokens_used for r in self.results) / total if total > 0 else 0,
            results=self.results
        )
```

#### 11.2.2 åŸºå‡†æµ‹è¯•é›†

```yaml
# evaluation/benchmarks/agent_tasks.yaml

# åŸºå‡†æµ‹è¯•é›†é…ç½®
benchmark:
  name: "AI Agent Core Tasks"
  version: "1.0"
  categories:
    - name: "simple_qa"
      weight: 0.2
    - name: "tool_usage"
      weight: 0.3
    - name: "multi_step"
      weight: 0.3
    - name: "code_generation"
      weight: 0.2

test_cases:
  # =====================================
  # ç®€å•é—®ç­”
  # =====================================
  - id: "qa_001"
    category: "simple_qa"
    input: "What is 2 + 2?"
    expected_output: "4"
    criteria:
      exact_match: true
    
  - id: "qa_002"
    category: "simple_qa"
    input: "Summarize the benefits of TDD in one sentence."
    expected_output: null  # ä½¿ç”¨ LLM-as-Judge
    criteria:
      contains_keywords: ["test", "quality", "design"]
      max_length: 100

  # =====================================
  # å·¥å…·ä½¿ç”¨
  # =====================================
  - id: "tool_001"
    category: "tool_usage"
    input: "Read the file /tmp/test.txt and tell me its contents."
    setup:
      - action: "create_file"
        path: "/tmp/test.txt"
        content: "Hello, World!"
    expected_output: "Hello, World!"
    criteria:
      must_use_tools: ["read_file"]
      
  - id: "tool_002"
    category: "tool_usage"
    input: "Search the web for the current weather in Beijing."
    expected_output: null
    criteria:
      must_use_tools: ["web_search"]
      response_contains: ["Beijing", "weather"]

  # =====================================
  # å¤šæ­¥éª¤ä»»åŠ¡
  # =====================================
  - id: "multi_001"
    category: "multi_step"
    input: |
      1. Read the file /tmp/data.json
      2. Extract the 'name' field
      3. Write it to /tmp/output.txt
    setup:
      - action: "create_file"
        path: "/tmp/data.json"
        content: '{"name": "Alice", "age": 30}'
    expected_output: null
    criteria:
      must_use_tools: ["read_file", "write_file"]
      verify_file:
        path: "/tmp/output.txt"
        contains: "Alice"

  # =====================================
  # ä»£ç ç”Ÿæˆ
  # =====================================
  - id: "code_001"
    category: "code_generation"
    input: "Write a Python function that calculates factorial."
    expected_output: null
    criteria:
      code_quality:
        syntax_valid: true
        has_docstring: true
        passes_tests:
          - input: [5]
            expected: 120
          - input: [0]
            expected: 1
```

### 11.3 LLM-as-Judge è¯„ä¼°

```python
# evaluation/llm_judge.py

from typing import Optional
from pydantic import BaseModel


class JudgeScore(BaseModel):
    """è¯„åˆ†ç»“æœ"""
    overall_score: float          # 0-10
    relevance: float              # ç›¸å…³æ€§
    accuracy: float               # å‡†ç¡®æ€§
    completeness: float           # å®Œæ•´æ€§
    clarity: float                # æ¸…æ™°åº¦
    reasoning: str                # è¯„åˆ†ç†ç”±


class LLMJudge:
    """LLM-as-Judge è¯„ä¼°å™¨"""
    
    JUDGE_PROMPT = """You are an expert evaluator for AI assistant responses.

## Task
Evaluate the following response based on the given criteria.

## Input
**User Query:** {query}

**Expected Output (if any):** {expected}

**Actual Response:** {response}

## Evaluation Criteria
1. **Relevance (0-10):** Does the response address the user's query?
2. **Accuracy (0-10):** Is the information correct and factual?
3. **Completeness (0-10):** Does it fully answer the question?
4. **Clarity (0-10):** Is the response clear and well-structured?

## Output Format
Return a JSON object:
```json
{{
  "overall_score": 8.5,
  "relevance": 9,
  "accuracy": 8,
  "completeness": 8,
  "clarity": 9,
  "reasoning": "The response correctly addresses..."
}}
```

Evaluate now:"""

    def __init__(self, llm_gateway, judge_model: str = "gpt-4"):
        self.llm = llm_gateway
        self.judge_model = judge_model
    
    async def evaluate(
        self,
        query: str,
        response: str,
        expected: Optional[str] = None,
        criteria: Optional[dict] = None
    ) -> JudgeScore:
        """ä½¿ç”¨ LLM è¯„ä¼°å“åº”è´¨é‡"""
        
        prompt = self.JUDGE_PROMPT.format(
            query=query,
            expected=expected or "Not specified",
            response=response
        )
        
        result = await self.llm.chat(
            messages=[{"role": "user", "content": prompt}],
            model=self.judge_model,
            response_format={"type": "json_object"}
        )
        
        return JudgeScore.model_validate_json(result.content)
    
    async def compare(
        self,
        query: str,
        response_a: str,
        response_b: str
    ) -> dict:
        """å¯¹æ¯”ä¸¤ä¸ªå“åº”"""
        
        compare_prompt = """Compare these two responses to the same query.

Query: {query}

Response A:
{response_a}

Response B:
{response_b}

Which response is better? Return JSON:
{{
  "winner": "A" or "B" or "tie",
  "score_a": 0-10,
  "score_b": 0-10,
  "reasoning": "..."
}}"""
        
        result = await self.llm.chat(
            messages=[{"role": "user", "content": compare_prompt.format(
                query=query,
                response_a=response_a,
                response_b=response_b
            )}],
            model=self.judge_model,
            response_format={"type": "json_object"}
        )
        
        return json.loads(result.content)


class MultiDimensionJudge:
    """å¤šç»´åº¦è¯„ä¼°å™¨"""
    
    DIMENSIONS = {
        "helpfulness": "How helpful is the response in addressing the user's needs?",
        "harmlessness": "Is the response free from harmful or dangerous content?",
        "honesty": "Is the response honest and not misleading?",
        "factuality": "Are the facts in the response accurate?",
        "coherence": "Is the response logically coherent and well-structured?",
    }
    
    async def evaluate_all_dimensions(
        self,
        query: str,
        response: str
    ) -> dict[str, float]:
        """è¯„ä¼°æ‰€æœ‰ç»´åº¦"""
        scores = {}
        
        for dim, description in self.DIMENSIONS.items():
            score = await self._evaluate_dimension(
                query=query,
                response=response,
                dimension=dim,
                description=description
            )
            scores[dim] = score
        
        scores["overall"] = sum(scores.values()) / len(scores)
        return scores
```

### 11.4 ä»£ç è´¨é‡è¯„ä¼°

```python
# evaluation/code_quality.py

from dataclasses import dataclass
from typing import Optional
import ast
import subprocess


@dataclass
class CodeQualityScore:
    """ä»£ç è´¨é‡è¯„åˆ†"""
    syntax_valid: bool
    type_check_passed: bool
    lint_score: float              # 0-10
    test_pass_rate: float          # 0-1
    cyclomatic_complexity: float
    maintainability_index: float
    security_issues: list[str]
    suggestions: list[str]


class CodeQualityEvaluator:
    """ä»£ç è´¨é‡è¯„ä¼°å™¨"""
    
    def __init__(self):
        pass
    
    async def evaluate(self, code: str, language: str = "python") -> CodeQualityScore:
        """è¯„ä¼°ä»£ç è´¨é‡"""
        
        # 1. è¯­æ³•æ£€æŸ¥
        syntax_valid = self._check_syntax(code, language)
        
        # 2. ç±»å‹æ£€æŸ¥ (Python)
        type_check_passed = await self._run_type_check(code) if language == "python" else True
        
        # 3. Lint æ£€æŸ¥
        lint_issues = await self._run_linter(code, language)
        lint_score = max(0, 10 - len(lint_issues) * 0.5)
        
        # 4. å¤æ‚åº¦åˆ†æ
        complexity = self._analyze_complexity(code, language)
        
        # 5. å®‰å…¨æ£€æŸ¥
        security_issues = await self._security_scan(code, language)
        
        # 6. ç”Ÿæˆå»ºè®®
        suggestions = self._generate_suggestions(
            lint_issues, complexity, security_issues
        )
        
        return CodeQualityScore(
            syntax_valid=syntax_valid,
            type_check_passed=type_check_passed,
            lint_score=lint_score,
            test_pass_rate=0.0,  # éœ€è¦å•ç‹¬è¿è¡Œæµ‹è¯•
            cyclomatic_complexity=complexity.get("cyclomatic", 0),
            maintainability_index=complexity.get("maintainability", 0),
            security_issues=security_issues,
            suggestions=suggestions
        )
    
    def _check_syntax(self, code: str, language: str) -> bool:
        """è¯­æ³•æ£€æŸ¥"""
        if language == "python":
            try:
                ast.parse(code)
                return True
            except SyntaxError:
                return False
        return True  # å…¶ä»–è¯­è¨€æš‚ä¸æ”¯æŒ
    
    async def _run_type_check(self, code: str) -> bool:
        """è¿è¡Œç±»å‹æ£€æŸ¥"""
        # ä½¿ç”¨ pyright æ£€æŸ¥
        import tempfile
        import os
        
        with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
            f.write(code)
            temp_path = f.name
        
        try:
            result = subprocess.run(
                ['pyright', temp_path],
                capture_output=True,
                text=True,
                timeout=30
            )
            return result.returncode == 0
        except Exception:
            return True  # æ£€æŸ¥å¤±è´¥æ—¶é»˜è®¤é€šè¿‡
        finally:
            os.unlink(temp_path)
    
    async def _run_linter(self, code: str, language: str) -> list[dict]:
        """è¿è¡Œ Linter"""
        if language == "python":
            # ä½¿ç”¨ ruff
            import tempfile
            import json
            
            with tempfile.NamedTemporaryFile(mode='w', suffix='.py', delete=False) as f:
                f.write(code)
                temp_path = f.name
            
            try:
                result = subprocess.run(
                    ['ruff', 'check', '--output-format=json', temp_path],
                    capture_output=True,
                    text=True,
                    timeout=30
                )
                if result.stdout:
                    return json.loads(result.stdout)
                return []
            except Exception:
                return []
            finally:
                os.unlink(temp_path)
        
        return []
```

### 11.5 æ€§èƒ½è¯„ä¼°

```python
# evaluation/performance.py

from dataclasses import dataclass
from typing import List
import time
import asyncio
import statistics


@dataclass
class PerformanceMetrics:
    """æ€§èƒ½æŒ‡æ ‡"""
    # å»¶è¿ŸæŒ‡æ ‡ (ms)
    latency_p50: float
    latency_p90: float
    latency_p99: float
    latency_avg: float
    latency_min: float
    latency_max: float
    
    # ååé‡
    requests_per_second: float
    
    # Token æŒ‡æ ‡
    tokens_per_second: float
    avg_tokens_per_request: float
    
    # èµ„æºä½¿ç”¨
    avg_memory_mb: float
    peak_memory_mb: float
    avg_cpu_percent: float


class PerformanceEvaluator:
    """æ€§èƒ½è¯„ä¼°å™¨"""
    
    def __init__(self, agent, num_requests: int = 100, concurrency: int = 10):
        self.agent = agent
        self.num_requests = num_requests
        self.concurrency = concurrency
        self.results: List[dict] = []
    
    async def run_benchmark(self, test_prompts: list[str]) -> PerformanceMetrics:
        """è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"""
        
        # å‡†å¤‡è¯·æ±‚
        prompts = test_prompts * (self.num_requests // len(test_prompts) + 1)
        prompts = prompts[:self.num_requests]
        
        # å¹¶å‘æ‰§è¡Œ
        semaphore = asyncio.Semaphore(self.concurrency)
        
        async def bounded_request(prompt: str) -> dict:
            async with semaphore:
                return await self._single_request(prompt)
        
        start_time = time.time()
        
        tasks = [bounded_request(p) for p in prompts]
        self.results = await asyncio.gather(*tasks)
        
        total_time = time.time() - start_time
        
        return self._calculate_metrics(total_time)
    
    async def _single_request(self, prompt: str) -> dict:
        """æ‰§è¡Œå•ä¸ªè¯·æ±‚"""
        start = time.time()
        
        try:
            response = await self.agent.run(prompt)
            
            return {
                "success": True,
                "latency_ms": (time.time() - start) * 1000,
                "tokens": response.total_tokens,
                "error": None
            }
        except Exception as e:
            return {
                "success": False,
                "latency_ms": (time.time() - start) * 1000,
                "tokens": 0,
                "error": str(e)
            }
    
    def _calculate_metrics(self, total_time: float) -> PerformanceMetrics:
        """è®¡ç®—æ€§èƒ½æŒ‡æ ‡"""
        
        latencies = [r["latency_ms"] for r in self.results if r["success"]]
        tokens = [r["tokens"] for r in self.results if r["success"]]
        
        latencies.sort()
        
        def percentile(data: list, p: float) -> float:
            if not data:
                return 0
            k = (len(data) - 1) * p / 100
            f = int(k)
            c = f + 1 if f + 1 < len(data) else f
            return data[f] + (k - f) * (data[c] - data[f])
        
        return PerformanceMetrics(
            latency_p50=percentile(latencies, 50),
            latency_p90=percentile(latencies, 90),
            latency_p99=percentile(latencies, 99),
            latency_avg=statistics.mean(latencies) if latencies else 0,
            latency_min=min(latencies) if latencies else 0,
            latency_max=max(latencies) if latencies else 0,
            requests_per_second=len(self.results) / total_time,
            tokens_per_second=sum(tokens) / total_time,
            avg_tokens_per_request=statistics.mean(tokens) if tokens else 0,
            avg_memory_mb=0,  # éœ€è¦é¢å¤–ç›‘æ§
            peak_memory_mb=0,
            avg_cpu_percent=0
        )


class LoadTestRunner:
    """è´Ÿè½½æµ‹è¯•è¿è¡Œå™¨"""
    
    async def run_load_test(
        self,
        agent,
        prompts: list[str],
        duration_seconds: int = 60,
        target_rps: float = 10
    ) -> dict:
        """
        è¿è¡Œè´Ÿè½½æµ‹è¯•
        
        Args:
            agent: Agent å®ä¾‹
            prompts: æµ‹è¯•æç¤ºè¯
            duration_seconds: æµ‹è¯•æŒç»­æ—¶é—´
            target_rps: ç›®æ ‡æ¯ç§’è¯·æ±‚æ•°
        """
        results = []
        start_time = time.time()
        request_interval = 1.0 / target_rps
        
        while time.time() - start_time < duration_seconds:
            prompt = random.choice(prompts)
            
            # å¼‚æ­¥å‘é€è¯·æ±‚
            task = asyncio.create_task(self._timed_request(agent, prompt))
            results.append(task)
            
            await asyncio.sleep(request_interval)
        
        # ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
        completed = await asyncio.gather(*results, return_exceptions=True)
        
        return self._analyze_load_test(completed, duration_seconds, target_rps)
```

### 11.6 ç”¨æˆ·ä½“éªŒè¯„ä¼°

```python
# evaluation/user_experience.py

from dataclasses import dataclass
from typing import Optional
from enum import Enum


class SatisfactionLevel(Enum):
    """æ»¡æ„åº¦çº§åˆ«"""
    VERY_DISSATISFIED = 1
    DISSATISFIED = 2
    NEUTRAL = 3
    SATISFIED = 4
    VERY_SATISFIED = 5


@dataclass
class UserFeedback:
    """ç”¨æˆ·åé¦ˆ"""
    session_id: str
    user_id: str
    satisfaction: SatisfactionLevel
    task_completed: bool
    would_recommend: bool  # NPS
    feedback_text: Optional[str]
    response_time_acceptable: bool
    accuracy_rating: int  # 1-5
    timestamp: datetime


class UserExperienceTracker:
    """ç”¨æˆ·ä½“éªŒè¿½è¸ªå™¨"""
    
    def __init__(self, db):
        self.db = db
    
    async def record_feedback(self, feedback: UserFeedback):
        """è®°å½•ç”¨æˆ·åé¦ˆ"""
        await self.db.save_feedback(feedback)
    
    async def calculate_nps(self, time_range_days: int = 30) -> float:
        """
        è®¡ç®— NPS (Net Promoter Score)
        
        NPS = % Promoters - % Detractors
        - Promoters: would_recommend = True, satisfaction >= 4
        - Detractors: would_recommend = False, satisfaction <= 2
        """
        feedbacks = await self.db.get_feedbacks(days=time_range_days)
        
        if not feedbacks:
            return 0
        
        promoters = sum(1 for f in feedbacks 
                       if f.would_recommend and f.satisfaction.value >= 4)
        detractors = sum(1 for f in feedbacks 
                        if not f.would_recommend and f.satisfaction.value <= 2)
        
        total = len(feedbacks)
        nps = ((promoters - detractors) / total) * 100
        
        return round(nps, 1)
    
    async def get_satisfaction_distribution(self, time_range_days: int = 30) -> dict:
        """è·å–æ»¡æ„åº¦åˆ†å¸ƒ"""
        feedbacks = await self.db.get_feedbacks(days=time_range_days)
        
        distribution = {level.name: 0 for level in SatisfactionLevel}
        
        for f in feedbacks:
            distribution[f.satisfaction.name] += 1
        
        return distribution
    
    async def generate_ux_report(self, time_range_days: int = 30) -> dict:
        """ç”Ÿæˆç”¨æˆ·ä½“éªŒæŠ¥å‘Š"""
        feedbacks = await self.db.get_feedbacks(days=time_range_days)
        
        return {
            "period_days": time_range_days,
            "total_feedbacks": len(feedbacks),
            "nps": await self.calculate_nps(time_range_days),
            "satisfaction_distribution": await self.get_satisfaction_distribution(time_range_days),
            "task_completion_rate": sum(1 for f in feedbacks if f.task_completed) / len(feedbacks) if feedbacks else 0,
            "avg_satisfaction": sum(f.satisfaction.value for f in feedbacks) / len(feedbacks) if feedbacks else 0,
            "avg_accuracy_rating": sum(f.accuracy_rating for f in feedbacks) / len(feedbacks) if feedbacks else 0,
            "response_time_acceptable_rate": sum(1 for f in feedbacks if f.response_time_acceptable) / len(feedbacks) if feedbacks else 0,
        }
```

### 11.7 è¯„ä¼°æµæ°´çº¿

```yaml
# evaluation/pipeline.yaml

# è¯„ä¼°æµæ°´çº¿é…ç½®
evaluation_pipeline:
  name: "AI Agent Full Evaluation"
  schedule: "weekly"  # daily, weekly, on_release
  
  stages:
    # é˜¶æ®µ 1: åŠŸèƒ½è¯„ä¼°
    - name: "functional"
      evaluators:
        - type: "task_completion"
          config:
            benchmark: "agent_tasks.yaml"
            timeout_per_task: 60
        - type: "tool_usage"
          config:
            verify_correct_tool: true
            verify_parameters: true
      thresholds:
        success_rate: 0.9
        avg_score: 8.0
    
    # é˜¶æ®µ 2: è´¨é‡è¯„ä¼°
    - name: "quality"
      evaluators:
        - type: "llm_judge"
          config:
            judge_model: "gpt-4"
            dimensions: ["relevance", "accuracy", "helpfulness"]
        - type: "code_quality"
          config:
            check_types: true
            check_lint: true
            check_security: true
      thresholds:
        avg_judge_score: 7.5
        code_quality_score: 8.0
    
    # é˜¶æ®µ 3: æ€§èƒ½è¯„ä¼°
    - name: "performance"
      evaluators:
        - type: "latency"
          config:
            num_requests: 100
            concurrency: 10
        - type: "throughput"
          config:
            duration_seconds: 60
            target_rps: 20
      thresholds:
        p90_latency_ms: 3000
        min_rps: 15
    
    # é˜¶æ®µ 4: å›å½’æ£€æµ‹
    - name: "regression"
      evaluators:
        - type: "comparison"
          config:
            baseline_version: "latest_release"
            compare_metrics: ["success_rate", "avg_score", "p90_latency"]
      thresholds:
        max_regression_percent: 5

  # é€šçŸ¥é…ç½®
  notifications:
    on_failure:
      - type: "slack"
        channel: "#ai-agent-alerts"
      - type: "email"
        recipients: ["team@example.com"]
    on_success:
      - type: "slack"
        channel: "#ai-agent-reports"

  # æŠ¥å‘Šé…ç½®
  reports:
    - format: "html"
      destination: "s3://reports/evaluation/"
    - format: "json"
      destination: "metrics_db"
```

### 11.8 è¯„ä¼°æŒ‡æ ‡ä»ªè¡¨ç›˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è¯„ä¼°æŒ‡æ ‡ä»ªè¡¨ç›˜                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å…³é”®æŒ‡æ ‡ (KPIs)                                    æ›´æ–°: 2026-01-12 â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   ä»»åŠ¡æˆåŠŸç‡          LLM è´¨é‡è¯„åˆ†         P90 å»¶è¿Ÿ          NPS     â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚   â”‚  92.5%   â”‚       â”‚   8.3    â”‚       â”‚  2.1s    â”‚    â”‚  +45   â”‚ â”‚   â”‚
â”‚  â”‚   â”‚   â†‘2.1%  â”‚       â”‚   â†‘0.2   â”‚       â”‚   â†“0.3s  â”‚    â”‚  â†‘5    â”‚ â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¶‹åŠ¿å›¾è¡¨                                                            â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  ä»»åŠ¡æˆåŠŸç‡ (è¿‡å» 30 å¤©)                                             â”‚   â”‚
â”‚  â”‚  100%â”‚                                      â•­â”€â”€â”€â•®                   â”‚   â”‚
â”‚  â”‚   90%â”‚    â•­â”€â”€â”€â”€â•®      â•­â”€â”€â”€â”€â”€â•®    â•­â”€â”€â”€â”€â•®   â”‚   â•°â”€                   â”‚   â”‚
â”‚  â”‚   80%â”‚â”€â”€â”€â•¯    â•°â”€â”€â”€â”€â”€â”€â•¯     â•°â”€â”€â”€â”€â•¯    â•°â”€â”€â”€â•¯                         â”‚   â”‚
â”‚  â”‚   70%â”‚                                                              â”‚   â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚   â”‚
â”‚  â”‚        W1      W2       W3       W4      W5     Now                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åˆ†ç±»è¯„ä¼°ç»“æœ                                                        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   ç±»åˆ«              æˆåŠŸç‡    å¹³å‡åˆ†    å¹³å‡å»¶è¿Ÿ    æµ‹è¯•æ•°           â”‚   â”‚
â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚   â”‚
â”‚  â”‚   ç®€å•é—®ç­”          98.5%     9.2       0.8s       200              â”‚   â”‚
â”‚  â”‚   å·¥å…·ä½¿ç”¨          91.2%     8.1       2.5s       150              â”‚   â”‚
â”‚  â”‚   å¤šæ­¥éª¤ä»»åŠ¡        87.3%     7.8       4.2s       100              â”‚   â”‚
â”‚  â”‚   ä»£ç ç”Ÿæˆ          89.6%     8.0       3.1s       120              â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.9 æŒç»­è¯„ä¼°ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æŒç»­è¯„ä¼°ç­–ç•¥                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¯„ä¼°æ—¶æœº                æ‰§è¡Œå†…å®¹                     ç›®çš„                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  æ¯æ¬¡ PR                 â€¢ æ ¸å¿ƒåŠŸèƒ½åŸºå‡†æµ‹è¯•           å¿«é€Ÿåé¦ˆ              â”‚
â”‚                         â€¢ å…³é”®è·¯å¾„å›å½’æµ‹è¯•                                  â”‚
â”‚                         â€¢ ä»£ç è´¨é‡æ£€æŸ¥                                      â”‚
â”‚                                                                             â”‚
â”‚  æ¯æ—¥ (Nightly)         â€¢ å®Œæ•´åŸºå‡†æµ‹è¯•é›†             å…¨é¢è¦†ç›–              â”‚
â”‚                         â€¢ æ€§èƒ½åŸºå‡†æµ‹è¯•                                      â”‚
â”‚                         â€¢ LLM-as-Judge æŠ½æ ·                                 â”‚
â”‚                                                                             â”‚
â”‚  æ¯å‘¨                   â€¢ å…¨é‡ LLM è¯„ä¼°               æ·±åº¦åˆ†æ              â”‚
â”‚                         â€¢ ç”¨æˆ·åé¦ˆæ±‡æ€»                                      â”‚
â”‚                         â€¢ å¯¹æ¯”å†å²ç‰ˆæœ¬                                      â”‚
â”‚                                                                             â”‚
â”‚  å‘å¸ƒå‰                 â€¢ å®Œæ•´è¯„ä¼°æµæ°´çº¿             è´¨é‡é—¨ç¦              â”‚
â”‚                         â€¢ è´Ÿè½½æµ‹è¯•                                          â”‚
â”‚                         â€¢ å®‰å…¨å®¡è®¡                                          â”‚
â”‚                         â€¢ äººå·¥æŠ½æ£€                                          â”‚
â”‚                                                                             â”‚
â”‚  å‘å¸ƒå                 â€¢ çº¿ä¸ŠæŒ‡æ ‡ç›‘æ§               æŒç»­ç›‘æ§              â”‚
â”‚                         â€¢ ç”¨æˆ·åé¦ˆæ”¶é›†                                      â”‚
â”‚                         â€¢ å¼‚å¸¸æ£€æµ‹å‘Šè­¦                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åäºŒã€æ€»ç»“

### 12.1 TDD ä»·å€¼

| ä»·å€¼ | æè¿° |
|------|------|
| **è®¾è®¡é©±åŠ¨** | å…ˆå†™æµ‹è¯•è¿«ä½¿æ€è€ƒ API è®¾è®¡ |
| **å³æ—¶åé¦ˆ** | æ¯æ¬¡ä¿®æ”¹éƒ½æœ‰æµ‹è¯•éªŒè¯ |
| **æ–‡æ¡£ä½œç”¨** | æµ‹è¯•å³æ–‡æ¡£ï¼Œæè¿°é¢„æœŸè¡Œä¸º |
| **é‡æ„ä¿¡å¿ƒ** | æœ‰æµ‹è¯•ä¿éšœï¼Œæ”¾å¿ƒé‡æ„ |
| **å‡å°‘ Bug** | æ—©æœŸå‘ç°é—®é¢˜ï¼Œé™ä½ä¿®å¤æˆæœ¬ |

### 12.2 æµ‹è¯•ç­–ç•¥æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AI Agent æµ‹è¯•ç­–ç•¥æ€»ç»“                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. çº¯ä¸šåŠ¡é€»è¾‘ â†’ ä¸¥æ ¼ TDD + å•å…ƒæµ‹è¯•                                        â”‚
â”‚  2. å¤–éƒ¨ä¾èµ– â†’ Mock + é›†æˆæµ‹è¯•                                              â”‚
â”‚  3. LLM äº¤äº’ â†’ Mock API + å°‘é‡çœŸå®æµ‹è¯•                                      â”‚
â”‚  4. UI ç»„ä»¶ â†’ ç»„ä»¶æµ‹è¯• + å¿«ç…§æµ‹è¯•                                           â”‚
â”‚  5. å…³é”®æµç¨‹ â†’ E2E æµ‹è¯•                                                     â”‚
â”‚                                                                             â”‚
â”‚  è¦†ç›–ç‡ç›®æ ‡: 80%                                                            â”‚
â”‚  CI é—¨ç¦: å•å…ƒæµ‹è¯• + ç±»å‹æ£€æŸ¥ + Lint                                        â”‚
â”‚  å®šæœŸè¿è¡Œ: é›†æˆæµ‹è¯• + E2E æµ‹è¯•                                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 è¯„ä¼°ç­–ç•¥æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AI Agent è¯„ä¼°ç­–ç•¥æ€»ç»“                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¯„ä¼°ç»´åº¦:                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. åŠŸèƒ½è¯„ä¼° â†’ åŸºå‡†æµ‹è¯•é›† + ä»»åŠ¡å®Œæˆç‡                                      â”‚
â”‚  2. è´¨é‡è¯„ä¼° â†’ LLM-as-Judge + ä»£ç è´¨é‡æ£€æŸ¥                                  â”‚
â”‚  3. æ€§èƒ½è¯„ä¼° â†’ å»¶è¿Ÿ/ååé‡/èµ„æºä½¿ç”¨                                         â”‚
â”‚  4. ç”¨æˆ·ä½“éªŒ â†’ NPS + æ»¡æ„åº¦ + åé¦ˆæ”¶é›†                                      â”‚
â”‚                                                                             â”‚
â”‚  è¯„ä¼°æ—¶æœº:                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ PR åˆå¹¶å‰: æ ¸å¿ƒåŠŸèƒ½å›å½’æµ‹è¯•                                              â”‚
â”‚  â€¢ æ¯æ—¥æ„å»º: å®Œæ•´åŸºå‡†æµ‹è¯•                                                   â”‚
â”‚  â€¢ æ¯å‘¨: å…¨é‡ LLM è¯„ä¼° + ç”¨æˆ·åé¦ˆåˆ†æ                                       â”‚
â”‚  â€¢ å‘å¸ƒå‰: å®Œæ•´è¯„ä¼°æµæ°´çº¿ + äººå·¥å®¡æ ¸                                        â”‚
â”‚                                                                             â”‚
â”‚  å…³é”®æŒ‡æ ‡:                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ ä»»åŠ¡æˆåŠŸç‡ â‰¥ 90%                                                         â”‚
â”‚  â€¢ LLM è´¨é‡è¯„åˆ† â‰¥ 8.0                                                       â”‚
â”‚  â€¢ P90 å»¶è¿Ÿ â‰¤ 3s                                                            â”‚
â”‚  â€¢ NPS â‰¥ 40                                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<div align="center">

**æµ‹è¯•ä¿éšœè´¨é‡ï¼Œè¯„ä¼°é©±åŠ¨æ”¹è¿›**

*æ–‡æ¡£ç‰ˆæœ¬: v1.1 | æœ€åæ›´æ–°: 2026-01-12*

</div>
