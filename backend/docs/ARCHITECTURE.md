# 🏗️ AI Agent 后端架构文档

> **版本**: 1.0.0
> **更新日期**: 2026-01-14
> **适用范围**: backend/ 目录架构设计与实现说明

---

## 📋 目录

1. [系统概述](#系统概述)
2. [架构设计](#架构设计)
3. [核心模块](#核心模块)
4. [技术栈](#技术栈)
5. [数据流](#数据流)
6. [部署架构](#部署架构)
7. [安全架构](#安全架构)
8. [可扩展性设计](#可扩展性设计)
9. [性能优化](#性能优化)
10. [监控与可观测性](#监控与可观测性)

---

## 系统概述

### 1.1 系统定位

AI Agent 后端是一个基于 FastAPI 的智能体系统，提供：

- **Agent 执行引擎**: 支持多种推理模式（ReAct、Plan-Act、CoT、ToT、Reflect）
- **工具生态系统**: 内置工具 + MCP 协议扩展 + A2A 调用
- **记忆系统**: 短期记忆 + 长期记忆 + 向量检索
- **检查点机制**: 状态持久化、崩溃恢复、时间旅行调试
- **Human-in-the-Loop**: 关键操作人工确认机制
- **代码质量保证**: LSP 集成、代码验证、自动修复

### 1.2 核心能力

```
┌─────────────────────────────────────────────────────────────┐
│                    AI Agent 后端核心能力                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🧠 智能推理                                                  │
│  ├─ ReAct: 推理与行动交替                                    │
│  ├─ Plan-Act: 先规划后执行                                    │
│  ├─ CoT: 思维链推理                                          │
│  ├─ ToT: 思维树探索                                          │
│  └─ Reflect: 反思改进                                        │
│                                                              │
│  🔧 工具执行                                                  │
│  ├─ 内置工具: 文件、代码、搜索、数据库                        │
│  ├─ MCP 扩展: 标准化工具协议                                 │
│  └─ A2A 调用: Agent 间协作                                  │
│                                                              │
│  💾 记忆管理                                                  │
│  ├─ 短期记忆: 会话上下文                                     │
│  ├─ 长期记忆: 向量存储 + 关系数据库                          │
│  └─ 智能检索: 语义相似度 + 时间衰减                           │
│                                                              │
│  🔄 状态管理                                                  │
│  ├─ 检查点持久化: Redis / PostgreSQL                         │
│  ├─ 崩溃恢复: 从最后检查点恢复                               │
│  └─ 时间旅行: 查看历史状态、重新执行                          │
│                                                              │
│  👤 人机协作                                                  │
│  ├─ 中断机制: 关键操作前暂停                                 │
│  ├─ 人工确认: 批准/修改/拒绝                                 │
│  └─ 自动批准: 可配置的安全策略                               │
│                                                              │
│  🛡️ 安全隔离                                                  │
│  ├─ Docker 沙箱: 代码隔离执行                                │
│  ├─ 资源限制: CPU/内存/网络                                  │
│  └─ 权限控制: RBAC + 资源访问策略                            │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      API 层 (FastAPI)                        │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  api/v1/                                               │  │
│  │  ├─ chat.py      # 对话接口 (SSE 流式)                 │  │
│  │  ├─ agent.py     # Agent 管理                          │  │
│  │  ├─ session.py   # 会话管理                            │  │
│  │  ├─ tool.py      # 工具管理                            │  │
│  │  └─ memory.py    # 记忆管理                            │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   业务服务层 (Services)                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  services/                                              │  │
│  │  ├─ chat.py      # 对话服务 (编排 Agent Engine)         │  │
│  │  ├─ agent.py     # Agent 服务                          │  │
│  │  ├─ session.py   # 会话服务                             │  │
│  │  ├─ memory.py    # 记忆服务                             │  │
│  │  └─ checkpoint.py # 检查点服务                         │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   核心业务层 (Core)                           │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  core/                                                  │  │
│  │  ├─ engine/      # Agent 执行引擎                       │  │
│  │  ├─ context/     # 上下文管理                           │  │
│  │  ├─ memory/      # 记忆系统                             │  │
│  │  ├─ llm/         # LLM 网关                             │  │
│  │  ├─ tools/       # 工具执行                             │  │
│  │  ├─ reasoning/   # 推理模式                            │  │
│  │  ├─ routing/     # 条件路由                             │  │
│  │  ├─ sandbox/     # 沙箱执行                             │  │
│  │  └─ a2a/         # Agent-to-Agent                       │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层 (Data Access)                    │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  models/         # ORM 模型 (SQLAlchemy)                │  │
│  │  schemas/        # 数据验证 (Pydantic)                   │  │
│  │  db/             # 数据库连接                           │  │
│  │  ├─ database.py  # PostgreSQL                          │  │
│  │  ├─ redis.py     # Redis                               │  │
│  │  └─ vector.py    # 向量数据库                           │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                      依赖关系图                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  api/                                                        │
│    ↓                                                         │
│  services/                                                   │
│    ↓                                                         │
│  core/                                                       │
│    ├─ engine/ → context/, llm/, tools/, checkpointer        │
│    ├─ context/ → memory/, llm/                              │
│    ├─ memory/ → db/vector, llm/                             │
│    ├─ llm/ → (外部 API)                                      │
│    └─ tools/ → sandbox/                                     │
│    ↓                                                         │
│  models/ → db/database                                       │
│  schemas/ (独立，无依赖)                                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 目录结构

```
backend/
├── api/                    # API 路由层
│   ├── v1/                 # API v1 版本
│   ├── deps.py             # 依赖注入
│   └── errors.py           # 错误处理
│
├── app/                    # 应用入口
│   ├── main.py             # FastAPI 应用
│   └── config.py            # 配置管理
│
├── core/                   # 核心业务逻辑
│   ├── engine/             # Agent 引擎
│   │   ├── agent.py        # Main Loop
│   │   └── checkpointer.py # 检查点管理
│   ├── context/            # 上下文管理
│   ├── memory/             # 记忆系统
│   ├── llm/                # LLM 网关
│   ├── reasoning/          # 推理模式
│   ├── routing/            # 条件路由
│   ├── sandbox/            # 沙箱执行
│   ├── a2a/                # Agent-to-Agent
│   ├── auth/                # 认证授权
│   ├── lsp/                # LSP 集成
│   ├── quality/            # 代码质量
│   ├── observability/      # 可观测性
│   └── types.py            # 类型定义
│
├── models/                 # ORM 模型
├── schemas/                # Pydantic Schema
├── services/               # 业务服务层
├── db/                     # 数据库连接
├── tools/                   # 工具实现
├── middleware/             # 中间件
├── utils/                   # 工具函数
└── workers/                # 后台任务
```

---

## 核心模块

### 3.1 Agent 执行引擎

**位置**: `core/engine/agent.py`

**职责**:
- 实现 Main Loop 执行循环
- 管理 Agent 状态和生命周期
- 协调上下文、LLM、工具执行

**核心流程**:

```python
async def run(session_id, user_message) -> AsyncGenerator[AgentEvent]:
    # 1. 初始化状态
    state = AgentState(...)

    while True:
        # 2. 检查终止条件
        if should_terminate(state):
            yield AgentEvent(type="terminated", ...)
            break

        # 3. 构建上下文
        context = await context_manager.build(state)

        # 4. 保存检查点
        checkpoint_id = await checkpointer.save(state)

        # 5. 调用 LLM
        response = await llm.chat(context.messages, tools=...)

        # 6. 解析响应
        if has_tool_calls(response):
            # 7. 执行工具
            for tool_call in response.tool_calls:
                # Human-in-the-Loop 检查
                if needs_approval(tool_call):
                    yield AgentEvent(type="interrupt", ...)
                    return  # 等待人工确认

                result = await tools.execute(tool_call)
                yield AgentEvent(type="tool_result", data=result)

                # 将结果加入上下文
                state.messages.append(result)
        else:
            # 8. 返回最终结果
            yield AgentEvent(type="done", data=response)
            break
```

**关键特性**:
- ✅ 支持流式响应 (SSE)
- ✅ 检查点持久化
- ✅ 终止条件检查
- ✅ Human-in-the-Loop 中断

### 3.2 上下文管理

**位置**: `core/context/manager.py`

**职责**:
- 组装对话上下文
- Token 预算管理
- 上下文压缩策略

**上下文组成**:

```
┌─────────────────────────────────────────────────────────────┐
│                      上下文结构                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. System Prompt (~1K tokens)                              │
│     ├─ 角色定义                                              │
│     ├─ 行为准则                                              │
│     └─ 工具说明                                              │
│                                                              │
│  2. 召回记忆 (~30K tokens)                                   │
│     ├─ 相关历史对话                                          │
│     ├─ 用户偏好                                              │
│     └─ 知识片段                                              │
│                                                              │
│  3. 对话历史 (~30K tokens)                                   │
│     ├─ 最近 N 轮完整对话                                     │
│     └─ 更早对话的摘要                                        │
│                                                              │
│  4. 工具结果 (~20K tokens)                                   │
│     └─ 上一步工具执行结果                                    │
│                                                              │
│  5. 当前输入 (~N tokens)                                     │
│     └─ 用户最新消息                                          │
│                                                              │
│  输出预留: ~4K tokens                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Token 预算策略**:
- 优先级: System > 当前输入 > 工具结果 > 最近对话 > 召回记忆 > 历史摘要
- 超出预算时: 按优先级裁剪，保留核心内容

### 3.3 记忆系统

**位置**: `core/memory/`

**架构**:

```
┌─────────────────────────────────────────────────────────────┐
│                      记忆系统架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  L1: 工作记忆 (Working Memory)                               │
│  ├─ 位置: 内存                                               │
│  ├─ 周期: 单次循环                                           │
│  └─ 内容: 当前任务状态、工具返回值                            │
│                                                              │
│  L2: 会话记忆 (Session Memory)                               │
│  ├─ 位置: Redis                                              │
│  ├─ 周期: 当前会话                                           │
│  └─ 内容: 完整对话历史、会话配置                              │
│                                                              │
│  L3: 长期记忆 (Long-term Memory)                             │
│  ├─ 位置: PostgreSQL + 向量数据库                            │
│  ├─ 周期: 持久化                                             │
│  └─ 内容:                                                    │
│      ├─ 事实记忆 (Semantic): 用户偏好、知识事实               │
│      ├─ 经验记忆 (Episodic): 历史对话摘要、关键决策           │
│      └─ 程序记忆 (Procedural): 常用工作流、最佳实践           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**记忆检索策略**:
1. 向量相似度检索 (语义相关)
2. 关键词精确匹配
3. 时间相关性 (最近优先)
4. 重要性评分 (用户标记/访问频率)

**综合评分公式**:
```
Score = 相似度 × 0.5 + 时效性 × 0.3 + 重要性 × 0.2
```

### 3.4 工具系统

**位置**: `tools/` + `core/sandbox/`

**工具分类**:

| 类型 | 工具示例 | 执行方式 |
|------|---------|---------|
| **文件操作** | `read_file`, `write_file`, `edit_file` | 直接执行 |
| **代码执行** | `run_python`, `run_shell` | Docker 沙箱 |
| **网络请求** | `web_search`, `http_request` | 直接执行 |
| **数据库** | `query_db`, `vector_search` | 直接执行 |
| **MCP 扩展** | 第三方工具 (通过 MCP 协议) | MCP 客户端 |
| **A2A 调用** | `call_analyst`, `call_coder` | Agent 间通信 |

**工具执行流程**:

```
LLM 返回工具调用
    ↓
1. 参数校验 (Pydantic)
    ↓
2. Human-in-the-Loop 检查
    ├─ 需要确认 → 保存检查点，暂停等待
    └─ 自动批准 → 继续执行
    ↓
3. 执行工具
    ├─ 代码类 → Docker 沙箱
    └─ 普通类 → 直接执行
    ↓
4. 结果处理
    ├─ 截断过长内容
    ├─ 敏感信息脱敏
    └─ 格式化输出
    ↓
5. 保存检查点
    ↓
结果加入上下文，继续循环
```

**沙箱执行器** (`core/sandbox/executor.py`):

- **隔离级别**: Docker 容器
- **资源限制**: CPU、内存、网络
- **超时控制**: 自动终止长时间运行的任务
- **自动清理**: 执行完成后删除容器

### 3.5 推理模式

**位置**: `core/reasoning/`

**支持的推理模式**:

| 模式 | 文件 | 适用场景 |
|------|------|---------|
| **ReAct** | `react.py` | 需要工具的复杂任务 |
| **Plan-Act** | `plan_act.py` | 多步骤任务 |
| **CoT** | `cot.py` | 数学计算、逻辑分析 |
| **ToT** | `tot.py` | 创意生成、策略规划 |
| **Reflect** | `reflect.py` | 高质量输出要求 |

**基类设计** (`base.py`):

```python
class BaseReasoningMode(ABC):
    """推理模式基类"""

    @abstractmethod
    async def reason(
        self,
        context: Context,
        tools: list[Tool],
    ) -> ReasoningResult:
        """执行推理"""
        ...
```

**模式切换**:
- 通过 `AgentConfig.reasoning_mode` 配置
- 运行时动态切换（未来支持）

### 3.6 LLM 网关

**位置**: `core/llm/gateway.py`

**功能**:
- 统一多模型接口 (基于 LiteLLM)
- 模型路由与负载均衡
- Fallback 降级策略
- 流式响应支持

**支持的模型**:

| 提供商 | 模型示例 | 用途 |
|--------|---------|------|
| **Anthropic** | Claude 3.5 Sonnet | 主力模型 |
| **OpenAI** | GPT-4o, GPT-4o-mini | 备用/快速响应 |
| **DashScope** | Qwen2.5 | 国产模型 |
| **DeepSeek** | DeepSeek-V3 | 高性价比 |
| **火山引擎** | Doubao-pro | 国产模型 |
| **智谱AI** | GLM-4 | 国产模型 |
| **本地** | Ollama | 数据安全 |

**路由策略**:
- 任务类型路由: 根据任务复杂度选择模型
- 成本优化路由: 优先使用低成本模型
- 延迟优先路由: 优先使用快速模型
- 质量优先路由: 优先使用高质量模型

### 3.7 检查点系统

**位置**: `core/engine/checkpointer.py`

**功能**:
- 状态持久化 (每步操作后保存)
- 崩溃恢复 (从最后检查点恢复)
- 时间旅行调试 (查看历史状态)

**存储后端**:
- **开发环境**: Redis (TTL: 7天)
- **生产环境**: PostgreSQL (持久化)

**检查点数据结构**:

```python
class Checkpoint(BaseModel):
    id: str
    session_id: str
    step: int
    state: AgentState  # 完整状态快照
    created_at: datetime
    parent_id: str | None  # 支持分支
```

**使用场景**:
1. **崩溃恢复**: 系统崩溃后从最后检查点恢复执行
2. **Human-in-the-Loop**: 在检查点暂停等待人工确认
3. **时间旅行调试**: 查看任意历史状态，从历史状态重新执行
4. **状态对比**: 对比不同执行路径的结果

### 3.8 Human-in-the-Loop

**位置**: `core/engine/agent.py` (集成在 Main Loop)

**中断机制**:

```
Agent 准备执行工具
    ↓
检查工具是否在 interrupt_before 列表
    ↓
是 → 保存检查点，返回 InterruptEvent
    ↓
前端展示待确认操作
    ↓
用户选择: [批准] [修改] [拒绝]
    ↓
调用 /chat/resume API
    ↓
继续执行或返回错误
```

**配置** (`app/config.py`):

```python
hitl_enabled: bool = True
hitl_interrupt_tools: list[str] = [
    "run_shell", "write_file", "delete_file", "send_email"
]
hitl_auto_approve_patterns: list[str] = [
    "read_*", "search_*", "list_*"
]
```

---

## 技术栈

### 4.1 核心技术

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **Web 框架** | FastAPI | 0.109+ | API 服务 |
| **异步运行时** | asyncio + uvicorn | - | 异步处理 |
| **ORM** | SQLAlchemy | 2.0+ | 数据库操作 |
| **数据验证** | Pydantic | 2.5+ | 请求/响应验证 |
| **LLM 统一接口** | LiteLLM | 1.20+ | 多模型支持 |
| **向量数据库** | Qdrant / Chroma | - | 记忆存储 |
| **缓存** | Redis | 7+ | 会话/检查点 |
| **任务队列** | Celery | 5.3+ | 异步任务 |
| **类型检查** | Pyright | 1.1+ | 静态类型检查 |
| **代码检查** | Ruff | 0.2+ | Linting + 格式化 |

### 4.2 数据库

| 数据库 | 用途 | 连接方式 |
|--------|------|---------|
| **PostgreSQL** | 主数据库 (用户、会话、消息) | SQLAlchemy 异步 |
| **Redis** | 缓存、会话状态、检查点 | redis.asyncio |
| **Qdrant/Chroma** | 向量存储 (记忆检索) | 客户端 SDK |

### 4.3 外部服务

| 服务 | 用途 | 集成方式 |
|------|------|---------|
| **LLM API** | 模型推理 | LiteLLM 统一接口 |
| **Docker** | 代码沙箱 | docker SDK |
| **LSP Server** | 代码智能 | 语言服务器协议 |

---

## 数据流

### 5.1 对话请求流程

```
用户请求
    ↓
API 层 (api/v1/chat.py)
    ├─ 参数验证 (Pydantic Schema)
    ├─ 认证授权 (JWT)
    └─ 依赖注入 (Services)
    ↓
服务层 (services/chat.py)
    ├─ 获取会话
    ├─ 创建 Agent Engine
    └─ 启动执行循环
    ↓
核心层 (core/engine/agent.py)
    ├─ Main Loop
    ├─ 上下文管理
    ├─ LLM 调用
    ├─ 工具执行
    └─ 检查点保存
    ↓
数据层
    ├─ 保存消息 (PostgreSQL)
    ├─ 更新会话状态 (Redis)
    └─ 存储记忆 (向量数据库)
    ↓
流式响应 (SSE)
    └─ 返回给前端
```

### 5.2 工具执行流程

```
LLM 返回工具调用
    ↓
解析工具调用 (ToolCall)
    ↓
参数校验 (Pydantic)
    ↓
Human-in-the-Loop 检查
    ├─ 需要确认 → 保存检查点，暂停
    └─ 自动批准 → 继续
    ↓
工具执行
    ├─ 代码类 → Docker 沙箱
    │   ├─ 创建容器
    │   ├─ 执行代码
    │   ├─ 捕获输出
    │   └─ 清理容器
    └─ 普通类 → 直接执行
    ↓
结果处理
    ├─ 格式化输出
    ├─ 截断过长内容
    └─ 敏感信息脱敏
    ↓
保存检查点
    ↓
结果加入上下文
    ↓
继续 Main Loop
```

### 5.3 记忆检索流程

```
用户输入
    ↓
生成查询向量 (LLM Embedding)
    ↓
向量数据库检索
    ├─ 语义相似度搜索
    └─ 关键词匹配
    ↓
综合评分排序
    Score = 相似度 × 0.5 + 时效性 × 0.3 + 重要性 × 0.2
    ↓
按 Token 预算截断
    ↓
格式化记忆内容
    ↓
加入上下文
```

---

## 部署架构

### 6.1 容器化部署

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Compose 架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Frontend   │  │   Backend    │  │    Celery    │      │
│  │   (Nginx)    │  │  (FastAPI)   │  │   Worker     │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                  │              │
│         └─────────────────┼──────────────────┘              │
│                           │                                  │
│         ┌─────────────────┼──────────────────┐              │
│         │                 │                  │              │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐      │
│  │ PostgreSQL │  │    Redis     │  │    Qdrant     │      │
│  │  (主数据库)  │  │   (缓存)     │  │  (向量库)     │      │
│  └────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 生产环境架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes 部署架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Ingress (Nginx)                         │  │
│  └──────────────────────────────────────────────────────┘  │
│                           │                                  │
│         ┌─────────────────┼─────────────────┐              │
│         │                 │                 │              │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌──────▼──────┐      │
│  │  Backend    │  │   Backend    │  │   Backend    │      │
│  │  Pod 1      │  │   Pod 2      │  │   Pod N      │      │
│  └──────┬──────┘  └───────┬──────┘  └──────┬──────┘      │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           │                                  │
│  ┌───────────────────────▼──────────────────────────────┐  │
│  │              StatefulSet / External                    │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │  │PostgreSQL│  │  Redis   │  │  Qdrant  │           │  │
│  │  └──────────┘  └──────────┘  └──────────┘           │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 环境配置

**开发环境**:
- 单机部署 (Docker Compose)
- 本地数据库
- 开发工具 (热重载、调试)

**生产环境**:
- Kubernetes 集群
- 高可用数据库 (主从复制)
- 负载均衡
- 监控告警

---

## 安全架构

### 7.1 安全层次

```
┌─────────────────────────────────────────────────────────────┐
│                      安全架构层次                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  L1: 边界安全                                                 │
│  ├─ API 认证 (JWT/OAuth)                                     │
│  ├─ 请求限流 (Rate Limiting)                                 │
│  └─ 输入验证 (Pydantic)                                      │
│                                                              │
│  L2: 访问控制                                                 │
│  ├─ 用户认证 (JWT Token)                                     │
│  ├─ 角色权限 (RBAC)                                          │
│  └─ 资源访问策略                                             │
│                                                              │
│  L3: 执行隔离                                                 │
│  ├─ 代码沙箱 (Docker)                                        │
│  ├─ 容器隔离 (资源限制)                                       │
│  └─ 网络隔离 (可选禁用网络)                                   │
│                                                              │
│  L4: 数据安全                                                 │
│  ├─ 敏感数据脱敏                                             │
│  ├─ 传输加密 (TLS)                                           │
│  └─ 存储加密 (AES)                                           │
│                                                              │
│  L5: 审计追踪                                                 │
│  ├─ 操作日志                                                 │
│  ├─ 行为审计                                                 │
│  └─ 异常检测                                                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 Human-in-the-Loop 控制

**风险分级**:

| 风险级别 | 操作类型 | 处理方式 |
|---------|---------|---------|
| **低风险** | 读取/查询 | 自动执行 |
| **中风险** | 可撤销写入 | 通知 + 自动执行 |
| **高风险** | 删除/发布/支付 | 等待人工确认 |

**配置示例**:

```python
# 高风险工具 (必须人工确认)
hitl_interrupt_tools = [
    "run_shell",      # Shell 命令
    "write_file",     # 写文件
    "delete_file",    # 删除文件
    "send_email",     # 发送邮件
]

# 自动批准模式 (低风险操作)
hitl_auto_approve_patterns = [
    "read_*",         # 读操作
    "search_*",       # 搜索操作
    "list_*",         # 列表操作
]
```

### 7.3 沙箱安全

**Docker 沙箱配置**:

```python
sandbox_config = {
    "image": "python:3.11-slim",
    "timeout": 60,                    # 超时 60 秒
    "memory_limit": "512m",           # 内存限制
    "cpu_limit": 1.0,                 # CPU 限制
    "network_mode": "none",           # 禁用网络
    "read_only": True,                # 只读文件系统
    "auto_remove": True,              # 执行完自动删除
}
```

---

## 可扩展性设计

### 8.1 水平扩展

**无状态设计**:
- API 层无状态，可水平扩展
- 会话状态存储在 Redis (共享)
- 检查点存储在 PostgreSQL (共享)

**扩展点**:
- 增加 Backend Pod 数量
- 增加 Celery Worker 数量
- 数据库连接池配置

### 8.2 模块化设计

**抽象接口**:
- `VectorStore` (ABC): 向量数据库抽象
- `BaseTool` (ABC): 工具基类
- `BaseReasoningMode` (ABC): 推理模式基类
- `SandboxExecutor` (ABC): 沙箱执行器抽象

**扩展方式**:
1. **新增工具**: 继承 `BaseTool` 或实现 `ToolProtocol`
2. **新增推理模式**: 继承 `BaseReasoningMode`
3. **新增向量数据库**: 实现 `VectorStore` 接口
4. **新增沙箱**: 实现 `SandboxExecutor` 接口

### 8.3 配置驱动

**环境变量配置**:
- 模型切换: 通过 `DEFAULT_MODEL` 环境变量
- 数据库切换: 通过 `DATABASE_URL` 环境变量
- 功能开关: 通过 `HITL_ENABLED` 等配置

---

## 性能优化

### 9.1 异步处理

**全异步架构**:
- FastAPI 异步路由
- SQLAlchemy 异步 ORM
- Redis 异步客户端
- 流式响应 (SSE)

**并发控制**:
- 使用 `asyncio.Semaphore` 限制并发数
- 批量处理使用 `asyncio.gather`

### 9.2 缓存策略

**多级缓存**:
- **L1**: 内存缓存 (Python dict)
- **L2**: Redis 缓存 (会话状态、检查点)
- **L3**: 数据库 (持久化)

**缓存内容**:
- 用户信息
- 会话状态
- 工具定义
- 模型配置

### 9.3 数据库优化

**索引策略**:
- 主键索引 (自动)
- 外键索引 (自动)
- 查询字段索引 (手动创建)

**查询优化**:
- 使用 `selectinload` 预加载关联
- 分页查询 (避免全表扫描)
- 批量操作 (减少数据库往返)

---

## 监控与可观测性

### 10.1 日志系统

**位置**: `core/observability/logging.py`

**日志级别**:
- DEBUG: 详细调试信息
- INFO: 一般信息 (请求、响应)
- WARNING: 警告 (验证失败、降级)
- ERROR: 错误 (异常、失败)
- CRITICAL: 严重错误 (系统故障)

**日志格式**:
- 开发环境: 文本格式 (可读)
- 生产环境: JSON 格式 (结构化)

### 10.2 指标收集

**位置**: `core/observability/metrics.py`

**收集指标**:
- **系统指标**: CPU、内存、磁盘、网络
- **业务指标**: 请求数、响应时间、错误率
- **AI 指标**: Token 消耗、模型调用次数、工具调用分布

**指标类型**:
- Counter: 累计计数 (请求数、错误数)
- Gauge: 当前值 (内存使用、活跃会话)
- Histogram: 分布 (响应时间、Token 数)

### 10.3 分布式追踪

**位置**: `core/observability/tracing.py`

**追踪内容**:
- 请求链路: API → Service → Core → Database
- Agent 执行: Main Loop → LLM → Tools
- 工具调用: 工具执行时间、结果

**追踪工具**:
- OpenTelemetry (标准)
- Jaeger (可视化)

### 10.4 健康检查

**端点**: `GET /health`

**检查项**:
- 数据库连接
- Redis 连接
- 向量数据库连接
- 外部服务 (LLM API)

---

## 附录

### A. 核心类型定义

**位置**: `core/types.py`

**主要类型**:
- `AgentConfig`: Agent 配置
- `AgentState`: Agent 状态
- `AgentEvent`: Agent 事件
- `ToolCall`: 工具调用
- `ToolResult`: 工具结果
- `Message`: 消息
- `Checkpoint`: 检查点

### B. 配置说明

**位置**: `app/config.py`

**主要配置**:
- 数据库连接
- LLM API Keys
- 沙箱配置
- Human-in-the-Loop 配置
- 检查点配置

### C. API 文档

**Swagger UI**: `http://localhost:8000/docs`

**ReDoc**: `http://localhost:8000/redoc`

### D. 相关文档

- [代码规范](CODE_STANDARDS.md)
- [目录结构分析](DIRECTORY_STRUCTURE_ANALYSIS.md)
- [开发指南](DEVELOPMENT.md)

---

<div align="center">

**构建可靠、可扩展的 AI Agent 系统**

*文档版本: v1.0.0 | 最后更新: 2026-01-14*

</div>
