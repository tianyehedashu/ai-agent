# ğŸ”§ æ‰§è¡Œç¯å¢ƒé…ç½®è®¾è®¡æ–‡æ¡£

> Agent å·¥ä½œå°æ‰§è¡Œç¯å¢ƒã€å·¥å…·ã€Shell çš„ç»Ÿä¸€é…ç½®ç³»ç»Ÿ

---

## ä¸€ã€æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

ä¸º Agent å·¥ä½œå°æä¾›**å®Œæ•´çš„æ‰§è¡Œç¯å¢ƒé…ç½®ç³»ç»Ÿ**ï¼Œæ”¯æŒï¼š

- **æ²™ç®±é…ç½®** - Docker/æœ¬åœ°æ‰§è¡Œã€èµ„æºé™åˆ¶ã€ç½‘ç»œéš”ç¦»
- **å·¥å…·é…ç½®** - å†…ç½®å·¥å…·å¯ç”¨/ç¦ç”¨ã€å‚æ•°é…ç½®
- **Shell ç¯å¢ƒ** - å·¥ä½œç›®å½•ã€ç¯å¢ƒå˜é‡ã€Shell ç±»å‹
- **MCP æœåŠ¡å™¨** - Model Context Protocol å·¥å…·æœåŠ¡å™¨
- **å®‰å…¨ç­–ç•¥** - æƒé™æ§åˆ¶ã€æ•æ„Ÿæ“ä½œå®¡æ‰¹

### 1.2 è®¾è®¡åŸåˆ™

1. **Code-First** - é…ç½®ä»¥ TOML æ–‡ä»¶ä¸ºä¸»ï¼ŒUI ä¸ºå¯è§†åŒ–ç¼–è¾‘å™¨
2. **åˆ†å±‚è¦†ç›–** - ç³»ç»Ÿé»˜è®¤ â†’ ç¯å¢ƒæ¨¡æ¿ â†’ Agenté…ç½® â†’ è¿è¡Œæ—¶å‚æ•°
3. **å®‰å…¨ä¼˜å…ˆ** - é»˜è®¤æœ€å°æƒé™ï¼Œå±é™©æ“ä½œéœ€ç¡®è®¤
4. **å¯æ‰©å±•** - æ”¯æŒè‡ªå®šä¹‰å·¥å…·ã€MCP æœåŠ¡å™¨

### 1.3 é…ç½®å±‚çº§

```
é…ç½®ä¼˜å…ˆçº§ (ä»ä½åˆ°é«˜)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Level 4: è¿è¡Œæ—¶å‚æ•° (Runtime)                  â”‚  â† API è°ƒç”¨æ—¶ä¼ å…¥
  â”‚  ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸´æ—¶è¦†ç›–                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² è¦†ç›–
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Level 3: Agent é…ç½® (agent.toml)               â”‚  â† æ¯ä¸ª Agent ç‹¬ç«‹
  â”‚  å·¥å…·é€‰æ‹©ã€ç‰¹å®šç¯å¢ƒå˜é‡ã€è‡ªå®šä¹‰æ²™ç®±              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² è¦†ç›–
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Level 2: ç¯å¢ƒæ¨¡æ¿ (environments/*.toml)        â”‚  â† å¯å¤ç”¨æ¨¡æ¿
  â”‚  å¦‚: python-dev, node-dev, data-science         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–² è¦†ç›–
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Level 1: ç³»ç»Ÿé»˜è®¤ (config/execution.toml)      â”‚  â† å…¨å±€é»˜è®¤
  â”‚  é»˜è®¤æ²™ç®±é…ç½®ã€é»˜è®¤å·¥å…·ã€é»˜è®¤ MCP æœåŠ¡å™¨         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ execution.toml              # Level 1: ç³»ç»Ÿé»˜è®¤æ‰§è¡Œç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ tools.toml                  # å·¥å…·å®šä¹‰å’Œé»˜è®¤é…ç½®
â”‚   â”œâ”€â”€ mcp.toml                    # MCP æœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ environments/               # Level 2: ç¯å¢ƒæ¨¡æ¿
â”‚       â”œâ”€â”€ python-dev.toml         # Python å¼€å‘ç¯å¢ƒ
â”‚       â”œâ”€â”€ node-dev.toml           # Node.js å¼€å‘ç¯å¢ƒ
â”‚       â”œâ”€â”€ data-science.toml       # æ•°æ®ç§‘å­¦ç¯å¢ƒ
â”‚       â””â”€â”€ minimal.toml            # æœ€å°åŒ–ç¯å¢ƒ
â”‚
â”œâ”€â”€ agents/                         # Level 3: Agent ç‹¬ç«‹é…ç½®
â”‚   â””â”€â”€ {agent_id}/
â”‚       â”œâ”€â”€ agent.toml              # Agent æ‰§è¡Œç¯å¢ƒé…ç½®
â”‚       â”œâ”€â”€ workflow.py             # å·¥ä½œæµä»£ç 
â”‚       â””â”€â”€ .env                    # Agent æ•æ„Ÿç¯å¢ƒå˜é‡
â”‚
â”œâ”€â”€ core/
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ execution_config.py     # é…ç½®æ¨¡å‹å®šä¹‰
â”‚       â””â”€â”€ execution_loader.py     # é…ç½®åŠ è½½å™¨
â”‚
â””â”€â”€ api/v1/
    â””â”€â”€ execution.py                # æ‰§è¡Œç¯å¢ƒ API
```

---

## ä¸‰ã€é…ç½®æ–‡ä»¶æ ¼å¼

### 3.1 ç³»ç»Ÿé»˜è®¤é…ç½® (`config/execution.toml`)

```toml
# =============================================================================
# æ‰§è¡Œç¯å¢ƒç³»ç»Ÿé»˜è®¤é…ç½®
# =============================================================================

[metadata]
version = "1.0"
description = "ç³»ç»Ÿé»˜è®¤æ‰§è¡Œç¯å¢ƒé…ç½®"

# -----------------------------------------------------------------------------
# æ²™ç®±é…ç½®
# -----------------------------------------------------------------------------
[sandbox]
# æ‰§è¡Œæ¨¡å¼: "docker" | "local" | "remote"
mode = "docker"
timeout_seconds = 30

[sandbox.resources]
memory_limit = "256m"
cpu_limit = 1.0
disk_limit = "1g"

[sandbox.network]
enabled = false
allowed_hosts = []

[sandbox.security]
read_only_root = true
no_new_privileges = true
drop_capabilities = ["ALL"]

# -----------------------------------------------------------------------------
# Shell ç¯å¢ƒé…ç½®
# -----------------------------------------------------------------------------
[shell]
default_shell = "/bin/bash"
work_dir = "/workspace"

[shell.env]
LANG = "en_US.UTF-8"
TZ = "Asia/Shanghai"
PYTHONUNBUFFERED = "1"

# -----------------------------------------------------------------------------
# å·¥å…·é…ç½®
# -----------------------------------------------------------------------------
[tools]
enabled = [
    "read_file",
    "write_file",
    "list_directory",
    "search_files",
    "run_python",
    "run_shell",
]

require_confirmation = [
    "write_file",
    "delete_file",
    "run_shell",
    "http_request",
]

auto_approve_patterns = [
    "read_*",
    "list_*",
    "search_*",
]

# -----------------------------------------------------------------------------
# MCP æœåŠ¡å™¨é…ç½®
# -----------------------------------------------------------------------------
[mcp.servers]
# ç¤ºä¾‹é…ç½®
# filesystem = { url = "http://localhost:3000", enabled = true }

# -----------------------------------------------------------------------------
# æ—¥å¿—é…ç½®
# -----------------------------------------------------------------------------
[logging]
level = "info"
retention_days = 7
log_tool_calls = true
```

### 3.2 ç¯å¢ƒæ¨¡æ¿ç¤ºä¾‹ (`config/environments/python-dev.toml`)

```toml
# =============================================================================
# Python å¼€å‘ç¯å¢ƒæ¨¡æ¿
# =============================================================================

[metadata]
name = "python-dev"
description = "Python å¼€å‘ç¯å¢ƒï¼Œé¢„è£…å¸¸ç”¨åº“"
tags = ["python", "development", "data"]

extends = ""  # ç»§æ‰¿ç³»ç»Ÿé»˜è®¤

# -----------------------------------------------------------------------------
# æ²™ç®±é…ç½®è¦†ç›–
# -----------------------------------------------------------------------------
[sandbox]
timeout_seconds = 60

[sandbox.docker]
image = "python:3.11-slim"
packages = [
    "pandas",
    "numpy",
    "requests",
    "beautifulsoup4",
]

[sandbox.resources]
memory_limit = "512m"
cpu_limit = 2.0

[sandbox.network]
enabled = true
allowed_hosts = [
    "pypi.org",
    "files.pythonhosted.org",
]

# -----------------------------------------------------------------------------
# Shell ç¯å¢ƒè¦†ç›–
# -----------------------------------------------------------------------------
[shell.env]
PYTHONPATH = "/workspace/src"
PIP_NO_CACHE_DIR = "1"

# -----------------------------------------------------------------------------
# å·¥å…·é…ç½®è¦†ç›–
# -----------------------------------------------------------------------------
[tools]
enabled = [
    "read_file",
    "write_file",
    "list_directory",
    "search_files",
    "run_python",
    "run_shell",
    "http_request",
    "install_package",
]
```

### 3.3 Agent é…ç½® (`agents/{agent_id}/agent.toml`)

```toml
# =============================================================================
# Agent æ‰§è¡Œç¯å¢ƒé…ç½®
# =============================================================================

[metadata]
agent_id = "research-assistant"
name = "ç ”ç©¶åŠ©æ‰‹"
description = "æ”¯æŒç½‘ç»œæœç´¢ã€æ•°æ®åˆ†æçš„ç ”ç©¶åŠ©æ‰‹"

# ç»§æ‰¿ç¯å¢ƒæ¨¡æ¿
extends = "python-dev"

# -----------------------------------------------------------------------------
# Agent çº§åˆ«é…ç½®è¦†ç›–
# -----------------------------------------------------------------------------
[sandbox]
timeout_seconds = 120

[sandbox.resources]
memory_limit = "1g"

[sandbox.network]
enabled = true
allowed_hosts = [
    "api.search.com",
    "arxiv.org",
    "github.com",
]

# -----------------------------------------------------------------------------
# Agent ç‰¹å®šç¯å¢ƒå˜é‡
# -----------------------------------------------------------------------------
[shell.env]
SEARCH_API_KEY = "${SEARCH_API_KEY}"
RESEARCH_OUTPUT_DIR = "/workspace/output"

# -----------------------------------------------------------------------------
# å·¥å…·é…ç½®
# -----------------------------------------------------------------------------
[tools]
enabled = [
    "web_search",
    "fetch_url",
    "save_artifact",
]

[tools.config.web_search]
provider = "tavily"
max_results = 10

# -----------------------------------------------------------------------------
# MCP æœåŠ¡å™¨é…ç½®
# -----------------------------------------------------------------------------
[mcp.servers]
browser = { url = "http://localhost:3001", enabled = true }

# -----------------------------------------------------------------------------
# Human-in-the-Loop é…ç½®
# -----------------------------------------------------------------------------
[hitl]
require_confirmation = [
    "write_file",
    "http_request",
]

auto_approve_patterns = [
    "read_*",
    "fetch_url",
]
```

---

## å››ã€å·¥å…·å®šä¹‰ (`config/tools.toml`)

```toml
# =============================================================================
# å·¥å…·å®šä¹‰ä¸é…ç½®
# =============================================================================

[metadata]
version = "1.0"

# =============================================================================
# æ–‡ä»¶æ“ä½œå·¥å…·
# =============================================================================
[tools.read_file]
name = "read_file"
description = "è¯»å–æ–‡ä»¶å†…å®¹"
category = "file"
requires_confirmation = false
enabled_by_default = true

[tools.read_file.parameters]
path = { type = "string", description = "æ–‡ä»¶è·¯å¾„", required = true }
encoding = { type = "string", default = "utf-8" }

[tools.read_file.constraints]
max_file_size = "10m"
blocked_paths = ["/etc/passwd", "/etc/shadow", "**/.env"]

# -----------------------------------------------------------------------------
[tools.write_file]
name = "write_file"
description = "å†™å…¥æ–‡ä»¶å†…å®¹"
category = "file"
requires_confirmation = true
enabled_by_default = true

[tools.write_file.constraints]
max_file_size = "5m"
workspace_only = true

# =============================================================================
# ä»£ç æ‰§è¡Œå·¥å…·
# =============================================================================
[tools.run_python]
name = "run_python"
description = "æ‰§è¡Œ Python ä»£ç "
category = "code"
requires_confirmation = false
enabled_by_default = true

[tools.run_python.config]
blocked_imports = [
    "subprocess",
    "os.system",
]

# -----------------------------------------------------------------------------
[tools.run_shell]
name = "run_shell"
description = "æ‰§è¡Œ Shell å‘½ä»¤"
category = "code"
requires_confirmation = true
enabled_by_default = true

[tools.run_shell.config]
blocked_commands = [
    "rm -rf /",
    "dd if=",
    "chmod 777",
]

# =============================================================================
# ç½‘ç»œå·¥å…·
# =============================================================================
[tools.http_request]
name = "http_request"
description = "å‘é€ HTTP è¯·æ±‚"
category = "network"
requires_confirmation = true
enabled_by_default = false

[tools.http_request.config]
auto_approve_methods = ["GET", "HEAD"]

[tools.http_request.constraints]
blocked_hosts = ["localhost", "127.0.0.1", "*.internal"]
```

---

## äº”ã€MCP æœåŠ¡å™¨é…ç½® (`config/mcp.toml`)

```toml
# =============================================================================
# MCP æœåŠ¡å™¨é…ç½®
# =============================================================================

[settings]
connection_timeout = 10
tool_timeout = 60
max_retries = 3
cache_tools = true
cache_ttl = 300

# -----------------------------------------------------------------------------
# é¢„å®šä¹‰ MCP æœåŠ¡å™¨
# -----------------------------------------------------------------------------

[servers.filesystem]
name = "Filesystem"
description = "æ–‡ä»¶ç³»ç»Ÿæ“ä½œå·¥å…·"
url = "stdio://npx -y @anthropic/mcp-server-filesystem"
transport = "stdio"
enabled = true
auto_start = true

[servers.filesystem.config]
allowed_directories = ["${WORKSPACE}"]

# -----------------------------------------------------------------------------
[servers.git]
name = "Git"
description = "Git ç‰ˆæœ¬æ§åˆ¶æ“ä½œ"
url = "stdio://npx -y @anthropic/mcp-server-git"
transport = "stdio"
enabled = true

# -----------------------------------------------------------------------------
[servers.browser]
name = "Browser"
description = "æµè§ˆå™¨è‡ªåŠ¨åŒ–å·¥å…·"
url = "http://localhost:3001"
transport = "http"
enabled = false
api_key_env = "BROWSER_MCP_KEY"

[servers.browser.config]
headless = true
timeout = 30
```

---

## å…­ã€API æ¥å£

### 6.1 ç«¯ç‚¹åˆ—è¡¨

```
/api/v1/execution
â”‚
â”œâ”€â”€ GET    /templates                    # åˆ—å‡ºç¯å¢ƒæ¨¡æ¿
â”œâ”€â”€ GET    /templates/{name}             # è·å–æ¨¡æ¿è¯¦æƒ…
â”œâ”€â”€ GET    /agents/{id}/config           # è·å– Agent é…ç½®
â”œâ”€â”€ PUT    /agents/{id}/config           # æ›´æ–° Agent é…ç½®
â”œâ”€â”€ POST   /validate                     # éªŒè¯é…ç½®
â”œâ”€â”€ POST   /agents/{id}/preview          # é¢„è§ˆåˆå¹¶åé…ç½®
â”œâ”€â”€ GET    /tools                        # åˆ—å‡ºå·¥å…·å®šä¹‰
â””â”€â”€ GET    /mcp/servers                  # åˆ—å‡º MCP æœåŠ¡å™¨
```

### 6.2 ä½¿ç”¨ç¤ºä¾‹

**è·å– Agent åˆå¹¶åçš„å®Œæ•´é…ç½®ï¼š**

```bash
GET /api/v1/execution/agents/research-assistant/config?resolve=true
```

**é¢„è§ˆè¿è¡Œæ—¶è¦†ç›–æ•ˆæœï¼š**

```bash
POST /api/v1/execution/agents/research-assistant/preview
Content-Type: application/json

{
  "sandbox": {
    "timeout_seconds": 180
  },
  "shell": {
    "env": {
      "DEBUG": "true"
    }
  }
}
```

**éªŒè¯é…ç½®ï¼š**

```bash
POST /api/v1/execution/validate
Content-Type: application/json

{
  "sandbox": {
    "mode": "docker",
    "timeout_seconds": 60
  }
}
```

---

## ä¸ƒã€é…ç½®åŠ è½½æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é…ç½®åŠ è½½æµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ExecutionConfigLoader.load_for_agent(agent_id, runtime_overrides)         â”‚
â”‚                                                                             â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. åŠ è½½ç³»ç»Ÿé»˜è®¤é…ç½®                                                 â”‚   â”‚
â”‚  â”‚     config/execution.toml                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. åŠ è½½ Agent é…ç½®                                                  â”‚   â”‚
â”‚  â”‚     agents/{agent_id}/agent.toml                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. æ£€æŸ¥ extends å­—æ®µï¼ŒåŠ è½½ç¯å¢ƒæ¨¡æ¿                                   â”‚   â”‚
â”‚  â”‚     config/environments/{template}.toml                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. åˆ†å±‚åˆå¹¶é…ç½®                                                     â”‚   â”‚
â”‚  â”‚     ç³»ç»Ÿé»˜è®¤ â†’ ç¯å¢ƒæ¨¡æ¿ â†’ Agenté…ç½® â†’ è¿è¡Œæ—¶å‚æ•°                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5. è§£æç¯å¢ƒå˜é‡                                                     â”‚   â”‚
â”‚  â”‚     ${VAR} â†’ os.environ.get("VAR")                                   â”‚   â”‚
â”‚  â”‚     ${VAR:default} â†’ os.environ.get("VAR", "default")                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  6. è¿”å› ExecutionConfig å¯¹è±¡                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

### 8.1 æ²™ç®±æ‰§è¡Œå™¨

```python
from core.config.execution_loader import ExecutionConfigLoader

# åŠ è½½é…ç½®
loader = ExecutionConfigLoader()
config = loader.load_for_agent("research-assistant")

# åˆ›å»ºæ‰§è¡Œå™¨
from core.sandbox.executor import ExecutorFactory
executor = ExecutorFactory.create(config)

# æ‰§è¡Œä»£ç 
result = await executor.execute_python("print('Hello')")
```

### 8.2 å·¥å…·æ³¨å†Œè¡¨

```python
from domains.runtime.infrastructure.tools.registry import ConfiguredToolRegistry

# åˆ›å»ºé…ç½®åŒ–çš„å·¥å…·æ³¨å†Œè¡¨
registry = ConfiguredToolRegistry(config)

# è·å–å¯ç”¨çš„å·¥å…·
tools = registry.list_all()

# æ£€æŸ¥æ˜¯å¦éœ€è¦ç¡®è®¤
if registry.requires_confirmation("write_file"):
    # è¯·æ±‚ç”¨æˆ·ç¡®è®¤
    pass
```

### 8.3 MCP ç®¡ç†å™¨

```python
from domains.runtime.infrastructure.tools.mcp.client import ConfiguredMCPManager

# åˆ›å»º MCP ç®¡ç†å™¨
mcp_manager = ConfiguredMCPManager(config)
await mcp_manager.initialize()

# åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·
tools = await mcp_manager.list_all_tools()

# è°ƒç”¨å·¥å…·
result = await mcp_manager.call_tool("browser", "screenshot", {"url": "..."})
```

---

## ä¹ã€å®‰å…¨è€ƒè™‘

### 9.1 é»˜è®¤å®‰å…¨ç­–ç•¥

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `sandbox.mode` | `docker` | ä½¿ç”¨å®¹å™¨éš”ç¦» |
| `sandbox.network.enabled` | `false` | é»˜è®¤ç¦ç”¨ç½‘ç»œ |
| `sandbox.security.read_only_root` | `true` | åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ |
| `sandbox.security.no_new_privileges` | `true` | ç¦æ­¢ææƒ |
| `tools.require_confirmation` | å±é™©æ“ä½œåˆ—è¡¨ | éœ€äººå·¥ç¡®è®¤ |

### 9.2 å±é™©æ“ä½œæ¸…å•

ä»¥ä¸‹æ“ä½œé»˜è®¤éœ€è¦äººå·¥ç¡®è®¤ï¼š

- `write_file` - å†™å…¥æ–‡ä»¶
- `delete_file` - åˆ é™¤æ–‡ä»¶
- `run_shell` - æ‰§è¡Œ Shell å‘½ä»¤
- `http_request` (POST/PUT/DELETE) - å†™æ“ä½œçš„ HTTP è¯·æ±‚
- `query_database` (é SELECT) - æ•°æ®åº“å†™æ“ä½œ

### 9.3 å‘½ä»¤é»‘åå•

```toml
blocked_commands = [
    "rm -rf /",
    "dd if=",
    "mkfs",
    ":(){ :|:& };:",   # Fork ç‚¸å¼¹
    "chmod 777",
    "curl * | bash",
    "wget * | bash",
]
```

---

## åã€æ‰©å±•æŒ‡å—

### 10.1 æ·»åŠ æ–°çš„ç¯å¢ƒæ¨¡æ¿

1. åœ¨ `config/environments/` åˆ›å»ºæ–°æ–‡ä»¶ï¼Œå¦‚ `rust-dev.toml`
2. å®šä¹‰ `[metadata]` åŒ…å« name, description, tags
3. è®¾ç½® `extends = ""` æˆ–ç»§æ‰¿å…¶ä»–æ¨¡æ¿
4. é…ç½®æ²™ç®±ã€Shell ç¯å¢ƒã€å·¥å…·

### 10.2 æ·»åŠ æ–°çš„å·¥å…·

1. åœ¨ `config/tools.toml` æ·»åŠ å·¥å…·å®šä¹‰
2. åœ¨ `tools/` ç›®å½•å®ç°å·¥å…·ç±»
3. ä½¿ç”¨ `@register_tool` è£…é¥°å™¨æ³¨å†Œ

### 10.3 æ·»åŠ æ–°çš„ MCP æœåŠ¡å™¨

1. åœ¨ `config/mcp.toml` æ·»åŠ æœåŠ¡å™¨é…ç½®
2. æˆ–åœ¨ Agent é…ç½®ä¸­æ·»åŠ  `[mcp.servers.xxx]`
3. æŒ‡å®š transport ç±»å‹å’Œè¿æ¥å‚æ•°

---

## åä¸€ã€FAQ

### Q: å¦‚ä½•åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°æ‰§è¡Œå™¨ï¼Ÿ

åˆ›å»º `config/environments/local-dev.toml`ï¼š

```toml
[metadata]
name = "local-dev"
description = "æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆä¸ä½¿ç”¨ Dockerï¼‰"

[sandbox]
mode = "local"  # ä½¿ç”¨æœ¬åœ°æ‰§è¡Œå™¨

[sandbox.security]
# æœ¬åœ°æ¨¡å¼ä¸‹è¿™äº›é…ç½®ä¸ç”Ÿæ•ˆï¼Œä½†å»ºè®®ä¿ç•™
read_only_root = false
```

### Q: å¦‚ä½•ä¸ºç‰¹å®š Agent æ·»åŠ è‡ªå®šä¹‰ MCP æœåŠ¡å™¨ï¼Ÿ

åœ¨ Agent é…ç½®ä¸­æ·»åŠ ï¼š

```toml
[mcp.servers.my_custom_server]
name = "My Custom Server"
url = "http://my-server:8080"
transport = "http"
enabled = true
api_key_env = "MY_SERVER_API_KEY"
```

### Q: å¦‚ä½•ä¸´æ—¶è¦†ç›–é…ç½®è¿›è¡Œæµ‹è¯•ï¼Ÿ

ä½¿ç”¨ API çš„ runtime_overrides å‚æ•°ï¼š

```python
config = loader.load_for_agent(
    "my-agent",
    runtime_overrides={
        "sandbox": {"timeout_seconds": 300},
        "shell": {"env": {"DEBUG": "1"}},
    }
)
```

---

<div align="center">

**Code-First Â· åˆ†å±‚è¦†ç›– Â· å®‰å…¨ä¼˜å…ˆ**

*æ–‡æ¡£ç‰ˆæœ¬: v1.0 | æœ€åæ›´æ–°: 2026-01-17*

</div>
