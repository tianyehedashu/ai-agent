# ==============================================================================
# AI Agent Backend - å¼€å‘å‘½ä»¤
# ==============================================================================
#
# ä½¿ç”¨æ–¹å¼:
#   make help        - æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤
#   make install     - å®‰è£…ä¾èµ–
#   make dev         - å¯åŠ¨å¼€å‘æœåŠ¡å™¨
#   make check       - è¿è¡Œæ‰€æœ‰æ£€æŸ¥
#   make test        - è¿è¡Œæµ‹è¯•
#
# ==============================================================================

.PHONY: help install dev test lint format typecheck security check clean

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# Python è§£é‡Šå™¨
PYTHON := python3

# ==============================================================================
# å¸®åŠ©
# ==============================================================================

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "AI Agent Backend - å¼€å‘å‘½ä»¤"
	@echo ""
	@echo "ä½¿ç”¨æ–¹å¼: make [target]"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

# ==============================================================================
# å®‰è£…ä¸åˆå§‹åŒ–
# ==============================================================================

install: ## å®‰è£…ç”Ÿäº§ä¾èµ–
	pip install -r requirements.txt

install-dev: ## å®‰è£…å¼€å‘ä¾èµ–
	pip install -r requirements.txt -r requirements-dev.txt
	pre-commit install
	pre-commit install --hook-type commit-msg

install-all: install-dev ## å®‰è£…æ‰€æœ‰ä¾èµ–å¹¶åˆå§‹åŒ–

# ==============================================================================
# å¼€å‘æœåŠ¡å™¨
# ==============================================================================

dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (å¸¦çƒ­é‡è½½)
	uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

dev-debug: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (è°ƒè¯•æ¨¡å¼)
	PYTHONDONTWRITEBYTECODE=1 uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 --log-level debug

# ==============================================================================
# ä»£ç è´¨é‡æ£€æŸ¥
# ==============================================================================

lint: ## è¿è¡Œä»£ç æ£€æŸ¥ (Ruff)
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	ruff check .

lint-fix: ## è¿è¡Œä»£ç æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤
	@echo "ğŸ”§ è¿è¡Œä»£ç æ£€æŸ¥å¹¶ä¿®å¤..."
	ruff check . --fix

format: ## æ ¼å¼åŒ–ä»£ç 
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	ruff format .

format-check: ## æ£€æŸ¥ä»£ç æ ¼å¼ (ä¸ä¿®æ”¹)
	@echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
	ruff format . --check

typecheck: ## è¿è¡Œç±»å‹æ£€æŸ¥ (Pyright)
	@echo "ğŸ”¬ è¿è¡Œç±»å‹æ£€æŸ¥..."
	pyright

typecheck-mypy: ## è¿è¡Œç±»å‹æ£€æŸ¥ (MyPy)
	@echo "ğŸ”¬ è¿è¡Œ MyPy ç±»å‹æ£€æŸ¥..."
	mypy .

security: ## è¿è¡Œå®‰å…¨æ£€æŸ¥ (Bandit)
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	bandit -c pyproject.toml -r . --exclude ./tests

# ç»„åˆæ£€æŸ¥å‘½ä»¤
check: format-check lint typecheck ## è¿è¡Œæ‰€æœ‰æ£€æŸ¥ (æ ¼å¼ + Lint + ç±»å‹)
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡!"

check-ci: ## CI ç¯å¢ƒæ£€æŸ¥ (ä¸¥æ ¼æ¨¡å¼)
	@echo "ğŸš€ è¿è¡Œ CI æ£€æŸ¥..."
	ruff format . --check
	ruff check .
	pyright
	bandit -c pyproject.toml -r . --exclude ./tests
	@echo "âœ… CI æ£€æŸ¥é€šè¿‡!"

fix: lint-fix format ## è‡ªåŠ¨ä¿®å¤æ‰€æœ‰é—®é¢˜
	@echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ!"

# ==============================================================================
# æµ‹è¯•
# ==============================================================================

test: ## è¿è¡Œæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	pytest

test-cov: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯• (å¸¦è¦†ç›–ç‡)..."
	pytest --cov --cov-report=html --cov-report=term-missing

test-unit: ## åªè¿è¡Œå•å…ƒæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest -m unit

test-integration: ## åªè¿è¡Œé›†æˆæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	pytest -m integration

test-watch: ## ç›‘è§†æ¨¡å¼è¿è¡Œæµ‹è¯•
	@echo "ğŸ‘€ ç›‘è§†æ¨¡å¼æµ‹è¯•..."
	ptw -- -v

# ==============================================================================
# æ•°æ®åº“
# ==============================================================================

db-migrate: ## åˆ›å»ºæ•°æ®åº“è¿ç§»
	@echo "ğŸ“¦ åˆ›å»ºæ•°æ®åº“è¿ç§»..."
	alembic revision --autogenerate -m "$(msg)"

db-upgrade: ## å‡çº§æ•°æ®åº“åˆ°æœ€æ–°
	@echo "â¬†ï¸  å‡çº§æ•°æ®åº“..."
	alembic upgrade head

db-downgrade: ## å›æ»šæ•°æ®åº“ä¸€ä¸ªç‰ˆæœ¬
	@echo "â¬‡ï¸  å›æ»šæ•°æ®åº“..."
	alembic downgrade -1

db-reset: ## é‡ç½®æ•°æ®åº“
	@echo "ğŸ—‘ï¸  é‡ç½®æ•°æ®åº“..."
	alembic downgrade base
	alembic upgrade head

# ==============================================================================
# æ–‡æ¡£
# ==============================================================================

docs: ## ç”Ÿæˆ API æ–‡æ¡£
	@echo "ğŸ“š ç”Ÿæˆæ–‡æ¡£..."
	mkdocs build

docs-serve: ## å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨
	@echo "ğŸ“š å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨..."
	mkdocs serve

# ==============================================================================
# æ¸…ç†
# ==============================================================================

clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ!"

clean-all: clean ## æ¸…ç†æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ (åŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒ)
	rm -rf .venv

# ==============================================================================
# Pre-commit
# ==============================================================================

pre-commit: ## æ‰‹åŠ¨è¿è¡Œ pre-commit æ£€æŸ¥
	pre-commit run --all-files

pre-commit-update: ## æ›´æ–° pre-commit hooks
	pre-commit autoupdate

# ==============================================================================
# Docker
# ==============================================================================

docker-build: ## æ„å»º Docker é•œåƒ
	docker build -t ai-agent-backend:dev .

docker-run: ## è¿è¡Œ Docker å®¹å™¨
	docker run -p 8000:8000 --env-file .env ai-agent-backend:dev

docker-compose-up: ## å¯åŠ¨æ‰€æœ‰æœåŠ¡ (docker-compose)
	docker-compose up -d

docker-compose-down: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	docker-compose down

# ==============================================================================
# SonarQube
# ==============================================================================

sonar: ## è¿è¡Œ SonarQube æ‰«æ (éœ€è¦è®¾ç½® SONAR_HOST_URL å’Œ SONAR_TOKEN)
	@echo "ğŸ” ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov --cov-report=xml:coverage.xml --junitxml=test-results.xml || true
	@echo "ğŸ” è¿è¡Œ SonarQube æ‰«æ..."
	sonar-scanner

sonar-report: ## ç”Ÿæˆ SonarQube æ‰€éœ€çš„æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
	pytest --cov --cov-report=xml:coverage.xml --junitxml=test-results.xml
