# conftest.py æ–‡ä»¶åˆ†æä¸æœ€ä½³å®è·µ

## ä¸€ã€conftest.py æ˜¯ä»€ä¹ˆï¼Ÿ

`conftest.py` æ˜¯ **pytest çš„é…ç½®æ–‡ä»¶**ï¼Œç”¨äºï¼š

1. **å…±äº« Fixturesï¼ˆæµ‹è¯•å¤¹å…·ï¼‰**ï¼šå®šä¹‰å¯å¤ç”¨çš„æµ‹è¯•æ•°æ®ã€æ•°æ®åº“ä¼šè¯ã€HTTP å®¢æˆ·ç«¯ç­‰
2. **Pytest é…ç½®é’©å­**ï¼šé…ç½®è­¦å‘Šè¿‡æ»¤ã€æ ‡è®°ã€æ’ä»¶ç­‰
3. **æµ‹è¯•åˆå§‹åŒ–**ï¼šåœ¨æµ‹è¯•è¿è¡Œå‰æ‰§è¡Œå¿…è¦çš„åˆå§‹åŒ–ï¼ˆå¦‚ JWT Managerã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰

## äºŒã€å½“å‰æ–‡ä»¶å†…å®¹åˆ†æ

### âœ… ä¸»è¦åŠŸèƒ½

```python
# 1. è­¦å‘Šè¿‡æ»¤å™¨é…ç½®ï¼ˆç¬¬ 16-56 è¡Œï¼‰
- æŠ‘åˆ¶ç¬¬ä¸‰æ–¹åº“ï¼ˆlitellmã€pydanticã€aiohttpï¼‰çš„è­¦å‘Š
- ä½¿ç”¨ pytest_configure é’©å­é…ç½®å…¨å±€è­¦å‘Šè¿‡æ»¤

# 2. åˆå§‹åŒ–é…ç½®ï¼ˆç¬¬ 59-67 è¡Œï¼‰
- åˆå§‹åŒ– JWT Managerï¼ˆè®¤è¯ç³»ç»Ÿï¼‰

# 3. æµ‹è¯•æ•°æ®åº“ Fixturesï¼ˆç¬¬ 69-184 è¡Œï¼‰
- TEST_DATABASE_URL: æµ‹è¯•æ•°æ®åº“ URL
- _ensure_test_database(): è‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®åº“
- _create_test_engine(): å»¶è¿Ÿåˆ›å»ºæ•°æ®åº“å¼•æ“

# 4. Pytest Fixturesï¼ˆç¬¬ 180-288 è¡Œï¼‰
- event_loop: äº‹ä»¶å¾ªç¯ fixture
- db_session: æ•°æ®åº“ä¼šè¯ fixtureï¼ˆæ¯ä¸ªæµ‹è¯•å‡½æ•°è‡ªåŠ¨åˆ›å»º/æ¸…ç†ï¼‰
- client: HTTP å®¢æˆ·ç«¯ fixtureï¼ˆFastAPI ASGI æµ‹è¯•å®¢æˆ·ç«¯ï¼‰
- test_user: æµ‹è¯•ç”¨æˆ· fixture
- auth_headers: è®¤è¯å¤´ fixture
```

### ğŸ“Š Fixtures ä½œç”¨åŸŸè¯´æ˜

| Fixture | Scope | è¯´æ˜ |
|---------|-------|------|
| `event_loop` | `session` | æ•´ä¸ªæµ‹è¯•ä¼šè¯å…±äº«ä¸€ä¸ªäº‹ä»¶å¾ªç¯ |
| `db_session` | `function` | æ¯ä¸ªæµ‹è¯•å‡½æ•°ç‹¬ç«‹æ•°æ®åº“ä¼šè¯ï¼ˆè‡ªåŠ¨å›æ»šï¼‰ |
| `client` | `function` | æ¯ä¸ªæµ‹è¯•å‡½æ•°ç‹¬ç«‹çš„ HTTP å®¢æˆ·ç«¯ |
| `test_user` | `function` | æ¯ä¸ªæµ‹è¯•å‡½æ•°åˆ›å»ºæ–°çš„æµ‹è¯•ç”¨æˆ· |
| `auth_headers` | `function` | åŸºäº test_user ç”Ÿæˆè®¤è¯å¤´ |

## ä¸‰ã€æ–‡ä»¶ä½ç½®è¯„ä¼°

### âœ… å½“å‰ä½ç½®ï¼š`backend/tests/conftest.py`

**ç¬¦åˆæœ€ä½³å®è·µ** âœ…

æ ¹æ® pytest æ–‡æ¡£å’Œé¡¹ç›®è§„èŒƒï¼ˆ`CODE_STANDARDS.md`ï¼‰ï¼Œ`conftest.py` åº”è¯¥æ”¾åœ¨ï¼š

1. **æµ‹è¯•æ ¹ç›®å½•** (`tests/`) - âœ… **å½“å‰ä½ç½®æ­£ç¡®**
   - ä½œç”¨èŒƒå›´ï¼šæ‰€æœ‰æµ‹è¯•ï¼ˆ`tests/` åŠå…¶å­ç›®å½•ï¼‰
   - åŒ…å«å…¨å±€ fixturesï¼ˆæ•°æ®åº“ã€HTTP å®¢æˆ·ç«¯ç­‰ï¼‰

2. **å­ç›®å½•ä¸­çš„ conftest.py**ï¼ˆå¯é€‰ï¼‰
   - ä¾‹å¦‚ï¼š`tests/integration/conftest.py`
   - ä½œç”¨èŒƒå›´ï¼šä»…è¯¥å­ç›®å½•åŠå…¶å­ç›®å½•
   - ç”¨äºç‰¹å®šæµ‹è¯•ç±»å‹çš„ fixtures

### ğŸ“ æ¨èçš„æµ‹è¯•ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ conftest.py              # âœ… å…¨å±€ fixturesï¼ˆå½“å‰ä½ç½®æ­£ç¡®ï¼‰
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ conftest.py          # å¯é€‰ï¼šå•å…ƒæµ‹è¯•ä¸“ç”¨ fixtures
â”‚   â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ conftest.py          # å¯é€‰ï¼šé›†æˆæµ‹è¯•ä¸“ç”¨ fixtures
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ test_llm_providers.py
â”œâ”€â”€ evaluation/              # è¯„ä¼°æµ‹è¯•
â”œâ”€â”€ fixtures/                # æµ‹è¯•æ•°æ®å·¥å‚
â”‚   â””â”€â”€ factories.py
â””â”€â”€ mocks/                   # Mock å·¥å…·
    â””â”€â”€ llm_mock.py
```

### âœ… å½“å‰ç»“æ„

æµ‹è¯•ç›®å½•ç»“æ„å·²æ•´ç†ï¼Œç¬¦åˆæœ€ä½³å®è·µï¼š

```
tests/
â”œâ”€â”€ conftest.py              # âœ… å…¨å±€ fixtures
â”œâ”€â”€ unit/                    # âœ… å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ services/           # âœ… æœåŠ¡å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ core/               # âœ… æ ¸å¿ƒé€»è¾‘å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ utils/              # âœ… å·¥å…·å‡½æ•°å•å…ƒæµ‹è¯•
â”œâ”€â”€ integration/            # âœ… é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ api/                # âœ… API é›†æˆæµ‹è¯•ï¼ˆåŒ…æ‹¬ test_health.pyï¼‰
â”œâ”€â”€ evaluation/             # âœ… è¯„ä¼°æµ‹è¯•
â”œâ”€â”€ fixtures/               # âœ… æµ‹è¯•æ•°æ®å·¥å‚
â””â”€â”€ mocks/                  # âœ… Mock å·¥å…·
```

**å·²å®Œæˆè°ƒæ•´**ï¼š
1. âœ… `tests/test_api/test_health.py` â†’ `tests/integration/api/test_health.py`
2. âœ… åˆ é™¤ç©ºçš„ `tests/test_services/` ç›®å½•ï¼ˆå·²æœ‰ `tests/unit/services/`ï¼‰

## å››ã€conftest.py æœ€ä½³å®è·µ

### âœ… å½“å‰å®ç°éµå¾ªçš„æœ€ä½³å®è·µ

1. **å…¨å±€é…ç½®é›†ä¸­ç®¡ç†** âœ…
   - è­¦å‘Šè¿‡æ»¤å™¨ç»Ÿä¸€é…ç½®
   - æ•°æ®åº“ URL ç»Ÿä¸€ç®¡ç†

2. **å»¶è¿Ÿå¯¼å…¥å’Œåˆ›å»º** âœ…
   - ä½¿ç”¨ `try-except ImportError` å¤„ç†å¯é€‰ä¾èµ–
   - æ•°æ®åº“å¼•æ“å»¶è¿Ÿåˆ›å»ºï¼ˆé¿å…å¯¼å…¥æ—¶è¿æ¥ï¼‰

3. **è‡ªåŠ¨æ¸…ç†** âœ…
   - `db_session` fixture è‡ªåŠ¨å›æ»š
   - æ¯ä¸ªæµ‹è¯•åè‡ªåŠ¨ drop_allï¼ˆä¿è¯éš”ç¦»ï¼‰

4. **ç±»å‹æ³¨è§£å®Œæ•´** âœ…
   - æ‰€æœ‰ fixtures éƒ½æœ‰ç±»å‹æ³¨è§£
   - ç¬¦åˆé¡¹ç›®ç±»å‹å®‰å…¨è¦æ±‚

### ğŸ’¡ å¯èƒ½çš„æ”¹è¿›å»ºè®®

1. **è€ƒè™‘æ‹†åˆ†å¤§æ–‡ä»¶**ï¼ˆå½“å‰ 289 è¡Œï¼‰
   ```python
   # å¯ä»¥è€ƒè™‘æ‹†åˆ†ä¸ºï¼š
   tests/
   â”œâ”€â”€ conftest.py              # æ ¸å¿ƒé…ç½®å’ŒåŸºç¡€ fixtures
   â”œâ”€â”€ fixtures/
   â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“ç›¸å…³ fixtures
   â”‚   â”œâ”€â”€ http.py              # HTTP å®¢æˆ·ç«¯ fixtures
   â”‚   â””â”€â”€ auth.py              # è®¤è¯ç›¸å…³ fixtures
   ```
   **ä½†å½“å‰è§„æ¨¡ï¼ˆ289 è¡Œï¼‰è¿˜å¯ä»¥æ¥å—**ï¼Œä¸æ‹†åˆ†ä¹Ÿå¯ä»¥ã€‚

2. **æ·»åŠ æ›´å¤šæ–‡æ¡£æ³¨é‡Š**
   - å½“å‰å·²æœ‰è‰¯å¥½æ³¨é‡Šï¼Œç»§ç»­ä¿æŒ

3. **è€ƒè™‘ä½¿ç”¨ pytest-asyncio çš„è‡ªåŠ¨æ¨¡å¼**
   - âœ… å·²åœ¨ `pyproject.toml` ä¸­é…ç½® `asyncio_mode = "auto"`

## äº”ã€æ€»ç»“

### âœ… å½“å‰ä½ç½®ç¬¦åˆæœ€ä½³å®è·µ

- **æ–‡ä»¶ä½ç½®**ï¼š`backend/tests/conftest.py` âœ… æ­£ç¡®
- **æ–‡ä»¶å†…å®¹**ï¼šç»„ç»‡æ¸…æ™°ï¼ŒåŠŸèƒ½å®Œæ•´ âœ…
- **ä»£ç è´¨é‡**ï¼šç±»å‹æ³¨è§£å®Œæ•´ï¼Œç¬¦åˆé¡¹ç›®è§„èŒƒ âœ…

### ğŸ“ å»ºè®®

1. **ä¿æŒå½“å‰ä½ç½®**ï¼š`backend/tests/conftest.py` æ— éœ€ç§»åŠ¨
2. **æ¸…ç†æµ‹è¯•ç›®å½•**ï¼šç»Ÿä¸€æµ‹è¯•æ–‡ä»¶åˆ°å¯¹åº”çš„å­ç›®å½•ï¼ˆunit/integrationï¼‰
3. **ä¿æŒå½“å‰å®ç°**ï¼šä»£ç è´¨é‡è‰¯å¥½ï¼Œéµå¾ª pytest æœ€ä½³å®è·µ

---

**å‚è€ƒ**ï¼š
- [Pytest Fixtures æ–‡æ¡£](https://docs.pytest.org/en/stable/how-to/fixtures.html)
- [Pytest conftest.py æ–‡æ¡£](https://docs.pytest.org/en/stable/reference/fixtures.html#conftest-py-sharing-fixtures-across-multiple-files)
- é¡¹ç›®è§„èŒƒï¼š`backend/docs/CODE_STANDARDS.md`
